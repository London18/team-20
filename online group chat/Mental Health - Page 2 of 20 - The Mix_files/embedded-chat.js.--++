(function(a,c){if(!Array.prototype.indexOf){Array.prototype.indexOf=function(e){var d=this.length>>>0,f=Number(arguments[1])||0;f=(f<0)?Math.ceil(f):Math.floor(f);if(f<0){f+=d}for(;f<d;f++){if(f in this&&this[f]===e){return f}}return -1}}var b=a.EmbeddedChat=a.EmbeddedChat||{};b.ERROR_FLAG="8x8EmbeddedChat";b.POPUP_WINDOW_NAME_PREFIX="8x8EmbeddedChatPopup";b.SHARED_ALIAS="/shared";b.CHAT_PATH="/CHAT";b.logLevel="debug";b.logList=["debug","info","warn","error"];b.DEFAULT_POPOUT_CONFIGURATION=false;b.logLevelIndex=b.logList.indexOf(b.logLevel);b.MIN_RETRY_INTERVAL=250;b.MAX_RETRY_INTERVAL=2000;b.CHAT_POPUP_INDICATION_UPDATE_INTERVAL=2000;b.RTL_CHAT_LANGUAGES={ar:true};b.windowProperties={width:"334px",height:{open:"330px"},left:"20px",right:"20px"};b.Sanitize=function(){};b.Sanitize.defaultDiacriticsRemovalMap=[{base:"A",letters:/[\u0041\u24B6\uFF21\u00C0\u00C1\u00C2\u1EA6\u1EA4\u1EAA\u1EA8\u00C3\u0100\u0102\u1EB0\u1EAE\u1EB4\u1EB2\u0226\u01E0\u00C4\u01DE\u1EA2\u00C5\u01FA\u01CD\u0200\u0202\u1EA0\u1EAC\u1EB6\u1E00\u0104\u023A\u2C6F]/g},{base:"AA",letters:/[\uA732]/g},{base:"AE",letters:/[\u00C6\u01FC\u01E2]/g},{base:"AO",letters:/[\uA734]/g},{base:"AU",letters:/[\uA736]/g},{base:"AV",letters:/[\uA738\uA73A]/g},{base:"AY",letters:/[\uA73C]/g},{base:"B",letters:/[\u0042\u24B7\uFF22\u1E02\u1E04\u1E06\u0243\u0182\u0181]/g},{base:"C",letters:/[\u0043\u24B8\uFF23\u0106\u0108\u010A\u010C\u00C7\u1E08\u0187\u023B\uA73E]/g},{base:"D",letters:/[\u0044\u24B9\uFF24\u1E0A\u010E\u1E0C\u1E10\u1E12\u1E0E\u0110\u018B\u018A\u0189\uA779]/g},{base:"DZ",letters:/[\u01F1\u01C4]/g},{base:"Dz",letters:/[\u01F2\u01C5]/g},{base:"E",letters:/[\u0045\u24BA\uFF25\u00C8\u00C9\u00CA\u1EC0\u1EBE\u1EC4\u1EC2\u1EBC\u0112\u1E14\u1E16\u0114\u0116\u00CB\u1EBA\u011A\u0204\u0206\u1EB8\u1EC6\u0228\u1E1C\u0118\u1E18\u1E1A\u0190\u018E]/g},{base:"F",letters:/[\u0046\u24BB\uFF26\u1E1E\u0191\uA77B]/g},{base:"G",letters:/[\u0047\u24BC\uFF27\u01F4\u011C\u1E20\u011E\u0120\u01E6\u0122\u01E4\u0193\uA7A0\uA77D\uA77E]/g},{base:"H",letters:/[\u0048\u24BD\uFF28\u0124\u1E22\u1E26\u021E\u1E24\u1E28\u1E2A\u0126\u2C67\u2C75\uA78D]/g},{base:"I",letters:/[\u0049\u24BE\uFF29\u00CC\u00CD\u00CE\u0128\u012A\u012C\u0130\u00CF\u1E2E\u1EC8\u01CF\u0208\u020A\u1ECA\u012E\u1E2C\u0197]/g},{base:"J",letters:/[\u004A\u24BF\uFF2A\u0134\u0248]/g},{base:"K",letters:/[\u004B\u24C0\uFF2B\u1E30\u01E8\u1E32\u0136\u1E34\u0198\u2C69\uA740\uA742\uA744\uA7A2]/g},{base:"L",letters:/[\u004C\u24C1\uFF2C\u013F\u0139\u013D\u1E36\u1E38\u013B\u1E3C\u1E3A\u0141\u023D\u2C62\u2C60\uA748\uA746\uA780]/g},{base:"LJ",letters:/[\u01C7]/g},{base:"Lj",letters:/[\u01C8]/g},{base:"M",letters:/[\u004D\u24C2\uFF2D\u1E3E\u1E40\u1E42\u2C6E\u019C]/g},{base:"N",letters:/[\u004E\u24C3\uFF2E\u01F8\u0143\u00D1\u1E44\u0147\u1E46\u0145\u1E4A\u1E48\u0220\u019D\uA790\uA7A4]/g},{base:"NJ",letters:/[\u01CA]/g},{base:"Nj",letters:/[\u01CB]/g},{base:"O",letters:/[\u004F\u24C4\uFF2F\u00D2\u00D3\u00D4\u1ED2\u1ED0\u1ED6\u1ED4\u00D5\u1E4C\u022C\u1E4E\u014C\u1E50\u1E52\u014E\u022E\u0230\u00D6\u022A\u1ECE\u0150\u01D1\u020C\u020E\u01A0\u1EDC\u1EDA\u1EE0\u1EDE\u1EE2\u1ECC\u1ED8\u01EA\u01EC\u00D8\u01FE\u0186\u019F\uA74A\uA74C]/g},{base:"OI",letters:/[\u01A2]/g},{base:"OO",letters:/[\uA74E]/g},{base:"OU",letters:/[\u0222]/g},{base:"P",letters:/[\u0050\u24C5\uFF30\u1E54\u1E56\u01A4\u2C63\uA750\uA752\uA754]/g},{base:"Q",letters:/[\u0051\u24C6\uFF31\uA756\uA758\u024A]/g},{base:"R",letters:/[\u0052\u24C7\uFF32\u0154\u1E58\u0158\u0210\u0212\u1E5A\u1E5C\u0156\u1E5E\u024C\u2C64\uA75A\uA7A6\uA782]/g},{base:"S",letters:/[\u0053\u24C8\uFF33\u1E9E\u015A\u1E64\u015C\u1E60\u0160\u1E66\u1E62\u1E68\u0218\u015E\u2C7E\uA7A8\uA784]/g},{base:"T",letters:/[\u0054\u24C9\uFF34\u1E6A\u0164\u1E6C\u021A\u0162\u1E70\u1E6E\u0166\u01AC\u01AE\u023E\uA786]/g},{base:"TZ",letters:/[\uA728]/g},{base:"U",letters:/[\u0055\u24CA\uFF35\u00D9\u00DA\u00DB\u0168\u1E78\u016A\u1E7A\u016C\u00DC\u01DB\u01D7\u01D5\u01D9\u1EE6\u016E\u0170\u01D3\u0214\u0216\u01AF\u1EEA\u1EE8\u1EEE\u1EEC\u1EF0\u1EE4\u1E72\u0172\u1E76\u1E74\u0244]/g},{base:"V",letters:/[\u0056\u24CB\uFF36\u1E7C\u1E7E\u01B2\uA75E\u0245]/g},{base:"VY",letters:/[\uA760]/g},{base:"W",letters:/[\u0057\u24CC\uFF37\u1E80\u1E82\u0174\u1E86\u1E84\u1E88\u2C72]/g},{base:"X",letters:/[\u0058\u24CD\uFF38\u1E8A\u1E8C]/g},{base:"Y",letters:/[\u0059\u24CE\uFF39\u1EF2\u00DD\u0176\u1EF8\u0232\u1E8E\u0178\u1EF6\u1EF4\u01B3\u024E\u1EFE]/g},{base:"Z",letters:/[\u005A\u24CF\uFF3A\u0179\u1E90\u017B\u017D\u1E92\u1E94\u01B5\u0224\u2C7F\u2C6B\uA762]/g},{base:"a",letters:/[\u0061\u24D0\uFF41\u1E9A\u00E0\u00E1\u00E2\u1EA7\u1EA5\u1EAB\u1EA9\u00E3\u0101\u0103\u1EB1\u1EAF\u1EB5\u1EB3\u0227\u01E1\u00E4\u01DF\u1EA3\u00E5\u01FB\u01CE\u0201\u0203\u1EA1\u1EAD\u1EB7\u1E01\u0105\u2C65\u0250]/g},{base:"aa",letters:/[\uA733]/g},{base:"ae",letters:/[\u00E6\u01FD\u01E3]/g},{base:"ao",letters:/[\uA735]/g},{base:"au",letters:/[\uA737]/g},{base:"av",letters:/[\uA739\uA73B]/g},{base:"ay",letters:/[\uA73D]/g},{base:"b",letters:/[\u0062\u24D1\uFF42\u1E03\u1E05\u1E07\u0180\u0183\u0253]/g},{base:"c",letters:/[\u0063\u24D2\uFF43\u0107\u0109\u010B\u010D\u00E7\u1E09\u0188\u023C\uA73F\u2184]/g},{base:"d",letters:/[\u0064\u24D3\uFF44\u1E0B\u010F\u1E0D\u1E11\u1E13\u1E0F\u0111\u018C\u0256\u0257\uA77A]/g},{base:"dz",letters:/[\u01F3\u01C6]/g},{base:"e",letters:/[\u0065\u24D4\uFF45\u00E8\u00E9\u00EA\u1EC1\u1EBF\u1EC5\u1EC3\u1EBD\u0113\u1E15\u1E17\u0115\u0117\u00EB\u1EBB\u011B\u0205\u0207\u1EB9\u1EC7\u0229\u1E1D\u0119\u1E19\u1E1B\u0247\u025B\u01DD]/g},{base:"f",letters:/[\u0066\u24D5\uFF46\u1E1F\u0192\uA77C]/g},{base:"g",letters:/[\u0067\u24D6\uFF47\u01F5\u011D\u1E21\u011F\u0121\u01E7\u0123\u01E5\u0260\uA7A1\u1D79\uA77F]/g},{base:"h",letters:/[\u0068\u24D7\uFF48\u0125\u1E23\u1E27\u021F\u1E25\u1E29\u1E2B\u1E96\u0127\u2C68\u2C76\u0265]/g},{base:"hv",letters:/[\u0195]/g},{base:"i",letters:/[\u0069\u24D8\uFF49\u00EC\u00ED\u00EE\u0129\u012B\u012D\u00EF\u1E2F\u1EC9\u01D0\u0209\u020B\u1ECB\u012F\u1E2D\u0268\u0131]/g},{base:"j",letters:/[\u006A\u24D9\uFF4A\u0135\u01F0\u0249]/g},{base:"k",letters:/[\u006B\u24DA\uFF4B\u1E31\u01E9\u1E33\u0137\u1E35\u0199\u2C6A\uA741\uA743\uA745\uA7A3]/g},{base:"l",letters:/[\u006C\u24DB\uFF4C\u0140\u013A\u013E\u1E37\u1E39\u013C\u1E3D\u1E3B\u017F\u0142\u019A\u026B\u2C61\uA749\uA781\uA747]/g},{base:"lj",letters:/[\u01C9]/g},{base:"m",letters:/[\u006D\u24DC\uFF4D\u1E3F\u1E41\u1E43\u0271\u026F]/g},{base:"n",letters:/[\u006E\u24DD\uFF4E\u01F9\u0144\u00F1\u1E45\u0148\u1E47\u0146\u1E4B\u1E49\u019E\u0272\u0149\uA791\uA7A5]/g},{base:"nj",letters:/[\u01CC]/g},{base:"o",letters:/[\u006F\u24DE\uFF4F\u00F2\u00F3\u00F4\u1ED3\u1ED1\u1ED7\u1ED5\u00F5\u1E4D\u022D\u1E4F\u014D\u1E51\u1E53\u014F\u022F\u0231\u00F6\u022B\u1ECF\u0151\u01D2\u020D\u020F\u01A1\u1EDD\u1EDB\u1EE1\u1EDF\u1EE3\u1ECD\u1ED9\u01EB\u01ED\u00F8\u01FF\u0254\uA74B\uA74D\u0275]/g},{base:"oi",letters:/[\u01A3]/g},{base:"ou",letters:/[\u0223]/g},{base:"oo",letters:/[\uA74F]/g},{base:"p",letters:/[\u0070\u24DF\uFF50\u1E55\u1E57\u01A5\u1D7D\uA751\uA753\uA755]/g},{base:"q",letters:/[\u0071\u24E0\uFF51\u024B\uA757\uA759]/g},{base:"r",letters:/[\u0072\u24E1\uFF52\u0155\u1E59\u0159\u0211\u0213\u1E5B\u1E5D\u0157\u1E5F\u024D\u027D\uA75B\uA7A7\uA783]/g},{base:"s",letters:/[\u0073\u24E2\uFF53\u00DF\u015B\u1E65\u015D\u1E61\u0161\u1E67\u1E63\u1E69\u0219\u015F\u023F\uA7A9\uA785\u1E9B]/g},{base:"t",letters:/[\u0074\u24E3\uFF54\u1E6B\u1E97\u0165\u1E6D\u021B\u0163\u1E71\u1E6F\u0167\u01AD\u0288\u2C66\uA787]/g},{base:"tz",letters:/[\uA729]/g},{base:"u",letters:/[\u0075\u24E4\uFF55\u00F9\u00FA\u00FB\u0169\u1E79\u016B\u1E7B\u016D\u00FC\u01DC\u01D8\u01D6\u01DA\u1EE7\u016F\u0171\u01D4\u0215\u0217\u01B0\u1EEB\u1EE9\u1EEF\u1EED\u1EF1\u1EE5\u1E73\u0173\u1E77\u1E75\u0289]/g},{base:"v",letters:/[\u0076\u24E5\uFF56\u1E7D\u1E7F\u028B\uA75F\u028C]/g},{base:"vy",letters:/[\uA761]/g},{base:"w",letters:/[\u0077\u24E6\uFF57\u1E81\u1E83\u0175\u1E87\u1E85\u1E98\u1E89\u2C73]/g},{base:"x",letters:/[\u0078\u24E7\uFF58\u1E8B\u1E8D]/g},{base:"y",letters:/[\u0079\u24E8\uFF59\u1EF3\u00FD\u0177\u1EF9\u0233\u1E8F\u00FF\u1EF7\u1E99\u1EF5\u01B4\u024F\u1EFF]/g},{base:"z",letters:/[\u007A\u24E9\uFF5A\u017A\u1E91\u017C\u017E\u1E93\u1E95\u01B6\u0225\u0240\u2C6C\uA763]/g}];b.Sanitize.removeDiacritics=function(f){for(var d=0,e=b.Sanitize.defaultDiacriticsRemovalMap.length;d<e;d++){f=f.replace(b.Sanitize.defaultDiacriticsRemovalMap[d].letters,b.Sanitize.defaultDiacriticsRemovalMap[d].base)}return f};b.bus=(function(){var d={};return{subscribe:function(f,g){if(!d[f]){d[f]={listeners:[]}}var e=d[f].listeners.push(g)-1;return{remove:function(){delete d[f].listeners[e]}}},publish:function(g,l){if(!d[g]||!d[g].listeners.length){return}var j=d[g].listeners;for(var h=0,f=j.length;h<f;h++){if(typeof j[h]==="function"){try{j[h](l)}catch(k){b.log("error",k.message)}}}}}})();b.state={open:{config:{name:"open"}},minimize:{config:{name:"minimize"}},button:{config:{name:"button"}},invitation:{config:{name:"invitation"}},preChat:{config:{name:"preChat"}},chatWindow:{config:{name:"chatWindow"}},postChat:{config:{name:"postChat"}},offChat:{config:{name:"offChat"}},skipQueue:{config:{name:"skipQueue"}},close:{config:{name:"close"}}};b.currentState=b.state.close;b.terminationCounter={_count:0,_maxCount:1,count:function(){return this._count++<this._maxCount},reset:function(){this._count=0}};b.proxiedMessageTimeout=10000;b.start=function(){b.log("debug","start");this.i18n.setup();c(window).on("unload",c.proxy(this.onUnloadHandler,this));this.checkPlatform().done(c.proxy(function(){this.configureMessage();this.communicationEstablished();if(this.isPopup()){this.configureChatPopup()}this.loadUIElements();this.disableProxy();this.customer.setup();this.coBrowsing.setup();this.loadExternalStylesheet();this.loadExternalBusHandlerScript();this.chatWindow.resetProxiedMessages();a.receiveMessageProxy=c.proxy(b.receiveMessageProxy,b);a.sendMessageProxy=c.proxy(b.sendMessageProxy,b);var e=this.i18n.requestSystemDictionary(true);var d=c.Deferred();this.loadButton().then(c.proxy(this.configureButton,this)).always(d.resolve);var f=c.Deferred();this.loadInvitation().then(c.proxy(this.configureInvitation,this)).always(f.resolve);c.when(e,d,f).always(c.proxy(this.loaded,this));this.createLegacyData()},this))};b.createLegacyData=function(f){var e="!)@(#*$&%^";var d=["med=C","cas=0","nam=","org=","sub=","cnt=0","cha="+this.getChannel(),"customerLanguage="+(f||"")];this.legacyData=d.join(e)};b.checkChatPopup=function(){if(this.isPopup()){this.updateChatPopupIndication()}else{if(this.isConfiguredAsPopup()){this.checkChatPopupIndication()}}};b.checkChatPopupIndication=function(){var e=+(new Date());var d=window.localStorage.getItem(this.getPopupWindowName());if(e-d<=b.CHAT_POPUP_INDICATION_UPDATE_INTERVAL){this.updatePopupWindowReference()}else{this.removeChatPopupIndication()}};b.updateChatPopupIndication=function(){window.localStorage.setItem(this.getPopupWindowName(),+(new Date()));setInterval(c.proxy(function(){window.localStorage.setItem(this.getPopupWindowName(),+(new Date()))},this),b.CHAT_POPUP_INDICATION_UPDATE_INTERVAL)};b.removeChatPopupIndication=function(){window.localStorage.removeItem(this.getPopupWindowName())};b.onUnloadHandler=function(){if(this.isPopup()){this.removeChatPopupIndication()}};b.communicationEstablished=function(){this.sendMessage("chat:communication:established",{isPopup:this.isPopup()})};b.checkPlatform=function(){var e="../../../CHAT/chat.php";var f=[];f.push("action=checkPlatform");f.push(["tenant",encodeURIComponent(this.getTenantBase64())].join("="));f.push(["channel",encodeURIComponent(this.getChannel())].join("="));f.push(["script",encodeURIComponent(this.getScript())].join("="));var g=e+"?"+f.join("&");var d=c.Deferred();c.get(g).done(c.proxy(function(j){if(j){var h=this.checkPlatformStatus(j.response);if(h=="ready"){b.callerIPAddress=j.response.data.callerIPAddress;b.tenant=j.response.data.tenant;b.tenantLanguageCode=j.response.data.tenantLanguageCode;b.i18n.setDefaultLanguage(b.tenantLanguageCode.split("_")[0]);b.tenantOEMPath=j.response.data.tenantOEMPath;b.acceptHTMLMessage=j.response.data.acceptHTMLMessage=="false"?false:true;d.resolve()}}},this)).fail(function(){d.reject()});return d.promise()};b.checkPlatformStatus=function(d){var e;if(d&&d.status!==undefined){e="ready";if(d.status==1){b.log("error",b.ERROR_FLAG,"Can't load - Internal Server error");e="error"}else{if(d.status==0){if(!d.data.tenantEnabled||!d.data.scriptEnabled){b.log("error",b.ERROR_FLAG,"Can't load - Internal Server error");e="error"}else{if(d.data.tenantEnabled==="no"){b.log("error",b.ERROR_FLAG,"Can't load - Tenant disabled");e="error"}else{if(d.data.scriptEnabled==="no"){b.log("error",b.ERROR_FLAG,"Can't load - Script disabled");e="error"}else{if(d.data.tenantEnabled==="yes"&&d.data.scriptEnabled==="yes"){if(d.data.platformInMaintenance){if(d.data.platformURLRedirect){b.log("info",b.ERROR_FLAG,"Platform in maintenance - Redirecting...");e="redirect"}else{b.log("error",b.ERROR_FLAG,"Can't load - Platform in maintenance");e="error"}}}}}}}}}return e};b.configureChatPopup=function(){c(document.body).addClass("is-popup");c(window).resize(c.proxy(function(){this.recalculateHeight();b.chatWindow.resizeLoading()},this))};b.loadUIElements=function(){this.state.invitation.$el=c(".js-invitation-container");this.state.preChat.$el=c(".js-pre-chat-container");this.state.chatWindow.$el=c(".js-chat-container");this.state.postChat.$el=c(".js-post-chat-container");this.state.offChat.$el=c(".js-offline-container");this.state.skipQueue.$el=c(".js-skip-queue-container")};b.processUINext=function(e){e=e||this.currentState.config;var f=this[e.name];f&&f.showLoading();this.processingNextStep=true;var d=this.getNextStep().done(c.proxy(this.processUIState,this)).fail(c.proxy(function(g){this.processingNextStep=false;b.log("error",g);f&&f.onError(g)},this)).always(c.proxy(function(){this.processingNextStep=false;f&&f.hideLoading()},this));return d.promise()};b.processUIState=function(e){var d=e.name;c(".js-container").hide();this.currentState=this.state[d];this.uiState[d].call(this);this.recalculateHeight()};b.uiState={};b.uiState.invitation=function(){var f=this.state.invitation.config.timeout;var d=this.state.invitation.config.customTrigger;var e=c.proxy(function(){if(this.canOpenChat("invitation")&&d==this.state.invitation.config.customTrigger){this.state.invitation.$el.show();this.sendMessage("chat:invitation:open");this.currentState=this.state.invitation}},b);if(f&&f!=="never"&&f!=="custom"&&!d){_.delay(e,f*1000);b.log("debug","invitation scheduled",f)}else{if(d&&f!=="never"&&d){_.delay(e,0);b.log("debug","custom invitation")}}};b.uiState.preChat=function(){this.state.preChat.$el.show();b.phase.setTitle(this.state.preChat.$el);this.sendMessage("chat:preChat:open");this.state.preChat.$el.find(".js-form-list").scrollTop(0)};b.uiState.chatWindow=function(){var d=this.state.chatWindow.config.skipQueue;this.state.skipQueue.config=this.state.offChat.config=d;this.state.chatWindow.$el.show();b.phase.setTitle(this.state.chatWindow.$el);this.sendMessage("chat:open");this.chatWindow.start()};b.uiState.postChat=function(){this.state.postChat.$el.show();b.phase.setTitle(this.state.postChat.$el);this.sendMessage("chat:postChat:open");this.state.postChat.$el.find(".js-form-list").scrollTop(0)};b.uiState.offChat=function(){this.state.offChat.$el.show();b.phase.setTitle(this.state.offChat.$el);this.sendMessage("chat:offline:open");this.state.offChat.$el.find(".js-form-list").scrollTop(0)};b.uiState.skipQueue=function(){this.state.skipQueue.$el.show();b.phase.setTitle(this.state.skipQueue.$el);this.sendMessage("chat:skipQueue:open");this.state.skipQueue.$el.find(".js-form-list").scrollTop(0)};b.uiState.close=function(){this.sendMessage("chat:close");c(".js-container").hide();if(this.isPopup()){window.close()}};b.uiState.minimized=function(){this.sendMessage("chat:minimize")};b.configureMessage=function(){if(!window.addEventListener){window.attachEvent("onmessage",this.receiveMessage)}else{window.addEventListener("message",this.receiveMessage)}};b.getReceiver=function(){var d;if(!this.isPopup()){d=window.parent}return d};b.receiveMessage=function(g){if(g.origin===b.getReceiverDomain()){var f;try{f=JSON.parse(g.data)}catch(d){return}if(b.isPopupOpen()){b.callAndRetryOnError(function(){b.sendMessageProxy(g.data)},"sendMessageProxy");b.processMessageRestricted(f)}else{b.processMessage(f)}}};b.processMessage=function(f,e){b.log("debug","message received",f);var d=f.topic,g=f.data;switch(d){case"button:click":this.onButtonClick();break;case"chat:change:height":this.recalculateHeight(g);break;case"customer:set-info":this.customer.setInfo(g);break;case"customer:reset-info":this.customer.resetInfo();break;case"chat:enable-proxy":this.enableProxy();break;case"chat:disable-proxy":this.disableProxy();break;case"chat:popup:open":this.onChatPopupOpen(g);break;case"chat:communication:ping":this.onChatCommunicationPing(g);break;case"chat:popup:position":this.onChatPopupPosition(g);break;case"chat:browser-info":this.onChatBrowserInfo(g);break;case"chat:trigger-invitation":this.onChatTriggerInvitation();break;case"chat:set-language":this.onChatSetLanguage(g);break;case"co-browsing:found":this.coBrowsing.onInstanceFound();break;case"co-browsing:connected":this.coBrowsing.onSessionConnected(g);break;case"co-browsing:disconnected":this.coBrowsing.onSessionDisconnected(g);break}};b.processMessageRestricted=function(e){b.log("debug","message received - restricted",e);var d=e.topic,f=e.data;switch(d){case"chat:popup:open":this.onChatPopupOpen(f);break;case"customer:info-sent":this.onCustomerInfoSent();break;case"customer:reset-info":this.customer.resetInfo();break;case"chat:open":case"chat:invitation:open":case"chat:preChat:open":case"chat:postChat:open":case"chat:offline:open":case"chat:skipQueue:open":case"chat:communication:restablished":this.onChatOpenOnChatPopup();break;case"chat:popup:position":this.onChatPopupPosition(f);break;case"chat:trigger-invitation":this.onChatTriggerInvitation();break}};b.onChatTriggerInvitation=function(){this.loadInvitation(true).then(c.proxy(this.configureInvitation,this)).then(c.proxy(this.processInvitation,this))};b.onChatSetLanguage=function(d){if(this.i18n.isLanguageValid(d)){this.i18n.setCustomerLanguage(d)}else{b.log("warn",'Chat language "'+d+'" is not valid and will be discarded')}};b.onChatPopupPosition=function(d){this.chatPopupPosition=d};b.onChatBrowserInfo=function(d){this.chatBrowserInfo=d};b.onCustomerInfoSent=function(){this.customer.resetInfo()};b.onChatOpenOnChatPopup=function(){b.processUIState(b.state.close.config)};b.onChatPopupOpen=function(d){if(!this.isPopup()){this.updatePopupWindowReference(d&&d.tryFocus);this.synchronizeToPopout();this.onChatOpenOnChatPopup()}};b.synchronizeToPopout=function(){this.customer.synchronizeInfo();this.i18n.synchronizeCustomerLanguage()};b.onChatCommunicationPing=function(d){this.communicationEstablished();if(d.restablishing){this.sendMessage("chat:communication:restablished")}};b.onEnableProxy=function(){this.enableProxy()};b.onDisableProxy=function(){this.disableProxy()};b.onSendCustomerMessage=function(d){this.chatWindow.sendProxiedMessage(d,"customer",c.proxy(this.chatWindow.sendMessage,this.chatWindow))};b.onSendAgentMessage=function(d){this.chatWindow.sendProxiedMessage(d,"agent",c.proxy(this.chatWindow.sendAgentMessage,this.chatWindow))};b.onSetSystemMessages=function(d){this.i18n.load(d,"custom")};b.enableProxy=function(){this._proxyEnabled=true};b.disableProxy=function(){this._proxyEnabled=false};b.isProxyEnabled=function(){return this._proxyEnabled};b.sendMessage=function(f,j,e){if(this.isPopup()){j=j||{};j.fromPopup=true}var g=JSON.stringify({topic:f,data:j});var h=this.getReceiver();if(h){var d=this.getReceiverDomain();h.postMessage(g,d)}if(this.isConfiguredAsPopup()&&!e||this.isPopup()){this.sendMessageThroughProxy(f,j)}};b.sendMessageThroughProxy=function(d,f){if(this.isConfiguredAsPopup()||this.isPopup()){var e=JSON.stringify({topic:d,data:f});this.callAndRetryOnError(function(){b.sendMessageProxy(e)},"sendMessageProxy")}};b.receiveMessageProxy=function(e){var d=JSON.parse(e);if(b.isPopup()){b.log("debug","Processing message from opener",d);b.processMessage(d)}else{b.log("debug","Sending message to embedding page",d);b.sendMessage(d.topic,d.data,true);b.processMessageRestricted(d)}};b.sendMessageProxy=function(d){if(b.isPopup()){b.log("debug","Sending message to opener",d);window.opener.receiveMessageProxy(d)}else{if(b.isPopupOpen()){b.log("debug","Sending message to popup",d);b.popupWindow.receiveMessageProxy(d)}}};b.getRetryInterval=function(e){if(b._currentRetryInterval){var d=e(b._currentRetryInterval);if(d<b.MAX_RETRY_INTERVAL){b._currentRetryInterval=d}else{b._currentRetryInterval=b.MAX_RETRY_INTERVAL}}else{b._currentRetryInterval=b.MIN_RETRY_INTERVAL}return b._currentRetryInterval};b.clearRetryInterval=function(){if(b._currentRetryInterval){b.log("debug","Cleared retry interval");b._currentRetryInterval=0}};b.callAndRetryOnError=function(f,d){try{f();b.clearRetryInterval()}catch(g){setTimeout(function(){b.callAndRetryOnError(f,d)},b.getRetryInterval(function(e){return e*2}));b.log("info","Retrying",d,"after",b._currentRetryInterval,"ms")}};b.checkLanguageAlignment=function(d){if(b.RTL_CHAT_LANGUAGES[d]){document.getElementsByTagName("html")[0].setAttribute("dir","rtl")}else{document.getElementsByTagName("html")[0].setAttribute("dir","ltr")}};b.requestNextStep=function(e){var d=c.Deferred();e=e||{};_.defaults(e,{script:this.getScript(),tenant:this.getTenantBase64(),step:this.currentState.config.name,langfrom:this.i18n.getDefaultLanguage(),langto:this.i18n.getCurrentLanguage()});b.checkLanguageAlignment(e.langto);c.get("../../../CHAT/chat.php?action=getNextStep",e).done(function(f){if(b.responseHasError(f)){d.reject(f.response.data.error)}else{if(f.response.status==0){d.resolve(f.response.data)}}}).fail(function(f,h,g){d.reject(g)});return d.promise()};b.getNextStep=function(){var d=c.Deferred();this.requestNextStep().done(c.proxy(function(e){this.state[e.name].config=e;this.loadFragment(e).done(d.resolve).fail(d.reject)},this)).fail(d.reject);return d.promise()};b.onButtonClick=function(){if(this.canOpenChat()&&!this.processingNextStep){this.terminationCounter.reset();var d=this.currentState;this.currentState=this.state.button;this.processUINext(this.state.invitation.config).done(c.proxy(function(){this.recalculateHeight()},this));this.currentState=d}};b.canOpenChat=function(e){var d=true;if(!_.contains(["close","minimize","invitation"],this.currentState.config.name)){d=false}else{if((e=="invitation"&&this.isPopup())||(e=="invitation"&&this.isPopupOpen())){d=false}else{if(e!="invitation"&&this.isConfiguredAsPopup()&&!this.isPopup()){d=false}}}return d};b.isClosed=function(){return"close"==this.currentState.config.name};b.isButton=function(d){return _.contains(["onlineButton","offlineButton"],d.name)};b.isPopup=function(){if(this.openAsPopup===undefined){this.openAsPopup=c.url().param("popup")=="true"}return this.openAsPopup};b.isConfiguredAsPopup=function(){return this.configuredAsPopup||false};b.loadFragment=function(f){var e=f.name,h=this.state[e],d=c.Deferred();if(f.uuid){var g=b.SHARED_ALIAS+b.CHAT_PATH+"/"+this.getTenantBase64()+"/"+f.uuid+"/index.html?_="+(new Date()).getTime();h.$el.load(g,c.proxy(function(k,m,j){if(m==="success"){this[e].init(h.$el,this);var l=h.$el.find("[data-language]").children().filter(":selected").val();if(l!=null){this.i18n.setCustomerLanguage(l)}this.i18n.translateFragment(h.$el).always(c.proxy(function(){d.resolve(f)},this))}else{d.reject(m)}},this))}else{d.reject()}return d.promise()};b.loaded=function(){b.log("debug","loaded");this.checkChatPopup();this.sendMessage("chat:loaded",{popup:this.isPopup()});if(this.isPopup()){if(this.isOriginFromButton()||this.isOriginFromInvitation()){this.onButtonClick()}}else{this.processInvitation()}};b.processInvitation=function(){if(this.canOpenChat("invitation")){var d=this.state.invitation.config;if(d.uuid){this.processUIState(d)}}};b.loadButton=function(){return this.requestNextStep({step:"initButton"})};b.loadExternalStylesheet=function(){var d=this.getStylesheetURL();if(!this.externalStylesheetLoaded&&typeof d==="string"){c("<link/>",{rel:"stylesheet",href:d}).appendTo("head");this.externalStylesheetLoaded=true;b.log("debug","External stylesheet loaded from",d)}};b.loadExternalBusHandlerScript=function(){var d=this.getBusHandlerURL();if(!this.busAlreadyConfigured&&d&&typeof d==="string"){c.getScript(d).done(function(e,f){b.log("debug","Bus Handler Script");b.busHandlerLoaded()}).fail(function(g,f,e){b.log("error","Failed to load Bus Handler Script")})}};b.busHandlerLoaded=function(){if(!this.busAlreadyConfigured){this.unsubscribeBusEvents();this.subscribeBusEvents();var d=window.__8x8Chat&&window.__8x8Chat.onInit;if(d&&typeof d==="function"){try{d(this.bus);this.busAlreadyConfigured=true}catch(f){b.log("error","Exception when calling the Bus Handler onInit",f)}}}};b.subscribed={};b.subscribeBusEvents=function(){this.subscribed.chatEnabledProxy=this.bus.subscribe("chat:enable-proxy",c.proxy(b.onEnableProxy,b));this.subscribed.chatDisabledProxy=this.bus.subscribe("chat:disable-proxy",c.proxy(b.onDisableProxy,b));this.subscribed.customerSendMessage=this.bus.subscribe("customer:send-message",c.proxy(b.onSendCustomerMessage,b));this.subscribed.agentSendMessage=this.bus.subscribe("agent:send-message",c.proxy(b.onSendAgentMessage,b));this.subscribed.setSystemMessages=this.bus.subscribe("chat:set-system-messages",c.proxy(b.onSetSystemMessages,b))};b.unsubscribeBusEvents=function(){this.subscribed.chatEnabledProxy&&this.subscribed.chatEnabledProxy.remove();this.subscribed.chatDisabledProxy&&this.subscribed.chatDisabledProxy.remove();this.subscribed.customerSendMessage&&this.subscribed.customerSendMessage.remove();this.subscribed.agentSendMessage&&this.subscribed.agentSendMessage.remove();this.subscribed.setSystemMessages&&this.subscribed.setSystemMessages.remove()};b.configureButton=function(f){var d=this.state.button.config,g=d!=null?d.uuid:null,e=f.uuid;this.configurePopup(f);if(e){if(e!==g){b.sendMessage("show:button",e)}}else{b.sendMessage("hide:button")}this.state.button.config=f;_.delay(c.proxy(function(){this.loadButton().done(c.proxy(this.configureButton,this))},this),300000);return c.Deferred().resolve().promise()};b.loadInvitation=function(e){var d=c.Deferred();this.requestNextStep({step:"initInvitation",customTrigger:e}).done(c.proxy(function(f){this.loadFragment(f).done(d.resolve).fail(d.reject)},this)).fail(d.reject);return d.promise()};b.configureInvitation=function(d){this.state.invitation.config=d;this.configurePopup(d);return c.Deferred().resolve().promise()};b.configurePopup=function(d){if(d&&d.configuredAsPopup){this.configuredAsPopup=!!d.configuredAsPopup}else{this.configuredAsPopup=b.DEFAULT_POPOUT_CONFIGURATION}this.sendMessage("chat:popup",{popup:this.configuredAsPopup})};b.getCurrentPhase=function(){return this[this.currentState.config.name]};b.getScript=function(){if(!this.scriptId){this.scriptId=c.url().param("uuid")}return this.scriptId};b.getStylesheetURL=function(){if(!this.stylesheetURL){this.stylesheetURL=c.url().param("stylesheetURL")||null}return this.stylesheetURL};b.getBusHandlerURL=function(){if(!this.busHandlerURL){this.busHandlerURL=c.url().param("busHandlerURL")||null}return this.busHandlerURL};b.getTenant=function(){return this.tenant};b.getTenantBase64=function(){if(!this.tenantBase64){this.tenantBase64=c.url().param("tenant")}return this.tenantBase64};b.getChannel=function(){if(!this.channel){this.channel=c.url().param("channel")}return this.channel};b.getPopupWindowName=function(){if(!this._popupWindowName){this._popupWindowName=(this.POPUP_WINDOW_NAME_PREFIX+"_"+this.getScript()).replace(/[^\w-_]/,"_")}return this._popupWindowName};b.getChatPopupPosition=function(){if(!this.chatPopupPosition){this.chatPopupPosition={left:10,top:10}}return this.chatPopupPosition};b.openChatPopup=function(){var f=parseInt(b.windowProperties.width,10);var k=parseInt(b.windowProperties.height.open,10);var d=this.getChatPopupPosition();var j="width="+f+"px,height="+k+"px,left="+d.left+"px,top="+d.top+"px,menubar=no,resizable=yes,scrollbars=yes,toolbar=no,status=no";if(!this.popupWindow||this.popupWindow.closed){this.popupWindow=window.open("",b.getPopupWindowName(),j,true);try{if(this.popupWindow&&this.popupWindow.location.pathname.indexOf("embedded-chat.html")==-1){var h=this.getEmbeddedChatURL(true);this.popupWindow.location=h}else{b.log("debug","Chat Popup already exists - not opening an additional one");this.sendMessageThroughProxy("chat:communication:ping",{restablishing:true})}this.popupWindow.opener=window;this.popupWindow.focus();this.synchronizeToPopout()}catch(g){b.log("error","Exception while trying to create the popup")}}else{this.popupWindow=window.open("",b.getPopupWindowName(),j,true);this.popupWindow.opener=window;this.sendMessageThroughProxy("chat:communication:ping",{restablishing:true});this.popupWindow.focus()}};b.updatePopupWindowReference=function(d){this.popupWindow=window.open("",b.getPopupWindowName());this.popupWindow.opener=window;if(this.popupWindow.location.href=="about:blank"){this.popupWindow.close();this.popupWindow=null}else{if(d){this.popupWindow.focus()}this.sendMessageThroughProxy("chat:communication:ping",{restablishing:true})}};b.isPopupOpen=function(){return this.popupWindow&&!this.popupWindow.closed};b.getEmbeddedChatURL=function(d){var e=window.location.protocol+"//"+window.location.host;var f=e+window.location.pathname+"?uuid="+encodeURIComponent(c.url().param("uuid"))+"&tenant="+encodeURIComponent(c.url().param("tenant"))+"&domain="+encodeURIComponent(e)+"&channel="+encodeURIComponent(c.url().param("channel"))+"&referrer="+encodeURIComponent(c.url().param("referrer"))+"&popup="+encodeURIComponent(d&&d.toString()||"false")+"&popuporigin=invitation";if(this.getBusHandlerURL()){f+="&busHandlerURL="+encodeURIComponent(this.getBusHandlerURL())}if(this.getStylesheetURL()){f+="&stylesheetURL="+encodeURIComponent(this.getStylesheetURL())}return f};b.getPopupOrigin=function(){if(!this.popupOrigin){this.popupOrigin=c.url().param("popuporigin")}return this.popupOrigin};b.isOriginFromButton=function(){return this.getPopupOrigin()=="button"};b.isOriginFromInvitation=function(){return this.getPopupOrigin()=="invitation"};b.getCallerIPAddress=function(){return this.callerIPAddress};b.getReceiverDomain=function(){if(!this.receiverDomain){this.receiverDomain=c.url().param("domain")}return this.receiverDomain};b.getReferrer=function(){if(!this.referrer){this.referrer=c.url().param("referrer")}return this.referrer};b.getChatGreeting=function(){var d=this.state.chatWindow.config.greeting;return d!=null?d:i18n.t("chatQueued")};b.getChatQueueId=function(){return this.state.chatWindow.config.queue};b.getLegacyData=function(){return this.legacyData};b.handleSkipQueueAction=function(){var d=this.state.skipQueue.config;b.chatWindow.endChat().done(function(){b.loadFragment(d).done(c.proxy(b.processUIState,b))},b)};b.phase={};b.phase.init=function(d,e){this.$el=d;this.parent=e;this.$el.find("[data-template]").each(function(){var g=c(this);var f=g.data("template");b.templates[f]=c.proxy(function(){var h=this.i18n.translateFragmentResources(c(g.html()));return h.html()},b)});this.parent.modernize(this.$el);this.$closeButton=this.$el.find(".js-close");this.$closeButton.click(c.proxy(this.closeClicked,this));this.$confirmCloseButton=this.$el.find("#confirm-close-btn");this.$cancelCloseButton=this.$el.find("#cancel-close-btn");this.postInit(d)};b.phase.setTitle=function(e){if(b.isPopup()){var d=e.find(".js-window_title").text();if(d){document.title=d}}};b.phase.postInit=function(){};b.phase.resetVisibility=function(){};b.phase.getLoadingConfig=function(){return{color:"#FFF",shadow:true}};b.phase.showLoading=function(){if(!this.loading&&this.$loading){var d=this.getLoadingConfig(),e=this.$loading.get(0);if(e){this.$loading.show();this.loadingSpinner=new Spinner(d).spin(e);this.disable();this.loading=true}}};b.phase.hideLoading=function(){if(this.loading){this.$loading&&this.$loading.hide();if(this.loadingSpinner){this.loadingSpinner.stop()}this.enable();this.loading=false}};b.phase.isLoading=function(){return this.loading};b.phase.toggle=function(d){};b.phase.disable=function(){this.toggle(false)};b.phase.enable=function(){this.toggle(true)};b.phase.isDisabled=function(){return this.disabled};b.phase.onError=function(d){this.close()};b.phase.onBeforeClose=function(){return c.Deferred().resolve().promise()};b.phase.tryDefaultTermination=function(){var d=c.Deferred(),e=c.proxy(this.hideLoading,this);if(b.terminationCounter.count()){this.showLoading();b.requestNextStep({step:"defaultTermination"}).done(c.proxy(function(f){if(this.isButton(f)){this.configureButton(f);e();d.resolve()}else{this.state[f.name].config=f;this.loadFragment(f).done(c.proxy(this.processUIState,this)).always(e,d.reject)}},b)).fail(e,d.resolve)}else{d.resolve()}return d.promise()};b.phase.close=function(){b.processUIState(b.state.close.config)};b.phase.closeClicked=function(d){b.preventDefault(d);var e;if(this.parent.isConfiguredAsPopup()){e=this.onBeforeClose().then(c.proxy(this.close,this))}else{e=this.onBeforeClose().then(c.proxy(this.tryDefaultTermination,this)).then(c.proxy(this.close,this))}return e};b.phase.showErrorMessage=function(d){this.$errorMessage.text(d).show();b.resetScroll()};b.phase.hideErrorMessage=function(){this.$errorMessage.empty().hide()};b.invitation=c.extend({},b.phase);b.invitation.postInit=function(d){this.$loading=this.$el.find(".js-invitation-loading");this.$submitButton=this.$el.find(".js-button_label");this.$submitButton.click(c.proxy(this.submitClicked,this))};b.invitation.toggle=function(d){var f=this.$submitButton,e=!d;f.prop("disabled",e);this.disabled=e};b.invitation.submitClicked=function(d){b.preventDefault(d);if(this.parent.isConfiguredAsPopup()){this.parent.openChatPopup();this.parent.onChatOpenOnChatPopup()}else{this.parent.processUINext().done(c.proxy(function(){this.parent.recalculateHeight()},this))}};b.form=c.extend({},b.phase);b.form.postInit=function(d){this.$loading=this.$el.find(".js-form-loading");this.$formFields=this.$el.find("input, textarea, select");this.$submitButton=this.$el.find(".js-submit_button");this.$submitButton.click(c.proxy(this.submitClicked,this));this.$errorMessage=this.$el.find(".js-error-message")};b.form.resetVisibility=function(){this.$el.find(".main").show();this.$el.find(".js-introduction").show();this.$el.find(".js-acknowledge-text").hide();this.$el.find(".js-error-server-unavailable").hide()};b.form.resetForm=function(){var d=this.$el.find("[name]");d.each(function(e,g){var f=c(g);if(f.attr("type")=="radio"){f.attr("checked",false)}else{f.val("")}})};b.form.toggle=function(e){var d=this.$formFields.add(this.$submitButton),f=!e;d.prop("disabled",f);this.disabled=f};b.form.close=function(){this.resetVisibility();this.resetForm();b.processUIState(b.state.close.config)};b.form.submitClicked=function(e){b.preventDefault(e);var f=this.retrieveData(),d=c.proxy(this.hideLoading,this);if(f&&f.length){this.showLoading();this.validateFormData(f).done(c.proxy(function(){this.submit(f).always(d)},this)).fail(d)}else{this.submit([]).always(d)}};b.form.submit=function(){};b.form.retrieveData=function(){var f=[];var d={};if(this.$el){var e=this.$el.find("[name]");e.each(c.proxy(function(k,m){var l=c(m);var n={};var j=l.attr("name");if(!d[j]){n.$el=l;n.required=!!l.data("required");n.crmField=l.data("essential");n.identifier=l.data("identifier");n.languageField=l.data("language");if(l.attr("type")=="radio"){var h=this.$el.find("[name='"+j+"']:checked");n.question=this.$el.find("[for='"+l.attr("name")+"']").text();n.answer=this.$el.find("[for='"+h.attr("id")+"']").text()}else{n.question=this.$el.find("[for='"+l.attr("id")+"']").text();n.answer=c.trim(l.val());if(!n.identifier&&!n.languageField){var g=b.Sanitize.removeDiacritics(n.question).trim().toLowerCase().replace(/['!¡@#$%¨&*()?¿:\[\]<>\/\\{}|~´`^]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-");n.identifier=g}}d[j]=true;f.push(n)}},this))}return f};b.form.validateFormData=function(e){this.clearErrors();var d=c.Deferred();if(this.checkRequiredError(e)){this.showRequiredFieldMessage();d.reject()}else{this.checkCRMFieldError(e,d)}return d.promise()};b.form.checkRequiredError=function(e){var d=false;_.each(e,function(g,f,h){if(g.required&&g.answer===""){this.setError(g.$el);d=true}},this);return d};b.form.isNumberValid=function(d){return !/^[0-9]*$/.test(d)};b.form.isEmailValid=function(l){var t=/^(.+)@(.+)$/;var r='\\(\\)><@,;:\\\\\\"\\.\\[\\]';var m="[^\\s"+r+"]";var f='("[^"]*")';var s=/^\[(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})\]$/;var d=m+"+";var q="("+d+"|"+f+")";var n=new RegExp("^"+q+"(\\."+q+")*$");var h=new RegExp("^"+d+"(\\."+d+")*$");var e=l.match(t);if(e==null){return true}var u=e[1];var v=e[2];for(i=0;i<u.length;i++){if(u.charCodeAt(i)>127){return true}}for(i=0;i<v.length;i++){if(v.charCodeAt(i)>127){return true}}if(u.match(n)==null){return true}var k=v.match(s);if(k!=null){for(i=1;i<=4;i++){if(k[i]>255){return true}}}else{var j=new RegExp("^"+d+"$");var g=v.split(".");var o=g.length;for(i=0;i<o;i++){if(g[i].search(j)==-1){return true}}var p=g[o-1];if(p.length<2){return true}if(o<2){return true}}return false};b.form.setError=function(f){var d=c(f);var e=d.attr("name");c(".js-error-image-"+e).css("display","inline-block")};b.form.showRequiredFieldMessage=function(){this.showErrorMessage(i18n.t("errorRequiredMessage"))};b.form.showCrmFieldInvalidMessage=function(){this.showErrorMessage(i18n.t("errorCrmFieldInvalidMessage"))};b.form.showCrmFieldInvalidNumber=function(){this.showErrorMessage(i18n.t("errorInvalidNumber"))};b.form.showCrmFieldInvalidEmail=function(){this.showErrorMessage(i18n.t("errorInvalidEmail"))};b.form.showMessageServerUnavailable=function(){this.$el.find(".main").hide();this.$el.find(".js-error-server-unavailable").show()};b.form.showAcknowledgeText=function(){var e=c.trim(c(".js-acknowledge-text").text()),d=c.Deferred();if(e.length!=0){this.$el.find(".main:visible").hide();this.$el.find(".js-introduction:visible").hide();this.$el.find(".js-acknowledge-text").show();d.resolve()}else{d.reject()}return d.promise()};b.form.clearErrors=function(){this.hideErrorMessage();var d=this.$el.find("[name]");c.each(d,function(g,h){var e=c(h);var f=e.attr("name");c(".js-error-image-"+f).css("display","none")})};b.preChat=c.extend({},b.form);b.preChat.submit=function(e){this.formData=e;var d=this.getLanguageField(e);if(d){i18n.setCustomerLanguage(d.answer)}return b.processUINext()};b.preChat.hasData=function(){return !!this.formData};b.preChat.resetData=function(){this.formData=null};b.preChat.getFormData=function(){return this.formData};b.preChat.getCRMField=function(d){return _.find(d,function(e){return !!e.crmField})};b.preChat.getLanguageField=function(d){return _.find(d,function(e){return !!e.languageField})};b.preChat.getExtraFields=function(d){return _.filter(d,function(e){return !e.crmField&&!e.languageField})};b.preChat.onError=function(d){this.showErrorMessage(i18n.t("errorGenericMessage"))};b.preChat.sendPromptCRMField=function(f,d){var e="../../../CHAT/chat_get_legacy_info.php";var g={channel:b.getChannel(),tenant:b.getTenantBase64(),field:f.crmField.crmField,value:f.crmField.answer};if(f.languageField){g.customerlanguage=f.languageField.answer}c.get(e,g).done(c.proxy(function(j,k,h){if(this.parent.responseHasError(j)){this.showMessageServerUnavailable()}else{if(j.response.status==0){if(!j.response.data.prompt){this.setError(f.crmField.$el);this.showCrmFieldInvalidMessage();d.reject()}else{b.legacyData=j.response.data.prompt;d.resolve()}}else{if(j.response.status==2){this.setError(f.crmField.$el);this.showCrmFieldInvalidMessage();d.reject()}}}},this)).fail(c.proxy(function(h,k,j){this.showMessageServerUnavailable();d.reject()},this))};b.preChat.checkCRMFieldError=function(f,d){var e=this.getCRMField(f);var h=this.getLanguageField(f);if(e&&e.crmField&&(e.required||e.answer)){if(e.crmField=="ticket_id"||e.crmField=="customer_id"){if(this.isNumberValid(e.answer)){this.setError(e.$el);this.showCrmFieldInvalidNumber();d.reject()}else{this.sendPromptCRMField({crmField:e,languageField:h},d)}}else{if(e.crmField=="email_id"){if(this.isEmailValid(e.answer)){this.setError(e.$el);this.showCrmFieldInvalidEmail();d.reject()}else{this.sendPromptCRMField({crmField:e,languageField:h},d)}}else{this.sendPromptCRMField({crmField:e,languageField:h},d)}}}else{var g="";if(h&&h.answer!=null){g=h.answer}this.parent.createLegacyData(g);d.resolve()}};b.postChat=c.extend({},b.form);b.postChat.submit=function(d){return c.Deferred().resolve().promise()};b.postChat.checkCRMFieldError=function(e,d){d.resolve()};b.offChat=c.extend({},b.form);b.offChat.submit=function(k){var l=this.getCRMFields(k);var f=this.getOtherFields(k);var j=[];if(b.preChat.hasData()){j=this.getPreChatFields(b.preChat.getFormData())}var g=this.getEmailMessage(l,f,j,b.customer.getInfoForEmail());var h={emailChannelId:this.getChannel(),plainEmail:this.getPlainEmail(),emailInfo:this.getEmailInfo(),from:l.emailAddress&&l.emailAddress.answer||"",subject:this.getSubject(l)||b.i18n.t("emptySubject")||"[ Customer message ] No subject",message:g,tenant:b.getTenant()};var e="../../../CHAT/send_email.php";var d=c.Deferred();c.post(e,h).done(c.proxy(function(n,o,m){if(this.parent.responseHasError(n)){this.showMessageServerUnavailable();d.resolve()}else{if(n.response.status==0){this.showAcknowledgeText().fail(c.proxy(this.close,this)).always(d.resolve);b.preChat.resetData()}}},this)).fail(c.proxy(function(m,o,n){this.showMessageServerUnavailable();d.reject()},this));b.customer.notifyInfoSent();return d.promise()};b.offChat.getSubject=function(d){return d.emailSubject&&d.emailSubject.answer||""};b.offChat.checkCRMFieldError=function(f,d){var g=this.getCRMFields(f);var e=g.emailAddress;if(e&&e.crmField){if(this.isEmailValid(e.answer)){this.setError(e.$el);this.showCrmFieldInvalidEmail();d.reject()}else{d.resolve()}}else{d.resolve()}};b.offChat.getChannel=function(){return b.state.offChat.config.channel};b.offChat.getEmailInfo=function(){return b.state.offChat.config.emailInfo};b.offChat.getPlainEmail=function(){return b.state.offChat.config.plainEmail};b.offChat.getCRMFields=function(d){var e={};e.emailAddress=_.find(d,function(f){return f.crmField=="email_address"});e.emailSubject=_.find(d,function(f){return f.crmField=="email_subject"});e.emailBody=_.find(d,function(f){return f.crmField=="email_body"});return e};b.offChat.getOtherFields=function(d){return _.filter(d,function(e){return !e.crmField})};b.offChat.getPreChatFields=function(d){return d};b.offChat.getEmailMessage=function(h,d,g,f){var e="\n\n";if(h.emailBody){e+=h.emailBody.answer}e+=this.formatEmailMessage(d,g,f);return e};b.offChat.formatEmailMessage=function(e,j,h){var g="",d=j&&j.length,f=e&&e.length,k=h&&h.length;if(d){g+="\n\n======== "+i18n.t("preChatFormData")+" ========\n"+this.formFieldsForEmailMessage(j)+"\n"}if(f||k){g+="\n\n======== "+i18n.t("offChatFormData")+" ========\n";if(f){g+=this.formFieldsForEmailMessage(e)+"\n"}if(f&&k){g+="\n"}if(k){g+=this.formFieldsForEmailMessage(h)+"\n"}}return g};b.offChat.formFieldsForEmailMessage=function(d){var e="";_.each(d,function(g,f,h){if(g.languageField){g.answer=g.answer.toUpperCase()}e+=g.question+"\n    "+g.answer+"\n\n"});return e};b.skipQueue=c.extend({},b.offChat);b.skipQueue.formatEmailMessage=function(e,j,h){var g="",d=j&&j.length,f=e&&e.length,k=h&&h.length;if(d){g+="\n\n======== "+i18n.t("preChatFormData")+" ========\n"+this.formFieldsForEmailMessage(j)+"\n"}if(f||k){g+="\n\n======== "+i18n.t("skipQueueFormData")+" ========\n";if(f){g+=this.formFieldsForEmailMessage(e)+"\n"}if(f&&k){g+="\n"}if(k){g+=this.formFieldsForEmailMessage(h)+"\n"}}return g};b.skipQueue.hasState=function(){var d=b.state.skipQueue.config;return d&&d.uuid};b.skipQueue.getSubject=function(e){var d=b.state.skipQueue.config.forcedEmail||"";if(e.emailSubject){d+=" "+e.emailSubject.answer}return d};b.chatWindow=c.extend({},b.phase);b.chatWindow.start=function(){this.startRTApi(b.getTenant());b.setupChatWindow();this.$loading=this.$el.find(".js-message-loading");this.resizeLoading();this.showLoading();c(".js-translation-header").hide();c(".js-language-label").text("")};b.chatWindow.resizeLoading=function(){if(this.$loading){this.$loading.height(this.$loading.parent().height());this.$loading.width(this.$loading.parent().width())}};b.chatWindow.postInit=function(d){this.$chatLog=c(".js-message-content");this.$chatLog.empty();c(window).on("beforeunload",c.proxy(this.onBeforeUnloadHandler,this));c(window).on("unload",c.proxy(this.onUnloadHandler,this));this.$messageField=c("#message-field");this.$messageField.on("keyup",c.proxy(this.keyUpHandler,this));this.$messageField.attr("maxlength",CONFIG.MAX_CHAT_MSG_LENGTH);this.$flagButton=this.$el.find(".js-flag");this.$saveButton=this.$el.find(".js-save-action");this.$saveButton.click(c.proxy(this.saveClicked,this));this.$clearButton=this.$el.find(".js-clear-action");this.$clearButton.click(c.proxy(this.clearClicked,this));this.$coBrowsingButton=this.$el.find(".js-co-browsing-action");this.$coBrowsingButton.click(c.proxy(this.coBrowsingClicked,this));this.updateCoBrowsingButton()};b.chatWindow.onBeforeClose=function(){return this.endChat()};b.chatWindow.submitClicked=function(e){b.preventDefault(e);var d=this.$messageField.val().replace(/\n/g," ").replace(/(^\s*)|(\s*$)/g,"");if(d.length>0){this.onCustomerMessageReceived({message:d})}this.$messageField.val("");this.$messageField.focus()};b.chatWindow.saveClicked=function(d){b.preventDefault(d);window.open("../html/chat-log.html");this.$flagButton.click()};b.chatWindow.getLog=function(){return c(".js-message-content")};b.chatWindow.getHtmlLog=function(){return this.getLog().html()};b.chatWindow.clearClicked=function(d){b.preventDefault(d);this.clearChatLog();this.$flagButton.click()};b.chatWindow.coBrowsingClicked=function(e){b.preventDefault(e);var f=b.chatWindow.getChatSession();if(f&&f.getInteraction().getStatus()!=="deleted"){var d=b.coBrowsing.hasSession()?"co-browsing:end":"co-browsing:start";b.sendMessage(d)}this.$flagButton.click()};b.chatWindow.updateCoBrowsingButton=function(){if(this.$coBrowsingButton){var d=b.coBrowsing.hasSession();this.$coBrowsingButton.toggleClass("active",d);var e=d?"coBrowsingEndButton":"coBrowsingStartButton";this.$coBrowsingButton.data("title",e);this.$coBrowsingButton.attr("title",b.i18n.t(e))}};b.chatWindow.createGreetingMessage=function(){var f=b.getChatGreeting();if(b.skipQueue.hasState()){if(f.indexOf("@skipQueue@")!==-1){var d=b.state.skipQueue.config,e=c("<a>").attr("href","#").attr("onclick","EmbeddedChat.handleSkipQueueAction();").text(d.emailPrompt).wrap("<div>").parent().html();f=f.replace("@skipQueue@",e);this.appendToChatLog(c("<div>").addClass("chat-info-msg").html(f))}else{this.appendLogMessage(f);this.addSkipQueueLink()}}else{this.appendLogMessage(f)}};b.chatWindow.startRTApi=function(f){var d="../../../AGUI/jabbind.php";var e=new XMLHttpRequest();if(window.XDomainRequest){d="../../../AGUI/jabbind2.php"}else{if(window.EventSource||e.withCredentials!==undefined){d="../../../AGUI/jabbind3.php"}}this.rtapi=new GuestRtapi(d);this.guest=this.rtapi.getGuest();this.rtapi.addEventHandler(EVENT_DISCONNECTED,c.proxy(this.disconnectedHandler,this));this.rtapi.addEventHandler(EVENT_RECONNECTED,c.proxy(this.reconnectedHandler,this));this.rtapi.addEventHandler(EVENT_INVALID_LOGIN,c.proxy(this.invalidLoginHandler,this));this.rtapi.addEventHandler(EVENT_LOGIN_COMPLETED,c.proxy(this.loginCompletedHandler,this));this.rtapi.addEventHandler(EVENT_AGENT_INFO,c.proxy(this.agentInfoHandler,this));this.rtapi.addEventHandler(EVENT_CHAT_STATUS_UPDATE,c.proxy(this.chatStatusUpdateHandler,this));this.rtapi.addEventHandler(EVENT_CHAT_INCOMING_MSG,c.proxy(this.onAgentMessageReceived,this));this.rtapi.addEventHandler(EVENT_CHAT_TYPING,c.proxy(this.chatTypingHandler,this));this.rtapi.addEventHandler(EVENT_CHAT_TRANSLATION_SERVICE_ERROR,c.proxy(this.translationServiceErrorHandler,this));this.rtapi.addEventHandler(EVENT_CHAT_TRANSLATION_STATUS_UPDATE,c.proxy(this.translationStatusUpdateHandler,this));this.rtapi.addEventHandler(EVENT_CO_BROWSING_INVITE,c.proxy(this.coBrowsingInviteHandler,this));this.rtapi.login("guest_AT_"+f,f+"1","","","",this.getBrowserInfo())};b.chatWindow.onCustomerMessageReceived=function(g){var e="customer",f=g.message,d={message:f,id:this.getNewProxiedMessageId()},h=c.proxy(this.sendMessage,this);if(b.isProxyEnabled()){this.addProxiedMessage(d,e,h)}else{h(f)}this.sendCustomerMessage(f);b.bus.publish("customer:message-received",d)};b.chatWindow.onAgentMessageReceived=function(g){var e="agent",f=g.message,d={message:f,id:this.getNewProxiedMessageId()},h=c.proxy(this.sendAgentMessage,this);if(b.isProxyEnabled()){this.addProxiedMessage(d,e,h)}else{h(f)}b.bus.publish("agent:message-received",d)};b.chatWindow.sendCustomerMessage=function(d){this.appendMessage(d,"outgoing",true);this.clearAgentTyping()};b.chatWindow.sendAgentMessage=function(g){var f=this.getAgentNickname()||i18n.t("agent");var e="<span class='chat-msg-sender'>"+f+"</span>";var d;if(b.acceptHTMLMessage){d=e+g}else{d=e+c("<div>").html(g).text()}this.appendMessage(d,"incoming",true,true);this.clearAgentTyping()};b.chatWindow.disconnectedHandler=function(){b.log("debug","disconnectedHandler");if(!this.disconnected){this.appendErrorMessage(i18n.t("chatDisconnected"));this.disconnected=true}this.disable()};b.chatWindow.reconnectedHandler=function(){b.log("debug","reconnectedHandler");if(this._disconnected){if(this.endChatSession()){this.disable()}}};b.chatWindow.invalidLoginHandler=function(){b.log("debug","invalidLoginHandler");var d=this.createMessage(i18n.t("errorInvalidLogin"),"error");this.replaceChatLog(d)};b.chatWindow.loginCompletedHandler=function(){b.log("debug","loginCompletedHandler");this.guest.requestAgentInfo()};b.chatWindow.agentInfoHandler=function(){b.log("debug","agentInfoHandler");if(!b.isClosed()){this.loadInteractionData();this.startChatSession()}else{b.log("debug","Chat window is closed - preventing chat session to start")}};b.chatWindow.chatStatusUpdateHandler=function(){var f=this.getChatSession();if(f){this.status=f.getInteraction().getStatus();this.agent=_.find(f.getParticipantList(),function(g){return g.type==="agent"});b.log("debug","chatStatusUpdateHandler","status",this.status);if(this.status=="queued"){this.disable();if(b.isClosed()){b.log("debug","Chat window is closed - ending the chat session");this.endChatSession()}else{this.hideLoading();if(!this.initialMessageDisplayed){this.clearChatLog();this.createGreetingMessage()}else{this.appendLogMessage(i18n.t("chatForwarded"))}}}else{if(this.status=="accepted"){var e=this.getAgentNickname();var d=e?"chatEstablishedName":"chatEstablishedAgentNew";this.sessionEstablished=true;this.enable();if(!this.initialMessageDisplayed){this.clearChatLog();this.initialMessageDisplayed=true;d=e?"chatEstablishedName":"chatEstablishedAgent"}this.appendLogMessage(i18n.t(d,{agent:e}));f.sendInformation(this.chatInfo);if(b.coBrowsing.hasSession()){f.coBrowsingSessionStarted(b.coBrowsing.getSessionInfo())}b.preChat.resetData();if(this.pendingMessages.length){_.each(this.pendingMessages,function(g){f.sendMessage(g)},this);this.pendingMessages=[]}}else{if(this.status=="deleted"){if(!f._initiatedEnd){if(this.translationServiceError){this.appendErrorMessage(i18n.t("sessionDisconnected"))}else{this.appendErrorMessage(i18n.t("agentDisconnected"))}}if(this.endChatSession()){this.disable()}}}}}};b.chatWindow.chatMessageHandler=function(){b.log("debug","chatMessageHandler");var d=this.getChatSession();if(d&&d.hasNewMessage()){this.replaceChatLog(d.getChatLog());d.newMessageHandled()}};b.chatWindow.chatTypingHandler=function(){b.log("debug","chatTypingHandler");var d=this.getChatSession();if(d&&d.hasNewActivity()){this.displayAgentTyping(d)}};b.chatWindow.translationStatusUpdateHandler=function(){var e=this.getChatSession();var d=false;if(e){d=e.isTranslationEnabled()}b.log("debug","translationStatusUpdateHandler","status",d?"enabled":"disabled")};b.chatWindow.translationServiceErrorHandler=function(){b.log("debug","translationServiceErrorHandler");this.translationServiceError=true;var d=this.getChatSession();if(d){this.displayTranslationServiceError()}};b.chatWindow.coBrowsingInviteHandler=function(){if(b.coBrowsing.hasInstance()){var d=b.templates["co-browsing-invite"];if(d){this.appendMessage(d(),"highlight",false,true)}}else{var e=this.getChatSession();if(e){e.coBrowsingInstanceNotFound()}b.log("warn","Co-browsing invite dropped due to instance not found")}};b.chatWindow.onBeforeUnloadHandler=function(e){e=e||window.event;var d;if(this.isChatQueuedOrEstablished()){d=i18n.t("endChatConfirmation");if(e){e.returnValue=d}}return d};b.chatWindow.onUnloadHandler=function(d){b.log("debug","onUnloadHandler");this.closeChatSession()};b.chatWindow.keyUpHandler=function(d){if(d.keyCode==13){b.preventDefault(d);this.submitClicked(d)}else{var e=this.getChatSession();if(e){e.sendActivity()}}};b.chatWindow.startChatSession=function(){var d=b.getChatQueueId();var e=b.getLegacyData();if(!d){b.log("error","Can't start chat - missing chat queue id")}else{if(!e){b.log("error","Can't start chat - missing legacy data")}else{this.createChatSession(d,e);this.pendingMessages=[];this.sessionEstablished=false;this.initialMessageDisplayed=false}}};b.chatWindow.createChatSession=function(d,e){this.guest.newChatSession(d,b.getReferrer(),e,this.extraChatInfo,b.getCallerIPAddress(),this.extraChatInfoID);b.customer.notifyInfoSent()};b.chatWindow.getChatSession=function(){return this.guest&&this.guest.getSessionsByType("chat")[0]};b.chatWindow.endChatSession=function(){var d=this.getChatSession();if(d){d.end({sync:true});this.rtapi.destroy();this.status="ended"}return d};b.chatWindow.getAgentNickname=function(){return this.agent&&this.agent.nickname};b.chatWindow.showCustomerLanguage=function(e){var d=i18n.getLanguageLabel(e);c(".js-translation-header").show();c(".js-language-label").text(d);this.parent.recalculateHeight()};b.chatWindow.loadInteractionData=function(){this.chatInfo=new Hash();this.extraChatInfo="";this.extraChatInfoID="";var h=i18n.getCustomerLanguage();if(h){this.showCustomerLanguage(h)}var f;if(b.preChat.hasData()){f=b.preChat.getFormData()}else{this.parent.createLegacyData(h)}this.chatInfo.set("__ip-address__",b.getCallerIPAddress());this.chatInfo.set("__referrer__",b.getReferrer());if(f){var d=b.preChat.getCRMField(f);if(d){this.chatInfo.set(d.question,d.answer);this.extraChatInfo+="["+d.question+"|"+d.answer+"]";this.extraChatInfoID+="["+d.identifier+"|"+d.answer+"]"}var e=b.preChat.getExtraFields(f);_.each(e,function(k,j,l){this.chatInfo.set(k.question,k.answer);this.extraChatInfo+="["+k.question+"|"+k.answer+"]";this.extraChatInfoID+="["+k.identifier+"|"+k.answer+"]"},this)}if(b.customer.hasInfo()){var g=b.customer.getInfo();_.each(g,function(k,j){this.chatInfo.set(j,""+k);this.extraChatInfo+="["+j+"|"+k+"]"},this)}};b.chatWindow.getBrowserInfo=function(){var f="";try{f="appCodeName="+navigator.appCodeName+", appName="+navigator.appName+", appMinorVersion="+navigator.appMinorVersion+", cpuClass="+navigator.cpuClass+", platform="+navigator.platform+", language="+navigator.language+", userAgent="+navigator.userAgent+", cookieEnabled="+navigator.cookieEnabled+", appVersion="+navigator.appVersion+", oscpu"+navigator.oscpu}catch(d){}return f};b.chatWindow.getLoadingConfig=function(){return null};b.chatWindow.hideLoading=function(){this.$loading.hide();if(this.loadingSpinner){this.loadingSpinner.stop()}this.loading=false};b.chatWindow.toggle=function(d){var e=!d;this.$messageField.prop("disabled",e);this.disabled=e};b.chatWindow.isChatQueuedOrEstablished=function(){return this.status==="queued"||this.status==="accepted"};b.chatWindow.sendMessage=function(d){var e=this.getChatSession();if(e){var f=false;if(d.length>CONFIG.MAX_CHAT_MSG_LENGTH){d=d.substring(0,CONFIG.MAX_CHAT_MSG_LENGTH);f=true}if(!this.sessionEstablished){this.appendPendingMessage(d)}else{e.sendMessage(d);if(f){this.appendErrorMessage(i18n.t("chatMsgTooLong"))}}}};b.chatWindow.getNewProxiedMessageId=function(){return this._proxiedMessagesCounter++};b.chatWindow.getProxiedMessage=function(f,e){var d=this._proxiedMessages[f.id];if(d&&d[e]){return d}return null};b.chatWindow.isProxiedMessage=function(f,e){var d=this.getProxiedMessage(f,e);return !!d};b.chatWindow.addProxiedMessage=function(f,e,g){var d={message:f.message,timeoutId:_.delay(_.bind(this.sendUnhandledProxiedMessage,this,f,e,g),b.proxiedMessageTimeout)};d[e]=true;return this._proxiedMessages[f.id]=d};b.chatWindow.removeProxiedMessage=function(f,e){var d=this.getProxiedMessage(f,e);if(d){window.clearTimeout(d.timeoutId);delete this._proxiedMessages[f.id]}return d};b.chatWindow.sendProxiedMessage=function(f,d,g){var e=f.message;if(!_.isObject(f)||f.message==null||f.id==null){return b.log("warn","Malformed message data",f)}if(this.removeProxiedMessage(f,d)){return g(f.message)}else{return b.log("warn","Proxied message data",f,"from sender",d,"not found")}};b.chatWindow.sendUnhandledProxiedMessage=function(f,e,g){var d=this.removeProxiedMessage(f,e);if(d){g(d.message)}};b.chatWindow.resetProxiedMessages=function(){this._proxiedMessages={};if(this._proxiedMessagesCounter==null){this._proxiedMessagesCounter=0}};b.chatWindow.endChat=function(e){var d=c.Deferred().done(c.proxy(function(){this.closeChatSession()},this));if(!this.isDisabled()&&!e){this.confirmEndChat(d)}else{d.resolve()}return d.promise()};b.chatWindow.confirmEndChat=function(d){var e=c.proxy(function(f){this.$el.toggleClass("js-closing",f);this.parent.recalculateHeight()},this);e(true);d.always(function(){e(false)});this.$confirmCloseButton.off("click").on("click",d.resolve);this.$cancelCloseButton.off("click").on("click",d.reject)};b.chatWindow.closeChatSession=function(){if(b.coBrowsing.hasSession()){b.sendMessage("co-browsing:end")}if(this.endChatSession()){if(this.status!="deleted"){this.appendLogMessage(i18n.t("chatEnded"))}this.disable()}};b.chatWindow.clearChatLog=function(){this.replaceChatLog("");var d=this.getChatSession();if(d){d.clearChatLog()}};b.chatWindow.addSkipQueueLink=function(){var d=b.state.skipQueue.config,e=this.appendLinkMessage(d.emailPrompt,"link");e.click(c.proxy(function(){this.endChat().done(c.proxy(function(){this.showLoading();b.loadFragment(d).done(c.proxy(b.processUIState,b)).always(c.proxy(this.hideLoading,this))},this))},this))};b.chatWindow.displayAgentTyping=function(f){if(!this.$agentTyping){var e=this.getAgentNickname();var d=e?"agentTypingName":"agentTyping";this.$agentTyping=this.appendLogMessage(i18n.t(d,{agent:e}),true)}f.newActivityHandled();if(this.agentTypeDelay){clearTimeout(this.agentTypeDelay)}this.agentTypeDelay=_.delay(c.proxy(function(){var g=this.getChatSession();if(g&&!g.hasNewActivity()){this.clearAgentTyping()}},this),5000)};b.chatWindow.clearAgentTyping=function(){if(this.agentTypeDelay){clearTimeout(this.agentTypeDelay);this.agentTypeDelay=null}if(this.$agentTyping){this.$agentTyping.remove();this.$agentTyping=null}};b.chatWindow.displayTranslationServiceError=function(){this.appendErrorMessage(i18n.t("chatTranslationServiceError"))};b.chatWindow.createMessage=function(e,g,f){var d=c("<div>").addClass("chat-"+g+"-msg");if(f){d.html(e)}else{d.text(e)}return d};b.chatWindow.appendMessage=function(f,h,e,g){var d=this.createMessage(f,h,g);return this.appendToChatLog(d,e)};b.chatWindow.appendLinkMessage=function(f,g,e){var d=c("<div>").addClass("chat-"+g+"-msg").append(c("<a href='#'>").text(f));return this.appendToChatLog(d,e)};b.chatWindow.appendInfoMessage=function(e,d){return this.appendMessage(e,"info",d)};b.chatWindow.appendLogMessage=function(e,d){return this.appendMessage(e,"log",d)};b.chatWindow.appendHighlightMessage=function(e,d){return this.appendMessage(e,"highlight",d,true)};b.chatWindow.appendErrorMessage=function(e,d){return this.appendMessage(e,"error",d)};b.chatWindow.appendPendingMessage=function(d){this.pendingMessages.push(d);return this.appendMessage(d,"outgoing",true)};b.chatWindow.appendToChatLog=function(d,e){if(this.$chatLog){d.appendTo(this.$chatLog);this.$chatLog.parent().animate({scrollTop:this.$chatLog.height()},"fast");if(!e){var f=this.getChatSession();if(f){f.appendToChatLog(d.wrap("<div />").parent().html());d.unwrap()}}}return d};b.chatWindow.replaceChatLog=function(d){this.$chatLog.html(d).parent().animate({scrollTop:this.$chatLog.height()},"fast")};b.customer={};b.customer.setup=function(){this.resetInfo()};b.customer.hasInfo=function(){return !_.isEmpty(this._info)};b.customer.getInfo=function(){return this._info};b.customer.getInfoForEmail=function(){return _.map(this._info,function(e,d){return{question:d,answer:e}})};b.customer.setInfo=function(d){_.each(d,function(f,e){if(f==null){delete this._info[e]}else{if(_.isObject(f)){b.log("warn",'Customer info "'+e+'" is not of a primitive type and will be discarded')}else{if(String(e).length>100){b.log("warn",'Customer info "'+e+'" key is too big and will be discarded')}else{if(String(f).length>500){b.log("warn",'Customer info "'+e+'" value is too big and will be discarded')}else{this._info[e]=f}}}}},this)};b.customer.resetInfo=function(){this._info={}};b.customer.notifyInfoSent=function(){b.sendMessage("customer:info-sent",{info:b.customer.getInfo(),phase:b.currentState.config.name})};b.customer.synchronizeInfo=function(){b.log("debug","Customer info - synchronizing");b.sendMessageThroughProxy("customer:set-info",this._info)};a.i18n=b.i18n={};b.i18n.languageList={en:"English",ru:"Русский",de:"Deutsch",ja:"日本語",es:"Español",fr:"Français",pt:"Português",it:"Italiano",pl:"Polski",hr:"Hrvatski",nl:"Dutch",ar:"العربية",da:"Dansk",ko:"한국",no:"Norsk",sv:"Svenska",vi:"Tiếng Việt",cy:"Cymraeg",th:"ไทย","zh-CN":"简体中文","zh-TW":"中國傳統"};b.i18n.stringList={keys:["endChatButton","closeChatButton","errorServerUnavailable","chatEstablished","chatEstablishedName","chatEstablishedAgent","chatEstablishedAgentNew","chatQueued","chatForwarded","chatMsgTooLong","chatDisconnected","chatEnded","agent","agentTyping","agentTypingName","agentDisconnected","errorInvalidLogin","endChatNotification","endChatConfirmation","chatLogTitle","chatLogDescription","yesButton","noButton","coBrowsingStartButton","coBrowsingEndButton","saveButton","clearButton","pullDownInfo","errorGenericMessage","errorRequiredMessage","errorCrmFieldInvalidMessage","errorInvalidNumber","errorInvalidEmail","preChatFormData","offChatFormData","skipQueueFormData","chatTranslationOn","chatTranslationOff","chatTranslationServiceError","coBrowsingInvitePrompt","coBrowsingInviteAccept","coBrowsingInviteReject","coBrowsingInviteAccepted","coBrowsingInviteRejected","coBrowsingSessionStarted","coBrowsingSessionEnded","coBrowsingSessionRestored","sessionDisconnected","emptySubject"],excludeTranslation:{preChatFormData:true,offChatFormData:true,skipQueueFormData:true}};b.i18n.placeholderRegex=/\{\{(.+?)\}\}/g;b.i18n.setup=function(){this.reset()};b.i18n.reset=function(){this.dictionary={}};b.i18n.load=function(f,e){var d=this.getLangDictionary(e);_.each(f,function(h,g){if(h==null){delete d[g]}else{if(_.isObject(h)){b.log("warn",'Dictionary entry "'+g+'" is not of a primitive type and will be discarded')}else{d[g]=f[g]}}},this);this.setLangDictionary(d,e)};b.i18n.getLangDictionary=function(d){return this.dictionary[d]||{}};b.i18n.setLangDictionary=function(e,d){this.dictionary[d]=e};b.i18n.isTranslationNeeded=function(){var g=this.getDefaultLanguage();var f=this.getLangDictionary(g);var e=this.getCurrentLanguage();var d=this.getLangDictionary(e);return _.keys(f).length!=_.keys(d).length};b.i18n.setDefaultLanguage=function(d){this.defaultLanguage=d};b.i18n.getDefaultLanguage=function(){return this.defaultLanguage};b.i18n.setCustomerLanguage=function(d){this.customerLanguage=d||null};b.i18n.getCustomerLanguage=function(){return this.customerLanguage};b.i18n.getCurrentLanguage=function(){return this.getCustomerLanguage()||this.getDefaultLanguage()};b.i18n.isLanguageValid=function(d){return !!this.languageList[d]};b.i18n.getLanguageLabel=function(d){return this.languageList[d]||""};b.i18n.synchronizeCustomerLanguage=function(){var d=this.getCustomerLanguage();if(d){b.sendMessageThroughProxy("chat:set-language",d)}};b.i18n.translateFragment=function(e){var d=c.proxy(this.translateFragmentResources,this,e);return this.requestSystemDictionary().always(d)};b.i18n.translateFragmentResources=function(d){this.translateFragmentStrings(d);this.translateFragmentTitles(d);return d};b.i18n.translateFragmentStrings=function(d){return d.find("[data-string]").each(c.proxy(function(g,h){var f=c(h);var e=f.data("string");f.text(this.t(e))},this))};b.i18n.translateFragmentTitles=function(d){return d.find("[data-title]").each(c.proxy(function(g,h){var f=c(h);var e=f.data("title");f.attr("title",this.t(e))},this))};b.i18n.requestSystemDictionary=function(f){var d=c.Deferred();if(f||this.isTranslationNeeded()){var e={script:b.getScript(),tenant:b.getTenantBase64(),tenantOEMPath:b.tenantOEMPath,dictionary:this.getSystemDictionaryKeys(f),langto:this.getCurrentLanguage()};b.checkLanguageAlignment(e.langto);c.get("../../../CHAT/chat.php?action=translateSystemMessages",e).done(c.proxy(function(g){if(!b.responseHasError(g)){this.load(g.response.data.dictionary,g.response.data.lang);d.resolve()}else{d.reject()}},this)).fail(function(){d.reject()})}else{d.resolve()}return d.promise()};b.i18n.getSystemDictionaryKeys=function(d){var e=b.i18n.stringList;if(d){return e.keys}return _.filter(e.keys,function(f){return !e.excludeTranslation[f]})};b.i18n.t=function(g,f){f=f||{};var h=this.getLangDictionary("custom");var d=this.getLangDictionary(this.getCurrentLanguage());var j=this.getLangDictionary(this.getDefaultLanguage());var e=h[g]||d[g]||j[g]||"";return e.replace(this.placeholderRegex,function(l,k){return f[k]||l})};a.templates=b.templates={};a.coBrowsing=b.coBrowsing={};b.coBrowsing.setup=function(){this.reset();function e(g){return c(g.target).closest(".js-co-browsing-invite-actions")}function f(g){this.coBrowsing.acceptInvite();e(g).text(this.i18n.t("coBrowsingInviteAccepted"))}function d(g){this.coBrowsing.rejectInvite();e(g).text(this.i18n.t("coBrowsingInviteRejected"))}c(document).on("click",".js-co-browsing-invite-accept",c.proxy(f,b)).on("click",".js-co-browsing-invite-reject",c.proxy(d,b))};b.coBrowsing.reset=function(){this._instanceFound=false;this._sessionId=null;this._lastSessionId=null;this._stickyHash=null};b.coBrowsing.getSessionId=function(){return this._sessionId};b.coBrowsing.getLastSessionId=function(){return this._lastSessionId};b.coBrowsing.getStickyHash=function(){return this._stickyHash};b.coBrowsing.getSessionInfo=function(){return{sessionId:this._sessionId,stickyHash:this._stickyHash}};b.coBrowsing.setSessionId=function(d){this._sessionId=this._lastSessionId=d};b.coBrowsing.setStickyHash=function(d){this._stickyHash=d};b.coBrowsing.resetSession=function(){this._sessionId=null;this._stickyHash=null};b.coBrowsing.hasSession=function(){return this._sessionId!=null};b.coBrowsing.isNewSession=function(d){return this._lastSessionId!==d};b.coBrowsing.acceptInvite=function(){if(!this.hasSession()){var d=b.chatWindow.getChatSession();if(d&&d.getInteraction().getStatus()==="accepted"){b.sendMessage("co-browsing:start");d.coBrowsingInviteAccepted()}}};b.coBrowsing.rejectInvite=function(){if(!this.hasSession()){var d=b.chatWindow.getChatSession();if(d&&d.getInteraction().getStatus()==="accepted"){d.coBrowsingInviteRejected()}}};b.coBrowsing.onInstanceFound=function(){this._instanceFound=true};b.coBrowsing.hasInstance=function(){return this._instanceFound};b.coBrowsing.onSessionConnected=function(f){var g=b.chatWindow.getChatSession();var d=this.isNewSession(f.sessionId);var e=b.i18n.t(d?"coBrowsingSessionStarted":"coBrowsingSessionRestored");this.setSessionId(f.sessionId);this.setStickyHash(f.stickyHash);if(g&&g.getInteraction().getStatus()==="accepted"){g.coBrowsingSessionStarted(this.getSessionInfo())}b.chatWindow.appendHighlightMessage("<p>"+e+"</p>",false);b.chatWindow.updateCoBrowsingButton()};b.coBrowsing.onSessionDisconnected=function(){var d=b.chatWindow.getChatSession();if(d&&d.getInteraction().getStatus()==="accepted"){d.coBrowsingSessionEnded()}this.resetSession();b.chatWindow.appendHighlightMessage("<p>"+b.i18n.t("coBrowsingSessionEnded")+"</p>",false);b.chatWindow.updateCoBrowsingButton()};b.responseHasError=function(d){return !d||!d.response||d.response.status==1};b.preventDefault=function(d){if(d.preventDefault){d.preventDefault()}else{d.returnValue=false}};b.log=function(f){if(window.console&&b.logList.indexOf(f)>=b.logLevelIndex){try{window.console[f].apply(console,[b.ERROR_FLAG].concat(Array.apply(null,arguments).slice(1)))}catch(d){}}}})(this,jQuery);