function getDomDocumentPrefix(){if(getDomDocumentPrefix.prefix){return getDomDocumentPrefix.prefix}var c=["MSXML2","Microsoft","MSXML","MSXML3"];var d;for(var b=0;b<c.length;b++){try{d=new ActiveXObject(c[b]+".DomDocument");return getDomDocumentPrefix.prefix=c[b]}catch(a){}}throw new Error("Could not find an installed XML parser")}function XmlDocument(){}XmlDocument.create=function(){try{if(document.implementation&&document.implementation.createDocument){var b=document.implementation.createDocument("","",null);return b}if(window.ActiveXObject){return new ActiveXObject(getDomDocumentPrefix()+".DomDocument")}if(typeof(CtlHttpRequest)!="undefined"){domImp=new DOMImplementation();return new DOMDocument(domImp)}}catch(a){}throw new Error("Your browser does not support XmlDocument objects")};function JSJaCPacket(a){this.name=a;this.doc=XmlDocument.create();this.doc.appendChild(this.doc.createElement(a));this.pType=function(){return this.name};this.getDoc=function(){return this.doc};this.getNode=function(){return this.getDoc().firstChild};this.setTo=function(b){if(!b||b==""){this.getNode().removeAttribute("to")}else{this.getNode().setAttribute("to",b)}return this};this.setFrom=function(b){if(!b||b==""){this.getNode().removeAttribute("from")}else{this.getNode().setAttribute("from",b)}return this};this.setID=function(b){if(!b||b==""){this.getNode().removeAttribute("id")}else{this.getNode().setAttribute("id",b)}return this};this.setType=function(b){if(!b||b==""){this.getNode().removeAttribute("type")}else{this.getNode().setAttribute("type",b)}return this};this.setXMLLang=function(b){if(!b||b==""){this.getNode().removeAttribute("xml:lang")}else{this.getNode().setAttribute("xml:lang",b)}return this};this.setXMLNS=function(b){if(!b||b==""){this.getNode().removeAttribute("xmlns")}else{this.getNode().setAttribute("xmlns",b)}return this};this.getTo=function(){return this.getNode().getAttribute("to")};this.getFrom=function(){return this.getNode().getAttribute("from")};this.getID=function(){return this.getNode().getAttribute("id")};this.getType=function(){return this.getNode().getAttribute("type")};this.getXMLLang=function(){return this.getNode().getAttribute("xml:lang")};this.getXMLNS=function(){return this.getNode().getAttribute("xmlns",xmlns)};this.xml=function(){if(typeof(CtlHttpRequest)!="undefined"){return this.getDoc().toString()}else{return this.getDoc().xml?this.getDoc().xml:(new XMLSerializer()).serializeToString(this.doc)}};this._childElVal=function(c){for(var b=0;b<this.getNode().childNodes.length;b++){if(this.getNode().childNodes.item(b).nodeName==c){if(this.getNode().childNodes.item(b).firstChild){return this.getNode().childNodes.item(b).firstChild.nodeValue}else{return""}}}return null};this._replaceNode=function(b){if(this.getDoc().importNode){this.getDoc().importNode(b,true)}return this.getDoc().replaceChild(b.cloneNode(true),this.getNode())};this.clone=function(){return JSJaCPWrapNode(this.getNode())}}function JSJaCPresence(){this.base=JSJaCPacket;this.base("presence");this.setStatus=function(a){this.getNode().appendChild(this.getDoc().createElement("status")).appendChild(this.getDoc().createTextNode(a));return this};this.setShow=function(a){this.getNode().appendChild(this.getDoc().createElement("show")).appendChild(this.getDoc().createTextNode(a));return this};this.setPriority=function(a){this.getNode().appendChild(this.getDoc().createElement("priority")).appendChild(this.getDoc().createTextNode(a));return this};this.setSCLItem=function(d,b,a){var c=this.getNode().appendChild(this.getDoc().createElement("SCL"));c.setAttribute("id",b);c.setAttribute("item_id",d);c.setAttribute("shortcode",a);return c};this.setPresence=function(b,a,f,e,d,c){if(b){this.setShow(b)}if(a){this.setStatus(a)}if(f){this.setPriority(f)}if(e){this.setSCLItem(e,d,c)}return this};this.getStatus=function(){return this._childElVal("status")};this.getShow=function(){return this._childElVal("show")};this.getPriority=function(){return this._childElVal("priority")}}function JSJaCIQ(){this.base=JSJaCPacket;this.base("iq");this.setIQ=function(d,c,a,b){if(d){this.setTo(d)}if(a){this.setType(a)}if(c){this.setFrom(c)}if(b){this.setID(b)}return this};this.setQuery=function(a){if(window.ActiveXObject){query=this.getNode().appendChild(this.getDoc().createElement("query"));query.setAttribute("xmlns",a)}else{query=this.getNode().appendChild(this.getDoc().createElementNS(a,"query"))}return query};this.getQuery=function(){return this.getNode().getElementsByTagName("query").item(0)};this.getQueryXMLNS=function(){if(this.getQuery()){return this.getQuery().getAttribute("xmlns")}else{return null}}}function JSJaCMessage(){this.base=JSJaCPacket;this.base("message");this.setBody=function(a){var b=this.getNode().appendChild(this.getDoc().createElement("body"));b.appendChild(this.getDoc().createTextNode(a));return this};this.setCDATABody=function(a){var b=this.getNode().appendChild(this.getDoc().createElement("body"));b.appendChild(this.getDoc().createCDATASection(a));return this};this.setSubject=function(b){var a=this.getNode().appendChild(this.getDoc().createElement("subject"));a.appendChild(this.getDoc().createTextNode(b));return this};this.getBody=function(){return this._childElVal("body")};this.getSubject=function(){return this._childElVal("subject")}}function JSJaCPWrapNode(b){var a;switch(b.nodeName.toLowerCase()){case"presence":a=new JSJaCPresence();break;case"message":a=new JSJaCMessage();break;case"iq":a=new JSJaCIQ();break;default:return b}a._replaceNode(b);return a}function LogRecord(d,a,b,c){this._date=new Date();this._level=d;this._component=a;this._log=b;this._sequence=c}LogRecord.prototype.getFormattedData=function(){return this._sequence+"\t"+this._date.toGMTString()+"\t"+LOG_LEVELS[this._level]+"\t"+this._component+"\t"+this._log};LogRecord.prototype.getXml=function(){};LogRecord.prototype.getLogLevel=function(){return this._level};LogRecord.prototype.getLogComponent=function(){return this._component};LogRecord.prototype.getData=function(){return this._log};LogRecord.prototype.getTimestamp=function(){return this._time};var Logger=new function(){this._count=1;this._components=new Array();this._logRecords=new Array();this._maxSize=100;this._displayLogCount=0;this.isComponent=function(a){if(this._components instanceof Array){for(var b=0;b<this._components.length;b++){if(this._components[b]==a){return true}}}return false};this.log=function(a,c,b){if(typeof(CtlPostMsgx)!="undefined"&&getLogLevel()>=c){CtlPostMsgx(ctlLogLvlInfo,a+": "+b)}else{if(getLogLevel()>=c){var b=new LogRecord(c,a,b,this._count);this._count++;this._logRecords.push(b)}if(getLogLevel()==parseInt(LOG_DEV)){this.displayLog(new Date().toUTCString()+": "+a+": "+b)}else{if(this._logRecords.length>this._maxSize){this._logRecords.shift()}}}};this.displayLog=function(d){if(document.body){var b=$("debuglog");if(!b){var a="";a+='<div id="debuglog_container" style="position: absolute; top: 10px; left: 300px;">';a+='  <div id="debuglog" style="width: 700px; height: 650px; overflow: auto; background: #fff; border: 10px solid #aaa;"></div>';a+='  <form id="debugform" method="post" action="show_rtapi_log.php" target="_blank">';a+='    <input type="hidden" id="rtapi_log" name="rtapi_log" value="" />';a+="  </form>";a+='  <div style="margin: 10px; text-align: center"><a href="#" onclick="$(\'debuglog\').update(\'\');">Clear Log</a></div>';a+="</div>";new Insertion.Bottom(document.body,a);b=$("debuglog")}if(b){var c=(this._displayLogCount++%2)?"background: #ddd;":"";b.innerHTML+="<div style='padding: 3px;"+c+"'>"+d+"</div>";b.scrollTop=b.scrollHeight}}};this._clearLog=function(){this._logRecords=new Array()};this.setComponents=function(a){this._components=a};this.addComponent=function(a){this._components.push(a)};this.getLogs=function(){return this._logRecords}};var LOG_DEV=-1;var LOG_NONE=0;var LOG_ERROR=1;var LOG_WARN=2;var LOG_INFO=3;var LOG_DEBUG=4;var LOG_TRACE=5;var LOG_DETAIL=6;var LOG_LEVELS=["None","Error","Warn","Info","Debug","Trace","Detail"];var _rtapiLogLevel=LOG_ERROR;var EVENT_AGENT_DISABLED=-5;var EVENT_AGENT_LOCKED=-4;var EVENT_EXCEED_MAX_LOGIN_COUNT=-3;var EVENT_UNKNOWN_ERROR=-2;var EVENT_INVALID_LOGIN=-1;var EVENT_LOGIN_COMPLETED=1;var EVENT_PING_RESULT=2;var EVENT_AGENT_INFO=3;var EVENT_AGENT_INFO_UPDATE=4;var EVENT_AGENT_STATS_UPDATE=5;var EVENT_TENANT_INFO_UPDATE=6;var EVENT_AGENT_STATUS_UPDATE=7;var EVENT_ROSTER=8;var EVENT_ROSTER_UPDATE=9;var EVENT_ROSTER_REMOVE=10;var EVENT_TENANT_SKILL_STATS_UPDATE=11;var EVENT_TENANT_SKILL_UPDATE=12;var EVENT_QUEUE_REMOVE=13;var EVENT_RESOURCE_ADD=14;var EVENT_RESOURCE_REMOVE=15;var EVENT_AGENT_PROFILE_STATUS_UPDATE=16;var EVENT_AGENT_PROFILE_UPDATE=17;var EVENT_SESSION_USER_DATA=18;var EVENT_NEW_CALL=19;var EVENT_CALL_STATUS_UPDATE=20;var EVENT_CALL_CONF_UPDATE=21;var EVENT_CALL_REMOVE=22;var EVENT_NEW_CHAT=23;var EVENT_CHAT_MSG=24;var EVENT_CHAT_STATUS_UPDATE=25;var EVENT_CHAT_REMOVE=26;var EVENT_NEW_EMAIL=27;var EVENT_EMAIL_MSG_INFO=28;var EVENT_EMAIL_STATUS_UPDATE=29;var EVENT_AGENT_STATUS_PROBE=30;var EVENT_GROUP_UPDATE=31;var EVENT_NOTICE=32;var EVENT_BROADCAST_RESPONSE=33;var EVENT_MONITORING_CALL=34;var EVENT_INTERACTION_RECOVERY=35;var EVENT_DISCONNECTED=36;var EVENT_RECONNECTED=37;var EVENT_GENERIC_MESSAGE=38;var EVENT_CAMPAIGN_MONITORING_INFO_UPDATE=39;var EVENT_CAMPAIGN_UPDATE=40;var EVENT_PASSWORD_POLICY_UPDATE=41;var EVENT_PASSWORD_UPDATE_RESPONSE=42;var EVENT_CHAT_TYPING=43;var EVENT_TASK_UPDATE=44;var EVENT_DEFAULT_DIAL_PLAN_UPDATE=45;var EVENT_AGENT_PHONE_UPDATE=46;var EVENT_RELOAD_RECONNECTED=47;var EVENT_CHAT_OUTGOING_MSG=48;var EVENT_CHAT_INCOMING_MSG=49;var EVENT_SUB_STATE_RESPONSE_STOP_NEW_ON=50;var EVENT_SUB_STATE_RESPONSE_STOP_NEW_OFF=51;var EVENT_EXCEED_MAX_RETRY_STICKY_CONNECTION=52;var EVENT_DISCONECTED_ERROR=53;var EVENT_CHAT_TRANSLATION_STATUS_UPDATE=54;var EVENT_CHAT_INCOMING_INFO=55;var EVENT_CHAT_TRANSLATION_SERVICE_ERROR=56;var EVENT_INTERACTION_ACCEPTED=57;var EVENT_INTERACTION_REJECTED=58;var EVENT_VO_ROSTERS_UPDATE=59;var EVENT_VO_ROSTER_PRESENCE_UPDATE=60;var EVENT_VO_ROSTER_CHAT_MSG_RECEIVED=61;var EVENT_VO_CHAT_TYPING=62;var EVENT_CO_BROWSING_INVITE=63;var EVENT_CO_BROWSING_INVITE_ACCEPTED=64;var EVENT_CO_BROWSING_INVITE_REJECTED=65;var EVENT_CO_BROWSING_SESSION_STARTED=66;var EVENT_CO_BROWSING_SESSION_ENDED=67;var EVENT_CO_BROWSING_INSTANCE_NOT_FOUND=68;var EVENT_MONITORING_AGENTLIST=69;var EVENT_MONITORING_AGENT_LINE_STATUS=70;var EVENT_AGENT_INFO_DATA=71;var EVENT_ITSTATS_TENANT_SKILL_STATS_UPDATE=72;var EVENT_CONNECTION_CLEAN_UP=73;var STATUS_LOGGED_OUT=0;var STATUS_LOGGED_IN=1;var STATUS_ON_BREAK=2;var STATUS_WAITING_TRANSACT=3;var STATUS_WORK_OFFLINE=4;var STATUS_TRANSACT_OFFERED=5;var STATUS_BUSY=6;var STATUS_POST_PROCESS=7;var STATUS_CALL_OFFERED=8;var STATUS_CHAT_OFFERED=9;var STATUS_EMAIL_OFFERED=10;var STATUS_DIRECT_CALL=11;var STATUS_ON_EMAIL=12;var PHONE_SESSION_OFFERED=0;var PHONE_SESSION_DIALING=1;var PHONE_SESSION_PROCEEDING=2;var PHONE_SESSION_RINGING=3;var PHONE_SESSION_ACTIVE=4;var PHONE_SESSION_HOLD=5;var PHONE_SESSION_MUTE=6;var PHONE_SESSION_HUNG_UP=8;var PHONE_SESSION_TERMINATED=9;var PHONE_SESSION_POST_PROCESSING=10;var PHONE_SESSION_MONITORING=11;var PHONE_SESSION_OUTBOUND_DIALER_DESTINATION_ANSWERED=12;var CHAT_INTERNAL_RESOURCE_START_INDEX=1000;var ITSTATS_STATS_INFO_POLLING_INTERVAL=10*1000;var GUID_CHAR_LIST="1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";var AGENT_INFO_REQUEST_MIN_INTERVAL_MILLIS=1*60*60*1000;function Base(className){this.className=className||"Base";this._logger=Logger;this.log=function(level,log){this._logger.log(this.className,level,log)};this.sendMonitor=function(){this._logger.addComponent(this.className)};this.initPropertiesFromObject=function(obj){for(property in obj){if(obj[property]&&typeof obj[property]=="object"){this[property]=eval("new "+obj[property].className+"()");this[property].initPropertiesFromObject(obj[property])}else{this[property]=obj[property]}}};this._logger.addComponent(this.className)}function createRtapiConnection(){return new JabberConnection()}function setLogLevel(a){_rtapiLogLevel=a}function getLogLevel(){return _rtapiLogLevel}function getNodeValue(c,a){var b=c.getElementsByTagName(a)[0];if(b&&b.firstChild){return b.firstChild.nodeValue}}function getNodeValueWithParentName(e,a,d){var b=e.getElementsByTagName(a);for(var c=0;c<b.length;c++){if(b[c].parentNode.nodeName==d){if(b[c].firstChild){return b[c].firstChild.nodeValue}}}}function getTextContentWithParentName(e,a,d){var b=e.getElementsByTagName(a);for(var c=0;c<b.length;c++){if(b[c].parentNode.nodeName==d){return b[c].textContent}}}function sanitizeJid(a){if(a&&a.match(/CtlAgent/)){a=a.split(/\/CtlAgent/)[0]}return a}function addResourceToJid(a){if(!a.match(/CtlAgent/)){a=a+"/CtlAgent"}return a}function couple(c,a){var b=c[a];return function(){return b.apply(c,arguments)}}function escapeXml(a){a=a.replace(/&/gm,"&amp;");a=a.replace(/</gm,"&lt;");a=a.replace(/>/gm,"&gt;");a=a.replace(/"/gm,"&quot;");return a}function createElementWithNS(a,b,d){if(window.ActiveXObject){var c=a.getDoc().createElement(b);c.setAttribute("xmlns",d)}else{var c=a.getDoc().createElementNS(d,b)}return c}var Comet=new function(){this._base=Base;this._base("Comet");this.url=null;this.iframeName="cometIframe";this.receiver=null;this.callback=null;this.hasConnect=false;this.connect=function(a){this.hasConnect=true;this.callback=a.callback;this.url=a.url;this.log(LOG_DEBUG,"connect: callback: "+this.callback);this.log(LOG_DEBUG,"connect: url: "+this.url);if(window.ActiveXObject){this._createActivexIframe()}else{if(typeof(CtlComet)!="undefined"){this.receiver=new CtlComet();this.receiver.init(ctlCHANNEL,ctlSESSION,this.url,function(b){Comet.dispatch(b)});this.receiver.start()}else{this._createIframe()}}};this.dispatch=function(a){this.callback(a)};this.cleanUp=function(){if(this.hasConnect){this.log(LOG_ERROR,"Doing comet cleanUp");var b="";var a=this.url.split("/");a.pop();b=a.join("/");if(b.length>0){b+="/"}b+="blank.php";if(window.ActiveXObject){this.receiver=null;CollectGarbage()}else{if(typeof(CtlComet)!="undefined"){this.receiver.stop()}else{document.getElementById(this.iframeName).src=b}}}else{this.log(LOG_ERROR,"XDomainRequest is used, no Comet cleanup is needed")}};this._createIframe=function(){this.log(LOG_DEBUG,"_createIframe: creating iframe");this.receiver=document.createElement("iframe");this.receiver.name=this.iframeName;this.receiver.setAttribute("name",this.iframeName);this.receiver.id=this.iframeName;document.body.appendChild(this.receiver);this.receiver.style.position="absolute";this.receiver.style.left="0px";this.receiver.style.top="0px";this.receiver.style.height="1px";this.receiver.style.width="1px";this.receiver.style.visibility="hidden";document.getElementById(this.iframeName).src=this.url;window.addEventListener("unload",couple(this,"cleanUp"),false)};this._createActivexIframe=function(){this.log(LOG_DEBUG,"_createActivexIframe: creating iframe (activex)");this.receiver=new ActiveXObject("htmlfile");this.receiver.open();this.receiver.write("<html>");this.receiver.write("<script>document.domain = '"+document.domain+"'");this.receiver.write("</html>");this.receiver.close();var a=this.receiver.createElement("div");this.receiver.appendChild(a);this.receiver.parentWindow.Comet=this;a.innerHTML="<iframe id='"+this.iframeName+"' src='"+this.url+"'></iframe>";window.attachEvent("onunload",couple(this,"cleanUp"))}};function Connection(a){var a=a||"Connection";this._base=Base;this._base(a);this._logoutUrl=null;this._host=null;this._port=null;this._eventHandlers=new Array();this._user=null;this._pass=null;this._passhash=null;this._keepAlive=true;this._pingFrequency=40000;this._pingTimeout=null;this._numMissedSentPings=4;this._numPingCyclesBeforeReconnect=2;this._reconnectFrequency=5000;this._maxReconnectionAttempts=10;this._reconnectCount=0;this._disconnected=false;this._stickyReason="";this._stickyCount=0;this._lastMessageReceived=null;this._lastPingSent=null;this._xdr=null;this._lastMessageId=-1;this._waitStickyMethods=[];this.lostStickConnectionCallback=null;this._connectionType=null;this._lastProcessedReceivedChunk=0;this._configurationReceivedChunksMap={};this._initialReceivedChunks=[];this._lastMainReceivedChunks=[];this._lastReceivedChunks=[];this._lastSentChunks=[];this._isLogMessageDelaysEnabled=false}Connection.prototype=new Base;Connection.TYPE_LEGACY_COMET="TYPE_LEGACY_COMET";Connection.TYPE_EVENT_SOURCE="TYPE_EVENT_SOURCE";Connection.TYPE_XML_HTTP_REQUEST="TYPE_XML_HTTP_REQUEST";Connection.TYPE_X_DOMAIN_REQUEST="TYPE_X_DOMAIN_REQUEST";Connection.NUM_INITIAL_STORED_CHUNKS=50;Connection.NUM_STORED_CHUNKS=250;Connection.prototype.init=function(b,a){this._host=b;this._port=a};Connection.prototype.getResponseText=function(){if(this._xdr){return this._xdr.responseText}else{return""}};Connection.prototype._setStickyReason=function(a){if(a){this._stickyReason=a}else{this._stickyReason=""}this._stickyCount=0;this.log(LOG_ERROR,"set sticky reason to "+this._stickyReason)};Connection.prototype.addEventHandler=function(b,c){var a=this._findEventHandler(b);if(!a){a=this._createNewEventHandler(b)}a.addCallback(c)};Connection.prototype.addHighPriorityEventHandler=function(b,c){var a=this._findEventHandler(b);if(!a){a=this._createNewEventHandler(b)}a.addHighPriorityCallback(c)};Connection.prototype._createNewEventHandler=function(b){var a=new EventHandler(b);this._eventHandlers.push(a);return a};Connection.prototype._findEventHandler=function(b){for(var a=0;a<this._eventHandlers.length;a++){if(this._eventHandlers[a].getEventId()==b){return this._eventHandlers[a]}}};Connection.prototype.handleEvent=function(b){this.log(LOG_DEBUG,"handleEvent: event #"+b.getId());var a=this._findEventHandler(b.getId());if(a){this.log(LOG_DEBUG,"handleEvent: found handler for event #"+b.getId());a.processEvent(b)}else{this.log(LOG_WARN,"handleEvent: couldn't find a handler for event: "+b.getId())}};Connection.prototype.sendMsg=function(f){var g="";if(f.xml){var d=f.agentId||null;var l=f.customerId||null;g=this._wrapPacket(f.xml.replace(/(\n|\r|&#10;?)/gi," "),d,l);g=this._addJSOutTimestamp(g);g=this._addMsgId(g)}var a=f.url||this._getHost();var b=couple(this,"_handleAjaxResponse");var k=function(m){if(f.callback){f.callback(m)}b(m)};var c=couple(this,"_sendMsgFailure");if(typeof(CtlAjax)!="undefined"){var h=new CtlAjax();h.setRequestHeader("Content-Type","text/xml");var e=new Object();e.responseText=h.fetch(ctlCHANNEL,ctlSESSION,a,g);callback(e)}else{new Ajax.Request(a,{contentType:"text/xml",postBody:g,asynchronous:!f.sync,onSuccess:k,onFailure:function(){c(a,g)},onException:function(){c(a,g)}})}this._storeSentData(g);this.log(LOG_DETAIL,"sendMsg: url: "+a);this.log(LOG_DETAIL,"sendMsg: xml: "+escapeXml(g))};Connection.prototype._sendMsgFailure=function(c,b){this.log(LOG_ERROR,"_sendMsgFailure: error encountered");this.log(LOG_ERROR,"_sendMsgFailure: url: "+c);this.log(LOG_ERROR,"_sendMsgFailure: xml: "+escapeXml(b));if(typeof(CONFIG)=="undefined"){if(typeof(this._numJsonpRequests)=="undefined"){this._numJsonpRequests=0;var f=document.createElement("div");f.setAttribute("id",CONFIG.JSONP_DIV);f.style.display="none";document.getElementsByTagName("body")[0].appendChild(f)}else{if(this._numJsonpRequests>=CONFIG.MAX_JSONP_REQUESTS_PER_DIV){$(CONFIG.JSONP_DIV).innerHTML="";this._numJsonpRequests=0}}if(typeof(this._scriptUrl)=="undefined"){var e=location.href.match(/^https?:\/\/[^\/]*/gi);this._scriptUrl=e+CONFIG.HTTP_ROOT+"/AGUI/"}var d=document.createElement("div");d.innerHTML=new Date().toString();$(CONFIG.JSONP_DIV).appendChild(d);var a=document.createElement("script");a.setAttribute("src",this._scriptUrl+c+"&xml="+encodeURIComponent(b));$(CONFIG.JSONP_DIV).appendChild(a);this._numJsonpRequests++}};Connection.prototype.createStickyConnection=function(h,c){this._stickyCount++;this._lastMessageId=-1;var b=this._getHost()+"&ping=1&time="+new Date().getTime()+"&sticky=1&reason="+this._stickyReason+"&retryCount="+this._stickyCount+"&lastMessageTime="+this._lastMessageReceived+"&msgId="+encodeURIComponent(this._getMsgId());this.log(LOG_ERROR,"createStickyConnection: url: "+b);this._storeSentData(JSON.stringify({action:"createStickyConnection",url:b}));if(!window.XDomainRequest){if(typeof(EventSource)!=="undefined"){this._connectionType=Connection.TYPE_EVENT_SOURCE;try{this.log(LOG_ERROR,"Your browser supports EventSource.");if(this._xdr!=null){this.log(LOG_ERROR,"createStickyConnection: cleaning up EventSource.");this._xdr.close();this._xdr=null}if(this._xdr==null){this._xdr=new EventSource(b);this.log(LOG_ERROR,"createStickyConnection: instantiated event source.")}var f=this._xdr;var a=couple(this,"_xdomainOnerrorReconnect");this._xdr.onerror=function(){a()};this._xdr.onmessage=function(e){h(e.data)};this.log(LOG_ERROR,"createStickyConnection: event source callback ready.")}catch(g){this.log(LOG_ERROR,"createStickyConnection : Error instantiating EventSource: Exception: "+g.message)}}else{var k=new XMLHttpRequest();if(k.withCredentials!==undefined){this._connectionType=Connection.TYPE_XML_HTTP_REQUEST;try{if(this._xdr!=null){this.log(LOG_ERROR,"createStickyConnection: cleaning up xdr.");this._xdr.abort()}if(this._xdr==null){this._xdr=new XMLHttpRequest();this.log(LOG_ERROR,"createStickyConnection: instantiated xdr.")}var f=this._xdr;var m=couple(this,"_xdomainOntimeout");var a=couple(this,"_xdomainOnerrorReconnect");var l=couple(this,"_xdomainOnloadReconnect");var d=couple(this,"_parseXDomainCometChunk");this._xdr.open("GET",b,true);this._xdr.onload=function(){d(f.responseText);l()};this._xdr.onerror=function(){d(f.responseText);a()};this._xdr.onprogress=function(){h(f.responseText)};this._xdr.ontimeout=function(){m()};this._xdr.send()}catch(g){this.log(LOG_ERROR,"createStickyConnection : Error instantiating XMLHttpRequest: Exception: "+g.message)}}else{this._connectionType=Connection.TYPE_LEGACY_COMET;this.log(LOG_ERROR,"Your browser does not support the native XMLDomainRequest object. Using legacy comet connection.");Comet.connect({url:b,callback:function(e){h(e)}})}}}else{try{this._connectionType=Connection.TYPE_X_DOMAIN_REQUEST;if(this._xdr!=null){this.log(LOG_ERROR,"createStickyConnection: cleaning up xdr.");this._xdr.abort()}if(this._xdr==null){this._xdr=new XDomainRequest();this.log(LOG_ERROR,"createStickyConnection: instantiated xdr.")}var f=this._xdr;var m=couple(this,"_xdomainOntimeout");var a=couple(this,"_xdomainOnerrorReconnect");var l=couple(this,"_xdomainOnloadReconnect");var d=couple(this,"_parseXDomainCometChunk");this._xdr.open("GET",b);this._xdr.onload=function(){d(f.responseText);l()};this._xdr.onerror=function(){d(f.responseText);a()};this._xdr.onprogress=function(){h(f.responseText)};this._xdr.ontimeout=function(){m()};this._xdr.send()}catch(g){this.log(LOG_ERROR,"createStickyConnection : Error instantiating XDomainRequest: Exception: "+g.message)}}};Connection.prototype.startKeepAlive=function(){this.log(LOG_DEBUG,"startKeepAlive: starting");this._lastMessageReceived=new Date().getTime();setTimeout(couple(this,"sendPing"),this._pingFrequency);setTimeout(couple(this,"watchPing"),this._pingFrequency)};Connection.prototype.sendPing=function(){this.log(LOG_ERROR,"checking and generating ping");if(this._keepAlive&&this._reconnectCount<this._maxReconnectionAttempts){setTimeout(couple(this,"sendPing"),this._pingFrequency);var c=this._getHost()+"&ping=1&time="+new Date().getTime()+"&msgId="+encodeURIComponent(this._getMsgId());this.log(LOG_DETAIL,"sendPing: url: "+c);this.sendMsg({url:c});this._lastPingSent=new Date().getTime();if(!this._disconnected){var b=new Date().getTime()-this._lastMessageReceived;if(b>(this._pingFrequency*this._numPingCyclesBeforeReconnect)){this.log(LOG_ERROR,"generating disconnect event, seconds since last message received: "+(b/1000));this._disconnected=true;var a=new CtlEvent(EVENT_DISCONNECTED,"disconnected");this.handleEvent(a);this._setStickyReason("connectionlost");this._reconnect()}}}};Connection.prototype.watchPing=function(){if(this._keepAlive){setTimeout(couple(this,"watchPing"),this._pingFrequency);var a=new Date().getTime()-this._lastPingSent;if(a>(this._pingFrequency*this._numMissedSentPings)){this.log(LOG_ERROR,"the last ping was sent "+(a/1000)+" seconds ago.. restarting the keep-alive mechanism");this.sendPing()}}};Connection.prototype._xdomainOnerrorReconnect=function(){this.log(LOG_ERROR,"_xdomainOnerrorReconnect: detected lost of connection from XDomainRequest because of onerror, check if it is disconnected and attempting to reconnect.");this.destroy();if(!this._disconnected){this._setStickyReason("connectionerror");this._disconnected=true;if(!this._isReload&&typeof(agent)!="undefined"&&agent.getStatus()!=STATUS_LOGGED_OUT){this.log(LOG_ERROR,"_xdomainOnloadReconnect: generating disconnect event and perform reconnect.");var a=new CtlEvent(EVENT_DISCONNECTED,"disconnected");this.handleEvent(a)}setTimeout(couple(this,"_reconnect"),500)}};Connection.prototype._xdomainOntimeout=function(){this.log(LOG_ERROR,"_xdomainOntimeout occurred.")};Connection.prototype._xdomainReconnect=function(){this.log(LOG_ERROR,"_xdomainReconnect: detected lost of connection from XDomainRequest, check if it is disconnected and attempting to reconnect.");if(!this._disconnected){this._setStickyReason("connectionlost");this._disconnected=true;this.log(LOG_ERROR,"_xdomainReconnect: generating disconnect event and perform reconnect.");var a=new CtlEvent(EVENT_DISCONNECTED,"disconnected");this.handleEvent(a);setTimeout(couple(this,"_reconnect"),1000)}};Connection.prototype._xdomainOnloadReconnect=function(){this.log(LOG_ERROR,"_xdomainOnloadReconnect: detected lost of connection from XDomainRequest because of onload, check if it is disconnected and attempting to reconnect.");this.destroy();if(!this._disconnected){this._setStickyReason("xonload");this._disconnected=true;if(!this._isReload&&typeof(agent)!="undefined"&&agent.getStatus()!=STATUS_LOGGED_OUT){this.log(LOG_ERROR,"_xdomainOnloadReconnect: generating disconnect event and perform reconnect.");var a=new CtlEvent(EVENT_DISCONNECTED,"disconnected");this.handleEvent(a)}setTimeout(couple(this,"_reconnect"),1000)}};Connection.prototype._reconnect=function(){this.log(LOG_ERROR,"_reconnect: checking if reconnect required...");if(this._keepAlive&&this._disconnected){if(this._reconnectCount<this._maxReconnectionAttempts){this._reconnectCount++;this.log(LOG_ERROR,"_reconnect: performing reconnect");Comet.cleanUp();this.createStickyConnection(couple(this,"_parseCometChunk"),couple(this,"_xdomainReconnect"));setTimeout(couple(this,"_reconnect"),this._reconnectFrequency)}else{this.log(LOG_ERROR,"Max reconnection attempts reached, Closing xdr connection.");this.destroy();this.lostStickConnectionCallback&&this.lostStickConnectionCallback()}}};Connection.prototype._handleConnectionCleanUp=function(){this.log(LOG_INFO,"Handle Connection clean up");this._disconnected=true;this.close();this.destroy();this.reportError({error:"connection_clean_up",message:"Connection clean up"})};Connection.prototype.close=function(){this.log(LOG_DEBUG,"close: shutting down connection");this._keepAlive=false;Comet.cleanUp()};Connection.prototype.destroy=function(){if(this._xdr&&this._xdr.close){this._xdr.close()}else{if(this._xdr&&this._xdr.abort){this._xdr.abort()}}this._xdr=null};Connection.prototype.startTenantSkillStatsPolling=function(a){if(!a){console.error("[Connection]","[startTenantSkillStatsPolling]","Missing type");return}if(this.isTenantSkillStatsPollingRunning(a)){console.info("[Connection]","[startTenantSkillStatsPolling]","Pollling already running");return}this.tenantSkillStatsRequestHasError=false;this.stopTenantSkillStatsPolling(a);this.scheduleTenantSkillStatsRequest(a)};Connection.prototype.stopTenantSkillStatsPolling=function(a){if(this.tenantSkillStatsRequestTimeout!=null){clearTimeout(this.tenantSkillStatsRequestTimeout);this.tenantSkillStatsRequestTimeout=null}};Connection.prototype.scheduleTenantSkillStatsRequest=function(b){var a=this.getTenantSkillStatsRequestDelay(b);this.tenantSkillStatsRequestTimeout=setTimeout(this.requestTenantSkillStats.bind(this,b),a)};Connection.prototype.isTenantSkillStatsPollingRunning=function(a){return this.tenantSkillStatsPollingType===a&&this.tenantSkillStatsRequestTimeout!==null};Connection.prototype.isTenantSkillStatsUpToDate=function(a){return this.isTenantSkillStatsPollingRunning(a)&&!this.tenantSkillStatsRequestHasError};Connection.prototype.getTenantSkillStatsRequestDelay=function(b){if(b!==this.tenantSkillStatsPollingType){return 0}var a=Date.now()-(this.lastTenantSkillStatsPollingRequest||0);a=ITSTATS_STATS_INFO_POLLING_INTERVAL-a;a=a>0?a:0;return Math.min(a,ITSTATS_STATS_INFO_POLLING_INTERVAL)};Connection.prototype.requestTenantSkillStats=function(b){if(this.hasPendingTenantSkillStatsRequest(this.tenantSkillStatsXHR)){console.warn("[Connection]","[requestTenantSkillStats]","Aborting previous request");this.tenantSkillStatsXHR.abort()}this.tenantSkillStatsPollingType=b;this.lastTenantSkillStatsPollingRequest=Date.now();var a="agent_rtapi_tenant_skill_stats.php";var c=["type="+b,"agent="+this._login,"tenant="+this._tenant,"msgId="+this._getMsgId(),"timestamp-js-out="+Date.now()];this.tenantSkillStatsXHR=new XMLHttpRequest();this.tenantSkillStatsXHR.open("GET",a+"?"+c.join("&"));this.tenantSkillStatsXHR.timeout=ITSTATS_STATS_INFO_POLLING_INTERVAL*2;this.tenantSkillStatsXHR.onload=this.tenantSkillStatsRequestLoadHandler.bind(this,this.tenantSkillStatsXHR,b);this.tenantSkillStatsXHR.onerror=this.tenantSkillStatsRequestErrorHandler.bind(this,this.tenantSkillStatsXHR,b);this.tenantSkillStatsXHR.ontimeout=this.tenantSkillStatsRequestTimeoutHandler.bind(this,this.tenantSkillStatsXHR,b);this.tenantSkillStatsXHR.send()};Connection.prototype.hasPendingTenantSkillStatsRequest=function(a){return a&&a.readyState!==4};Connection.prototype.tenantSkillStatsRequestLoadHandler=function(d,b,c){if(this.isTenantSkillStatsPollingRunning(b)){this.scheduleTenantSkillStatsRequest(b)}if(d.status!==200){console.error("[Connection]","[tenantSkillStatsRequestLoadHandler]","error=statusCode","statusCode="+d.status);this.reportError({error:"tenantSkillStatsRequestLoad",message:"statusCode="+d.status});return}var a;try{a=JSON.parse(d.responseText);a["timestamp-js-in"]=Date.now()}catch(f){console.error("[Connection]","[tenantSkillStatsRequestLoadHandler]","error=invalidJSON",f);this.reportError({error:"tenantSkillStatsRequestLoad",message:"invalidJSON"});return}this._storeReceivedData(d.responseText,"EVENT_ITSTATS_TENANT_SKILL_STATS_UPDATE");this._logJSONMessageDelays(a,"EVENT_ITSTATS_TENANT_SKILL_STATS_UPDATE");this.loadTenantSkillStatsData(a.data)};Connection.prototype.loadTenantSkillStatsData=function(b){this.tenantSkillStatsRequestHasError=false;var a=new CtlEvent(EVENT_ITSTATS_TENANT_SKILL_STATS_UPDATE,b);this.handleEvent(a)};Connection.prototype.tenantSkillStatsRequestErrorHandler=function(b,a,c){console.error("[Connection]","[tenantSkillStatsRequestErrorHandler]",c);if(this.isTenantSkillStatsPollingRunning(a)){this.scheduleTenantSkillStatsRequest(a)}this.reportError({error:"tenantSkillStatsRequestError",message:"requestError"})};Connection.prototype.tenantSkillStatsRequestTimeoutHandler=function(c,b,a){console.error("[Connection]","[tenantSkillStatsRequestTimeoutHandler]",a);if(this.isTenantSkillStatsPollingRunning(b)){this.scheduleTenantSkillStatsRequest(b)}this.reportError({error:"tenantSkillStatsRequestTimeout",message:"timeoutAfter="+(Date.now()-this.lastTenantSkillStatsPollingRequest)})};Connection.prototype.reportError=function(a){this.tenantSkillStatsRequestHasError=true;if(window.reportError){window.reportError({component:"rtapi",error:a.error,message:a.message})}};Connection.prototype._executeSubscribedWaitStickyMethods=function(){if(this._waitStickyMethods.length){this.log(LOG_ERROR,"Executing subscribed method for sticky connect established");for(var a=0;a<this._waitStickyMethods.length;a++){var b=this._waitStickyMethods[a].method;b()}this._waitStickyMethods=[]}};Connection.prototype._subscribeWaitStickyMethod=function(a){this._waitStickyMethods.push({method:a})};Connection.prototype._storeReceivedChunks=function(b){if(!b||!b.length){return}try{this._processReceivedChunks(b)}catch(a){this.log(LOG_ERROR,"Failed to store received chunks")}};Connection.prototype._storeReceivedData=function(b,a){if(!b){return}try{this._processReceivedData(b,a)}catch(c){this.log(LOG_ERROR,"Failed to store received data")}};Connection.prototype._getOnlyNewChunks=function(c){if(c.length<this._lastProcessedReceivedChunk){this._lastProcessedReceivedChunk=0}var a=[];for(var b=this._lastProcessedReceivedChunk;b<c.length;b++){a.push(c[b])}this._lastProcessedReceivedChunk=c.length;return a};Connection.prototype._getReceivedChunkType=function(b){var a=b.getElementsByTagName("body")[0];return this._getReceivedXMLMessageType(a)};Connection.prototype._isSecondaryType=function(a){return["EVENT_TENANT_SKILL_STATS_UPDATE","EVENT_PING_RESULT","EVENT_ROSTER_UPDATE","EVENT_VO_ROSTER_PRESENCE_UPDATE"].indexOf(a)!==-1};Connection.prototype._isConfigurationType=function(a){return["EVENT_AGENT_INFO","EVENT_MONITORING_AGENTLIST","EVENT_AGENT_INFO_DATA","EVENT_ROSTER","EVENT_VO_ROSTERS_UPDATE"].indexOf(a)!==-1};Connection.prototype._getAgentInfoDataPageNumber=function(a){var b=a.getElementsByTagName("AgentInfoData")[0];return b.getAttribute("page")||0};Connection.prototype._removeAllAgentInfoData=function(a){Object.keys(a).forEach(function(b){if(b.indexOf("EVENT_AGENT_INFO_DATA")===0){delete a[b]}})};Connection.prototype._processReceivedChunks=function(c){if(this._connectionType===Connection.TYPE_X_DOMAIN_REQUEST||this._connectionType===Connection.TYPE_XML_HTTP_REQUEST){c=this._getOnlyNewChunks(c)}for(var b=0;b<c.length;b++){var a=this._getReceivedChunkType(c[b]);this._processReceivedData(c[b],a)}};Connection.prototype._normalizedataMessageType=function(c,a){if(a==="EVENT_AGENT_INFO_DATA"){var b=this._getAgentInfoDataPageNumber(c);if(b===0){this._removeAllAgentInfoData(this._configurationReceivedChunksMap)}a+="_"+b}return a};Connection.prototype._processReceivedData=function(c,a){var b=Date.now();if(this._isConfigurationType(a)){a=this._normalizedataMessageType(c,a);this._configurationReceivedChunksMap[a]={timestamp:b,type:a,data:c}}if(this._isSecondaryType(a)){this._lastReceivedChunks.push({timestamp:b,type:a,data:c})}else{this._lastMainReceivedChunks.push({timestamp:b,type:a,data:c})}if(this._initialReceivedChunks.length<Connection.NUM_INITIAL_STORED_CHUNKS){this._initialReceivedChunks.push({timestamp:b,type:a,data:c})}this._lastReceivedChunks=this._lastReceivedChunks.slice(-Connection.NUM_STORED_CHUNKS);this._lastMainReceivedChunks=this._lastMainReceivedChunks.slice(-Connection.NUM_STORED_CHUNKS)};Connection.prototype._storeSentData=function(a){if(!a){return}try{this._lastSentChunks.push({timestamp:Date.now(),data:a});this._lastSentChunks=this._lastSentChunks.slice(-Connection.NUM_STORED_CHUNKS)}catch(b){this.log(LOG_ERROR,"Failed to store sent chunk")}};Connection.prototype._setLogMessageDelaysEnabled=function(a){this._isLogMessageDelaysEnabled=!!a};Connection.prototype._logXMLMessagesDelays=function(b){if(!this._isLogMessageDelaysEnabled){return}if(!b||!b.length){return}try{this._processXMLMessageDelays(b)}catch(a){this.log(LOG_ERROR,"Failed to log XML messages delays")}};Connection.prototype._logJSONMessageDelays=function(b,a){if(!this._isLogMessageDelaysEnabled){return}if(!b){return}try{this._logBackendMessageDelays(b,a)}catch(c){this.log(LOG_ERROR,"Failed to log JSON message delays")}};Connection.prototype._logSendXMLMessageDelays=function(a){if(!this._isLogMessageDelaysEnabled){return}if(!a){return}try{this._processSentXMLMessageDelays(a)}catch(b){this.log(LOG_ERROR,"Failed to log sent XML message delays")}};Connection.prototype._processXMLMessageDelays=function(e){var d=0;if(this._connectionType===Connection.TYPE_X_DOMAIN_REQUEST||this._connectionType===Connection.TYPE_XML_HTTP_REQUEST){d=this._lastMessageId+1}for(var c=d;c<e.length;c++){var a=e[c].getElementsByTagName("body");for(var b=0;b<a.length;b++){this._logXMLMessageDelays(a[b])}}};Connection.prototype._processSentXMLMessageDelays=function(b){var c=b.match(/msgId=['"](.*?)['"]/)[1];var a=this._getMessageSize(b);console.log("[POST] ["+c+"] ["+a+" B] JS --> PHP --> JCM")};Connection.prototype._logXMLMessageDelays=function(d){if(!d){return}var b=this._getXMLMsgId(d);var h=this._getXMLMessageTimestamps(d);var f=this._getJCMMessageDelays(h);var a=this._getJCMOutgoingLogMessage(f);var e=this._getJCMInternalLogMessage(f);var k=this._getJCMIncomingLogMessage(f);var c=this._getReceivedXMLMessageType(d);var g=this._getMessageSize(d);if(f.jsToPHP!=null){console.log("["+b+"] ["+c+"] ["+g+" B] "+a+" "+e+" "+k)}else{console.log("["+b+"] ["+c+"] ["+g+" B] "+k)}};Connection.prototype._getMessageSize=function(c){if(!c){return}var b="-";if(typeof c==="string"){b=c.length||"-"}else{if(c.outerHTML){b=c.outerHTML.length||"-"}else{var a=new XMLSerializer();var d=a.serializeToString(c);b=d.length||"-"}}return b};Connection.prototype._getReceivedXMLMessageType=function(a){if(!a||!a.firstChild){return}var d=a.firstChild;if(d.nodeName=="AgentSubStatus"){var b=d.getElementsByTagName("subStatus")[0].firstChild.nodeValue;if(b=="resumestopnew"){return"EVENT_SUB_STATE_RESPONSE_STOP_NEW_OFF"}else{if(b=="stopnew"){return"EVENT_SUB_STATE_RESPONSE_STOP_NEW_ON"}}}else{if(d.nodeName=="ping"){return"EVENT_PING_RESULT"}else{if(d.nodeName=="iq"){if(d.firstChild){if(d.firstChild.nodeName=="AgentInfo"){return"EVENT_AGENT_INFO"}else{if(d.firstChild.nodeName=="MonitoringAgentList"){return"EVENT_MONITORING_AGENTLIST"}else{if(d.firstChild.nodeName=="query"&&d.firstChild.firstChild.getAttribute("xmlns")=="contactual:client:agentinteractionlist"){return"EVENT_INTERACTION_RECOVERY"}else{if(d.firstChild.nodeName=="query"&&d.firstChild.getAttribute("xmlns")=="jabber:iq:roster"){if(d.firstChild.firstChild&&d.firstChild.firstChild.getAttribute("subscription")=="remove"){return"EVENT_ROSTER_REMOVE"}else{return"EVENT_ROSTER"}}else{if(d.firstChild.nodeName=="query"&&d.firstChild.getAttribute("xmlns")=="contactual:client:statsinfo"){return"EVENT_AGENT_STATS_UPDATE"}else{if(d.firstChild.nodeName=="query"&&d.firstChild.firstChild.nodeName=="CallLeg"){return"EVENT_CALL_STATUS_UPDATE"}else{if(d.firstChild.nodeName=="query"&&d.firstChild.getAttribute("xmlns")=="contactual:client:interactionmsg"){return"EVENT_GENERIC_MESSAGE"}else{if(d.firstChild.nodeName=="query"&&d.firstChild.getAttribute("xmlns")=="contactual:client:interaction"){if(d.firstChild.firstChild.getAttribute("type")=="phone"){if(d.firstChild.firstChild.getAttribute("status")=="assigned"&&d.firstChild.firstChild.getAttribute("agentInitiated")=="false"){return"EVENT_NEW_CALL"}else{if(d.firstChild.firstChild.getAttribute("status")=="joined"){return"EVENT_MONITORING_CALL"}else{return"EVENT_CALL_STATUS_UPDATE"}}}else{if(d.firstChild.firstChild.getAttribute("type")=="chat"){if(d.firstChild.firstChild.getAttribute("status")=="assigned"&&d.firstChild.firstChild.getAttribute("agentInitiated")=="false"){return"EVENT_NEW_CHAT"}else{return"EVENT_CHAT_STATUS_UPDATE"}}else{if(d.firstChild.firstChild.getAttribute("type")=="email"){if(d.firstChild.firstChild.getAttribute("status")=="assigned"){return"EVENT_NEW_EMAIL"}else{return"EVENT_EMAIL_STATUS_UPDATE"}}}}}else{if(d.firstChild.nodeName=="StatsInfo"&&d.firstChild.getAttribute("xmlns")=="contactual:client:statsinfo"){return"EVENT_TENANT_SKILL_STATS_UPDATE"}else{if(d.firstChild.nodeName=="query"&&d.firstChild.getAttribute("xmlns")=="contactual:client:agentinfodata"){return"EVENT_AGENT_INFO_DATA"}else{if(d.firstChild.nodeName=="query"&&d.firstChild.getAttribute("xmlns")=="contactual:vo:iq:roster"){return"EVENT_VO_ROSTERS_UPDATE"}else{if(d.firstChild.nodeName=="query"&&d.firstChild.getAttribute("xmlns")=="contactual:vo:iq:presence"){return"EVENT_VO_ROSTER_PRESENCE_UPDATE"}else{if(d.firstChild.nodeName=="query"&&d.firstChild.getAttribute("xmlns")=="contactual:vo:iq:chatMessage"){return"EVENT_VO_ROSTER_CHAT_MSG_RECEIVED"}else{if(d.firstChild.nodeName=="query"&&d.firstChild.getAttribute("xmlns")=="contactual:vo:iq:chatActivity"){return"EVENT_VO_CHAT_TYPING"}}}}}}}}}}}}}}}else{if(d.getAttribute("id")=="broadcast"&&(d.getAttribute("type")=="result"||d.getAttribute("type")=="error")){return"EVENT_BROADCAST_RESPONSE"}}}else{if(d.nodeName=="presence"){var e=d.getAttribute("from");if(e&&sanitizeJid(e)==sanitizeJid(this._jid)){return"EVENT_AGENT_STATUS_UPDATE"}else{var c=d.getAttribute("type");if(d.childNodes.length>0||(c&&c=="unavailable")){return"EVENT_ROSTER_UPDATE"}else{return"EVENT_AGENT_STATUS_PROBE"}}}else{if(d.nodeName=="message"){if(d.getElementsByTagName("AgentStats").length>0){return"EVENT_AGENT_STATS_UPDATE"}else{if(d.getElementsByTagName("AgentInfo").length>0){return"EVENT_AGENT_INFO_UPDATE"}else{if(d.getElementsByTagName("Group").length>0){return"EVENT_GROUP_UPDATE"}else{if(d.getElementsByTagName("Queue").length>0){return"EVENT_TENANT_SKILL_UPDATE"}else{if(d.getElementsByTagName("Broadcast").length>0){return"EVENT_NOTICE"}else{if(d.getElementsByTagName("ChatActivity").length>0){return"EVENT_CHAT_TYPING"}else{if(d.getElementsByTagName("TranslationStatus").length>0){return"EVENT_CHAT_TRANSLATION_STATUS_UPDATE"}else{if(d.getElementsByTagName("TranslationServiceError").length>0){return"EVENT_CHAT_TRANSLATION_SERVICE_ERROR"}else{if(d.getElementsByTagName("CoBrowsingInvite").length>0){return"EVENT_CO_BROWSING_INVITE"}else{if(d.getElementsByTagName("CoBrowsingInviteAccepted").length>0){return"EVENT_CO_BROWSING_INVITE_ACCEPTED"}else{if(d.getElementsByTagName("CoBrowsingInviteRejected").length>0){return"EVENT_CO_BROWSING_INVITE_REJECTED"}else{if(d.getElementsByTagName("CoBrowsingSessionStarted").length>0){return"EVENT_CO_BROWSING_SESSION_STARTED"}else{if(d.getElementsByTagName("CoBrowsingSessionEnded").length>0){return"EVENT_CO_BROWSING_SESSION_ENDED"}else{if(d.getElementsByTagName("CoBrowsingInstanceNotFound").length>0){return"EVENT_CO_BROWSING_INSTANCE_NOT_FOUND"}else{if(d.getElementsByTagName("Interaction").length>0){return"EVENT_CHAT_MSG"}else{if(d.getElementsByTagName("TenantInfo").length>0){return"EVENT_TENANT_INFO_UPDATE"}else{if(d.getElementsByTagName("campaignStatus").length>0){return"EVENT_CAMPAIGN_MONITORING_INFO_UPDATE"}else{if(d.getElementsByTagName("campaignUpdate").length>0){return"EVENT_CAMPAIGN_UPDATE"}else{if(d.getElementsByTagName("PasswordPolicyUpdate").length>0){return"EVENT_PASSWORD_POLICY_UPDATE"}else{if(d.getElementsByTagName("PasswordUpdate").length>0){return"EVENT_PASSWORD_UPDATE_RESPONSE"}else{if(d.getElementsByTagName("DialPlan").length>0){return"EVENT_DEFAULT_DIAL_PLAN_UPDATE"}else{if(d.getElementsByTagName("AgentPhoneUpdate").length>0){return"EVENT_AGENT_PHONE_UPDATE"}else{if(d.getElementsByTagName("AgentLineStatus").length>0){return"EVENT_MONITORING_AGENT_LINE_STATUS"}}}}}}}}}}}}}}}}}}}}}}}}else{if(d.nodeName=="reload"){return"EVENT_RELOAD"}else{if(d.nodeName=="UpdateTasks"){return"EVENT_TASK_UPDATE"}else{if(d.nodeName=="ConnectionCleanup"){return"EVENT_CONNECTION_CLEAN_UP"}}}}}}}}return"UNKNOWN"};Connection.prototype._logBackendMessageDelays=function(h,b){if(!h){return}var c=this._getJSONMsgId(h);var g=this._getJSONMessageTimestamps(h);var d=this._getBackendMessageDelays(g);var a=this._getBackendOutgoingLogMessage(d);var k=this._getBackendIncomingLogMessage(d);var e=this._getBackendTotalLogMessage(d);var f=this._getMessageSize(JSON.stringify(h));if(d.jsToPHP!=null){console.log("["+c+"] ["+b+"] ["+f+" B]"+a+" "+k+" "+e)}else{console.log("["+c+"] ["+b+"] ["+f+" B]"+k)}};Connection.prototype._getXMLMsgId=function(a){var c="no-msgId";try{c=a.getAttribute("msgId")||c}catch(b){}return c.trim()};Connection.prototype._getJSONMsgId=function(a){return a.msgId||"no-msgId"};Connection.prototype._getXMLMessageTimestamps=function(b){var a={jsOut:this._getParsedXMLAttribute(b,"timestamp-js-out"),phpToJCM:this._getParsedXMLAttribute(b,"timestamp-php-to-jcm"),jcmIn:this._getParsedXMLAttribute(b,"timestamp-jcm-in"),jcmOut:this._getParsedXMLAttribute(b,"timestamp-jcm-out"),phpToJS:this._getParsedXMLAttribute(b,"timestamp-php-to-js"),jsIn:this._getParsedXMLAttribute(b,"timestamp-js-in")};return a};Connection.prototype._getJSONMessageTimestamps=function(b){var a={jsOut:this._getParsedJSONAttribute(b,"timestamp-js-out"),phpToBackend:this._getParsedJSONAttribute(b,"timestamp-php-to-backend"),phpToJS:this._getParsedJSONAttribute(b,"timestamp-php-to-js"),jsIn:this._getParsedJSONAttribute(b,"timestamp-js-in")};return a};Connection.prototype._getJCMMessageDelays=function(a){var b={jsToPHP:null,phpToJCM:null,insideJCM:null,jcmToPHP:null,phpToJS:null};if(!isNaN(a.jsOut)&&!isNaN(a.phpToJCM)){b.jsToPHP=a.phpToJCM-a.jsOut}if(!isNaN(a.phpToJCM)&&!isNaN(a.jcmIn)){b.phpToJCM=a.jcmIn-a.phpToJCM}if(!isNaN(a.jcmIn)&&!isNaN(a.jcmOut)){b.insideJCM=a.jcmOut-a.jcmIn}if(!isNaN(a.jcmOut)&&!isNaN(a.phpToJS)){b.jcmToPHP=a.phpToJS-a.jcmOut}if(!isNaN(a.phpToJS)&&!isNaN(a.jsIn)){b.phpToJS=a.jsIn-a.phpToJS}return b};Connection.prototype._getBackendMessageDelays=function(a){var b={jsToPHP:null,phpToPHP:null,phpToJS:null};if(!isNaN(a.jsOut)&&!isNaN(a.phpToBackend)){b.jsToPHP=a.phpToBackend-a.jsOut}if(!isNaN(a.phpToBackend)&&!isNaN(a.phpToJS)){b.phpToPHP=a.phpToJS-a.phpToBackend}if(!isNaN(a.phpToJS)&&!isNaN(a.jsIn)){b.phpToJS=a.jsIn-a.phpToJS}if(!isNaN(a.jsOut)&&!isNaN(a.jsIn)){b.total=a.jsIn-a.jsOut}return b};Connection.prototype._getTimestampLogMessage=function(a){if(isNaN(a)){a="-"}return"("+a+" ms)"};Connection.prototype._getJCMOutgoingLogMessage=function(a){return"JS --> PHP "+this._getTimestampLogMessage(a.jsToPHP)+" PHP --> JCM "+this._getTimestampLogMessage(a.phpToJCM)};Connection.prototype._getJCMInternalLogMessage=function(a){return"JCM --> JCM "+this._getTimestampLogMessage(a.insideJCM)};Connection.prototype._getJCMIncomingLogMessage=function(a){return"JCM --> PHP "+this._getTimestampLogMessage(a.jcmToPHP)+" PHP --> JS "+this._getTimestampLogMessage(a.phpToJS)};Connection.prototype._getBackendOutgoingLogMessage=function(a){return"JS --> PHP "+this._getTimestampLogMessage(a.jsToPHP)+" PHP --> backend --> PHP "+this._getTimestampLogMessage(a.phpToPHP)};Connection.prototype._getBackendIncomingLogMessage=function(a){return"PHP --> JS "+this._getTimestampLogMessage(a.phpToJS)};Connection.prototype._getBackendTotalLogMessage=function(a){return"Total JS --> JS "+this._getTimestampLogMessage(a.total)};Connection.prototype._getParsedXMLAttribute=function(a,b){var c;try{c=parseInt(a.getAttribute(b),10)}catch(d){}return c};Connection.prototype._getParsedJSONAttribute=function(a,b){var c;try{c=parseInt(a[b],10)}catch(d){}return c};function JabberConnection(){this._base=Connection;this._base("JabberConnection");this._login=null;this._tenant=null;this._to="";this._sid=null;this._ctVia=null;this._jid=null;this._oauth_token="";this._oauth_login="";this._crm_access_token="";this._crm_refresh_token="";this._crm_instance_url="";this._webserviceUrl="";this._ssoVerifyUrl="";this._crm_user_internal_id="";this._extSSOCrmType="";this._refreshAfterLogin=false;this._refreshUrl=null;this._isStickyConnected=false;this._retryStickyCount=0;this._maxRetryStickyAtLogin=5;this._retryStickyPeriod=5000;this._externalAgentId="";this._extAccessToken="";this._extRefreshToken="";this._extInstanceUrl="";this._extVerifyUrl=""}JabberConnection.prototype=new Connection;JabberConnection.prototype.refreshAfterLogin=function(a){this._refreshAfterLogin=true;this._refreshUrl=a};JabberConnection.prototype.login=function(b,c,d,a){this.login(b,c,d,a,c,"","")};JabberConnection.prototype.ssologin=function(c){this._resource="CtlAgent";this._logoutUrl=c.logoutUrl||location.href;this._logoutUrl=this._logoutUrl.replace(/(relogin|softlogout)=.*?(&|$)/g,"").replace(/\?$/,"");var b=/^([A-Za-z0-9_]+)\@([a-zA-Z0-9\-\.]+)$/.exec(c.user);this._login=c.extLoginId;this._tenant=c.tenant;this._user=this._login;this._webserviceUrl=c.webserviceUrl;this._crm_access_token=c.accessToken;this._crm_refresh_token=c.refreshToken;this._crm_instance_url=c.instanceURL;this._getTokenInfoUrl=c.getTokenInfoUrl;this._getUserProfileUrl=c.getUserProfileUrl;this._accessToken=c.accessToken;var d=new JSJaCIQ();d.setIQ(null,null,"get","auth1");var a=d.setQuery("jabber:iq:auth");if(c.oauth_token){this._oauth_token=c.oauth_token;a.appendChild(d.getDoc().createElement("oauthtoken")).appendChild(d.getDoc().createTextNode(this._oauth_token))}if(c.ssoVerifyUrl){this._ssoVerifyUrl=c.ssoVerifyUrl;a.appendChild(d.getDoc().createElement("ssoVerifyUrl")).appendChild(d.getDoc().createTextNode(this._ssoVerifyUrl))}a.appendChild(d.getDoc().createElement("ssoSignatureTimestamp")).appendChild(d.getDoc().createTextNode(c.ssoSignatureTimestamp));a.appendChild(d.getDoc().createElement("ssoSignature")).appendChild(d.getDoc().createTextNode(c.ssoSignature));a.appendChild(d.getDoc().createElement("username")).appendChild(d.getDoc().createTextNode(this._user));a.appendChild(d.getDoc().createElement("tenant")).appendChild(d.getDoc().createTextNode(c.tenant));a.appendChild(d.getDoc().createElement("resource")).appendChild(d.getDoc().createTextNode(this._resource));a.appendChild(d.getDoc().createElement("extLoginId")).appendChild(d.getDoc().createTextNode(c.extLoginId));a.appendChild(d.getDoc().createElement("browserinfo")).appendChild(d.getDoc().createTextNode(c.browserInfo));a.appendChild(d.getDoc().createElement("loginmode")).appendChild(d.getDoc().createTextNode(c.loginMode));a.appendChild(d.getDoc().createElement("timezoneOffset")).appendChild(d.getDoc().createTextNode((new Date()).getTimezoneOffset()));a.appendChild(d.getDoc().createElement("agentIP")).appendChild(d.getDoc().createTextNode(c.agentIP));this.sendMsg({xml:d.xml(),callback:couple(this,"_handleLoginResponse")})};JabberConnection.prototype.ssovologin=function(c){this._resource="CtlAgent";this._logoutUrl=c.logoutUrl||location.href;this._logoutUrl=this._logoutUrl.replace(/(relogin|softlogout)=.*?(&|$)/g,"").replace(/\?$/,"");var b=/^([A-Za-z0-9_]+)\@([a-zA-Z0-9\-\.]+)$/.exec(c.user);var e="";if(!b||b.length<3){this._login=c.user;this._tenant=c.user;e=c.user;this._user=this._login}else{this._login=b[1];this._tenant=b[2];e=this._tenant.replace(/\./g,"_DOT_");this._user=this._login+"_at_"+e}this._token=c.oauth_token;this._webserviceUrl=c.webserviceUrl;this._crm_access_token=c.accessToken;this._crm_refresh_token=c.refreshToken;this._crm_instance_url=c.instanceURL;this._getTokenInfoUrl=c.getTokenInfoUrl;this._getUserProfileUrl=c.getUserProfileUrl;this._accessToken=c.accessToken;this._extSSOCrmType=c.extSSOCrmType||"";this._extAccessToken=c.extAccessToken;this._extRefreshToken=c.extRefreshToken;this._extInstanceUrl=c.extInstanceUrl;this._extVerifyUrl=c.extVerifyUrl;this._externalAgentId=c.externalAgentId||"";var d=new JSJaCIQ();d.setIQ(null,null,"get","auth1");var a=d.setQuery("jabber:iq:auth");a.appendChild(d.getDoc().createElement("ssoSignatureTimestamp")).appendChild(d.getDoc().createTextNode(c.ssoSignatureTimestamp));a.appendChild(d.getDoc().createElement("ssoSignature")).appendChild(d.getDoc().createTextNode(c.ssoSignature));a.appendChild(d.getDoc().createElement("username")).appendChild(d.getDoc().createTextNode(this._user));a.appendChild(d.getDoc().createElement("tenant")).appendChild(d.getDoc().createTextNode(c.tenant));a.appendChild(d.getDoc().createElement("resource")).appendChild(d.getDoc().createTextNode(this._resource));a.appendChild(d.getDoc().createElement("extLoginId")).appendChild(d.getDoc().createTextNode(c.extLoginId));a.appendChild(d.getDoc().createElement("browserinfo")).appendChild(d.getDoc().createTextNode(c.browserInfo));a.appendChild(d.getDoc().createElement("loginmode")).appendChild(d.getDoc().createTextNode(c.loginMode));a.appendChild(d.getDoc().createElement("timezoneOffset")).appendChild(d.getDoc().createTextNode((new Date()).getTimezoneOffset()));a.appendChild(d.getDoc().createElement("agentIP")).appendChild(d.getDoc().createTextNode(c.agentIP));a.appendChild(d.getDoc().createElement("getTokenInfoUrl")).appendChild(d.getDoc().createTextNode(c.getTokenInfoUrl));a.appendChild(d.getDoc().createElement("getUserProfileUrl")).appendChild(d.getDoc().createTextNode(c.getUserProfileUrl));a.appendChild(d.getDoc().createElement("accessToken")).appendChild(d.getDoc().createTextNode(c.accessToken));a.appendChild(d.getDoc().createElement("extAccessToken")).appendChild(d.getDoc().createTextNode(c.extAccessToken));a.appendChild(d.getDoc().createElement("extRefreshToken")).appendChild(d.getDoc().createTextNode(c.extRefreshToken));a.appendChild(d.getDoc().createElement("extSSOCrmType")).appendChild(d.getDoc().createTextNode(c.extSSOCrmType));a.appendChild(d.getDoc().createElement("extInstanceUrl")).appendChild(d.getDoc().createTextNode(c.extInstanceUrl));a.appendChild(d.getDoc().createElement("ssoUserUrl")).appendChild(d.getDoc().createTextNode(c.userUrl));a.appendChild(d.getDoc().createElement("ssoCustomerKey")).appendChild(d.getDoc().createTextNode(c.clientId));a.appendChild(d.getDoc().createElement("ssoSecret")).appendChild(d.getDoc().createTextNode(c.secret));a.appendChild(d.getDoc().createElement("timezoneOffset")).appendChild(d.getDoc().createTextNode((new Date()).getTimezoneOffset()));a.appendChild(d.getDoc().createElement("refreshToken")).appendChild(d.getDoc().createTextNode(c.refreshToken));this.sendMsg({xml:d.xml(),callback:couple(this,"_handleLoginResponse")})};JabberConnection.prototype.login=function(e,n,d,g,c,l,a){this.log(LOG_DEBUG,"login: user: '"+e+"' passhash: '"+c+"' resource: '"+d+"'");this._resource=d||"CtlAgent";this._logoutUrl=g||location.href;this._logoutUrl=this._logoutUrl.replace(/(relogin|softlogout)=.*?(&|$)/g,"").replace(/\?$/,"");this._passhash=c;if(this.isAgent()){var f=/^([A-Za-z0-9_]+)\@([a-zA-Z0-9\-\.]+)$/.exec(e);if(!f||f.length<3){var m=new CtlEvent(EVENT_INVALID_LOGIN);this.handleEvent(m);return}this._login=f[1];this._tenant=f[2];var b=this._tenant.replace(/\./g,"_DOT_");this._user=this._login+"_at_"+b;this._pass=n}else{this._user=e;this._login=e;if(e=="admin"){this._tenant=":"+n;this._pass="admin"}else{this._tenant=e;this._pass=n}}var h=new JSJaCIQ();h.setIQ(null,null,"get","auth1");var k=h.setQuery("jabber:iq:auth");k.appendChild(h.getDoc().createElement("username")).appendChild(h.getDoc().createTextNode(this._user));k.appendChild(h.getDoc().createElement("resource")).appendChild(h.getDoc().createTextNode(this._resource));k.appendChild(h.getDoc().createElement("password")).appendChild(h.getDoc().createTextNode(this._pass));k.appendChild(h.getDoc().createElement("browserinfo")).appendChild(h.getDoc().createTextNode(l));k.appendChild(h.getDoc().createElement("agentIP")).appendChild(h.getDoc().createTextNode(a));k.appendChild(h.getDoc().createElement("timezoneOffset")).appendChild(h.getDoc().createTextNode((new Date()).getTimezoneOffset()));this.sendMsg({xml:h.xml(),callback:couple(this,"_handleLoginResponse")})};JabberConnection.prototype.getLogin=function(){return this._login};JabberConnection.prototype.getTenant=function(){return this._tenant};JabberConnection.prototype.getTo=function(){return this._to};JabberConnection.prototype.getJid=function(){return this._jid};JabberConnection.prototype.getSessionId=function(){return this._sid};JabberConnection.prototype._handleLoginResponse=function(d){this.log(LOG_DEBUG,"_handleLoginResponse: received auth1 response");this.log(LOG_DETAIL,"_handleLoginResponse: responseText: "+escapeXml(d.responseText));var f=this._getXmlDocElem(d.responseText);var g=(f)?f.getElementsByTagName("iq")[0]:null;if(window.common&&common.getSessionStorageAfterLoginId){var h=this._login;if(f&&f.getElementsByTagName("agent_login_id")[0]){h=f.getElementsByTagName("agent_login_id")[0].childNodes[0].nodeValue}sessionStorage.setItem(common.getSessionStorageAfterLoginId(h+"@"+this._tenant),true)}if(f&&g&&g.nodeName=="iq"&&g.getAttribute("type")=="result"){this._sid=f.getAttribute("sid");this._ctVia=f.getAttribute("ctVia");this._pingTimeout=f.getAttribute("inactivity");this.log(LOG_INFO,"_handleLoginResponse: _sid: "+this._sid);this.log(LOG_INFO,"_handleLoginResponse: _ctVia: "+this._ctVia);this.log(LOG_INFO,"_handleLoginResponse: _pingFrequency: "+this._pingFrequency);this.log(LOG_INFO,"_handleLoginResponse: _pingTimeout: "+this._pingTimeout);this._pingTimeout*=1000;this._jid=g.getAttribute("to");var e=/^([A-Za-z0-9_]+)\@([a-zA-Z0-9\-\.]+)/.exec(this._jid);if(e&&e[2]){this._to=e[2]}var a=(f)?f.getElementsByTagName("oauth_user_internal_id")[0]:null;if(a){this._crm_user_internal_id=a.textContent}var k=(f)?f.getElementsByTagName("oauth_internal_token")[0]:null;if(k){this._passhash=k.textContent}var m=(f)?f.getElementsByTagName("agent_login_id")[0]:null;if(m){this._refreshUrl+="&agentLoginId="+m.textContent;this._login=m.textContent}var b=(f)?f.getElementsByTagName("oauth_login_id")[0]:null;if(b){this._oauth_login=b.textContent}if(this._refreshAfterLogin){this._pauseLoginProcess()}else{this._setStickyReason("login");this._completeLoginProcess()}}else{this.log(LOG_ERROR,"_handleLoginResponse: problem with login response");if(f&&f.getAttribute("type")=="error"){var c=f.firstChild;if(c.nodeType==3){c=this._getXmlDocElem(c.nodeValue)}var l;if(c&&c.nodeName=="error"){var n=c.getAttribute("code");if(n=="401"){if(c.getElementsByTagName("lock").length!=0){l=new CtlEvent(EVENT_AGENT_LOCKED,c)}else{if(c.getElementsByTagName("disabled").length!=0){l=new CtlEvent(EVENT_AGENT_DISABLED,c)}else{l=new CtlEvent(EVENT_INVALID_LOGIN)}}}else{if(n=="501"){l=new CtlEvent(EVENT_EXCEED_MAX_LOGIN_COUNT)}else{if(n=="502"){l=new CtlEvent(EVENT_AGENT_LOCKED,c)}}}}else{l=new CtlEvent(EVENT_INVALID_LOGIN)}this.handleEvent(l)}else{l=new CtlEvent(EVENT_UNKNOWN_ERROR);this.handleEvent(l)}}};JabberConnection.prototype._handleAjaxResponse=function(c){if(c.responseText){var b=this._getXmlDocElem(c.responseText);if(b&&b.nodeName=="failover"){var a=b.getAttribute("ctVia");if(a){this.log(LOG_DEBUG,"_handleAjaxResponse: failover notice received. updating ctVia to "+a);this._ctVia=a;Comet.cleanUp();this._setStickyReason("failover");this.createStickyConnection(couple(this,"_parseCometChunk"),couple(this,"_xdomainReconnect"))}}}};JabberConnection.prototype._pauseLoginProcess=function(){this.log(LOG_DETAIL,"_pauseLoginProcess: pausing current login process");Cookie.set(COOKIE_NAME,this._serializeConn(this._passhash));location.href=this._refreshUrl};JabberConnection.prototype._serializeConn=function(a){this.log(LOG_DETAIL,"_serializeConn: serializing connection information");var b;b="{";b+='  "host": "'+this._host+'",';b+='  "port": "'+this._port+'",';b+='  "login": "'+this._login+'",';b+='  "tenant": "'+this._tenant+'",';b+='  "resource": "'+this._resource+'",';b+='  "user": "'+this._user+'",';b+='  "pass": "'+a+'",';b+='  "pingFrequency": "'+this._pingFrequency+'",';b+='  "pingTimeout": "'+this._pingTimeout+'",';b+='  "to": "'+this._to+'",';b+='  "sid": "'+this._sid+'",';b+='  "ctVia": "'+this._ctVia+'",';b+='  "jid": "'+this._jid+'",';b+='  "oauthToken": "'+this._oauth_token+'",';b+='  "oauthLogin": "'+this._oauth_login+'",';b+='  "webserviceUrl": "'+this._webserviceUrl+'",';b+='  "verifyUrl": "'+this._ssoVerifyUrl+'",';b+='  "crmUserInternalId": "'+this._crm_user_internal_id+'",';b+='  "crmAccessToken": "'+this._crm_access_token+'",';b+='  "crmRefreshToken": "'+this._crm_refresh_token+'",';b+='  "crmInstanceUrl": "'+this._crm_instance_url+'",';b+='  "extSSOCrmType": "'+this._extSSOCrmType+'",';b+='  "extAccessToken": "'+this._extAccessToken+'",';b+='  "extRefreshToken": "'+this._extRefreshToken+'",';b+='  "extInstanceUrl": "'+this._extInstanceUrl+'",';b+='  "extVerifyUrl": "'+this._extVerifyUrl+'",';b+='  "externalAgentId": "'+this._externalAgentId+'",';b+='  "logoutUrl": "'+this._logoutUrl+'"';b+="}";return b};JabberConnection.prototype.resumeLoginProcess=function(){this.log(LOG_DETAIL,"resumeLoginProcess: resuming login process");this.log(LOG_ERROR,"resumeLoginProcess: rtapi cookie data: "+Cookie.get(COOKIE_NAME));var info=eval("("+Cookie.get(COOKIE_NAME)+")");if(info){this._host=info.host;this._port=info.port;this._login=info.login;this._tenant=info.tenant;this._resource=info.resource;this._user=info.user;this._pass=info.pass;this._passhash=info.pass;this._pingFrequency=info.pingFrequency;this._pingTimeout=info.pingTimeout;this._to=info.to;this._sid=info.sid;this._ctVia=info.ctVia;this._jid=info.jid;this._logoutUrl=info.logoutUrl;this._oauth_token=info.oauthToken;this._oauth_login=info.oauthLogin;this._crm_user_internal_id=info.crmUserInternalId;this._webserviceUrl=info.webserviceUrl;this._ssoVerifyUrl=info.verifyUrl;this._crm_access_token=info.crmAccessToken;this._crm_refresh_token=info.crmRefreshToken;this._crm_instance_url=info.crmInstanceUrl;this._extSSOCrmType=info.extSSOCrmType;this._extAccessToken=info.extAccessToken;this._externalAgentId=info.externalAgentId;this._extRefreshToken=info.extRefreshToken;this._extInstanceUrl=info.extInstanceUrl;this._extVerifyUrl=info.extVerifyUrl}else{this.log(LOG_ERROR,"resumeLoginProcess: login information not found, using data from CONFIG instead");this._host=CONFIG.CONN_HOST;this._port=CONFIG.CONN_PORT;this._login=CONFIG.CONN_LOGIN;this._tenant=CONFIG.CONN_TENANT;this._resource=CONFIG.CONN_RESOURCE;this._user=CONFIG.CONN_USER;this._pass=CONFIG.CONN_PASS;this._passhash=CONFIG.CONN_PASS;this._pingFrequency=CONFIG.LOCAL_PING_FREQUENCY;this._pingTimeout=CONFIG.CONN_PING_TIMEOUT;this._to=CONFIG.CONN_TO;this._sid=CONFIG.CONN_SID;this._ctVia=CONFIG.CONN_CT_VIA;this._jid=CONFIG.CONN_JID;this._logoutUrl=CONFIG.CONN_LOGOUT_URL}this.log(LOG_ERROR,"resumeLoginProcess: this._host: "+this._host);this.log(LOG_ERROR,"resumeLoginProcess: this._port: "+this._port);this.log(LOG_ERROR,"resumeLoginProcess: this._login: "+this._login);this.log(LOG_ERROR,"resumeLoginProcess: this._tenant: "+this._tenant);this.log(LOG_ERROR,"resumeLoginProcess: this._resource: "+this._resource);this.log(LOG_ERROR,"resumeLoginProcess: this._user: "+this._user);this.log(LOG_ERROR,"resumeLoginProcess: this._pass: "+this._pass);this.log(LOG_ERROR,"resumeLoginProcess: this._pingFrequency: "+this._pingFrequency);this.log(LOG_ERROR,"resumeLoginProcess: this._pingTimeout: "+this._pingTimeout);this.log(LOG_ERROR,"resumeLoginProcess: this._to: "+this._to);this.log(LOG_ERROR,"resumeLoginProcess: this._sid: "+this._sid);this.log(LOG_ERROR,"resumeLoginProcess: this._ctVia: "+this._ctVia);this.log(LOG_ERROR,"resumeLoginProcess: this._jid: "+this._jid);this.log(LOG_ERROR,"resumeLoginProcess: this._logoutUrl: "+this._logoutUrl);this._setStickyReason("login");this._completeLoginProcess()};JabberConnection.prototype._completeLoginProcess=function(){if(!this._isStickyConnected&&this._retryStickyCount<this._maxRetryStickyAtLogin){this._retryStickyCount++;this._lastMessageLen=-1;this.createStickyConnection(couple(this,"_parseCometChunk"),couple(this,"_xdomainReconnect"));setTimeout(couple(this,"_completeLoginProcess"),this._retryStickyPeriod)}else{this.log(LOG_ERROR,"retry Sticky Connection stopped because sticky connection status ["+this._isStickyConnected+"] and retry count is ["+this._retryStickyCount+"] against max ["+this._maxRetryStickyAtLogin+"]");if(!this._isStickyConnected){var a=new CtlEvent(EVENT_EXCEED_MAX_RETRY_STICKY_CONNECTION);this.handleEvent(a)}}};JabberConnection.prototype._stickyEstablished=function(){var a=new CtlEvent(EVENT_LOGIN_COMPLETED);this.handleEvent(a);this.startKeepAlive();setTimeout(couple(this,"_clearCookieDetails"),60000);this._executeSubscribedWaitStickyMethods()};JabberConnection.prototype._clearCookieDetails=function(){this.log(LOG_DETAIL,"cleaning up session cookie");Cookie.set(COOKIE_NAME,this._serializeConn(""))};JabberConnection.prototype.redirectToLogin=function(a){var b=[];if(a){b.push("relogin="+encodeURIComponent(this._login+"@"+this._tenant));b.push("softlogout="+encodeURIComponent(this._sid))}if(b.length>0){if(this._logoutUrl.indexOf("?")===-1){this._logoutUrl+="?"}else{this._logoutUrl.replace(/&$/,"");this._logoutUrl+="&"}this._logoutUrl+=b.join("&")}parent.location.href=this._logoutUrl};JabberConnection.prototype._parseIframeCometChunk=function(b){try{var a=this._getXmlDocElem(b);this._parseCometBody(a,b)}catch(c){this.log(LOG_ERROR,"_parseIframeCometChunk: error to parse chunk: "+c.message);this.log(LOG_ERROR,"_parseIframeCometChunk: "+escapeXml(b))}};JabberConnection.prototype._parseXDomainCometChunk=function(d){if(d){var n=this._lastMessageId;var l=d.lastIndexOf("</cometd>");var h;if(l>0){var h=d.substring(0,l+9);if(h!=d){this.log(LOG_DEBUG,"_parseXDomainCometChunk: stripped corrupted xml "+escapeXml(d.substring(l+9)));d=h}}h="<Document>"+d+"</Document>";try{var m=this._getXmlDocElem(h);if(m){var a=m.getElementsByTagName("cometd");var c=a.length;this._storeReceivedChunks(a);this._logXMLMessagesDelays(a);if(c>0){var k=n+1;if(c==1){k=0}for(;k<c;k++){var b=a[k];this._lastMessageId=k;var f=b.lastChild;this._parseCometBody(f,f.xml)}}}}catch(g){this.log(LOG_ERROR,"_parseXDomainCometChunk: error to parse chunk: "+g.message);this.log(LOG_ERROR,"_parseXDomainCometChunk: "+escapeXml(d))}}else{this.log(LOG_ERROR,"_parseXDomainCometChunk: xml is not defined")}};JabberConnection.prototype._parseCometBody=function(a,d){if(a){var g=a.firstChild;var c=null;if(g==null){this.log(LOG_WARN,"_parseCometBody: body's first child is null")}else{if(g.nodeName=="AgentSubStatus"){var e=g.getElementsByTagName("subStatus")[0].firstChild.nodeValue;if(e=="resumestopnew"){c=EVENT_SUB_STATE_RESPONSE_STOP_NEW_OFF}else{if(e=="stopnew"){c=EVENT_SUB_STATE_RESPONSE_STOP_NEW_ON}}}else{if(g.nodeName=="ping"){if(this._isStickyConnected==false){this._isStickyConnected=true;this._stickyEstablished()}}else{if(g.nodeName=="iq"){if(g.firstChild){if(g.firstChild.nodeName=="AgentInfo"){c=EVENT_AGENT_INFO}else{if(g.firstChild.nodeName=="MonitoringAgentList"){c=EVENT_MONITORING_AGENTLIST}else{if(g.firstChild.nodeName=="query"&&g.firstChild.firstChild.getAttribute("xmlns")=="contactual:client:agentinteractionlist"){c=EVENT_INTERACTION_RECOVERY}else{if(g.firstChild.nodeName=="query"&&g.firstChild.getAttribute("xmlns")=="jabber:iq:roster"){if(g.firstChild.firstChild&&g.firstChild.firstChild.getAttribute("subscription")=="remove"){c=EVENT_ROSTER_REMOVE}else{c=EVENT_ROSTER}}else{if(g.firstChild.nodeName=="query"&&g.firstChild.getAttribute("xmlns")=="contactual:client:statsinfo"){c=EVENT_AGENT_STATS_UPDATE}else{if(g.firstChild.nodeName=="query"&&g.firstChild.firstChild.nodeName=="CallLeg"){c=EVENT_CALL_STATUS_UPDATE}else{if(g.firstChild.nodeName=="query"&&g.firstChild.getAttribute("xmlns")=="contactual:client:interactionmsg"){c=EVENT_GENERIC_MESSAGE}else{if(g.firstChild.nodeName=="query"&&g.firstChild.getAttribute("xmlns")=="contactual:client:interaction"){if(g.firstChild.firstChild.getAttribute("type")=="phone"){if(g.firstChild.firstChild.getAttribute("status")=="assigned"&&g.firstChild.firstChild.getAttribute("agentInitiated")=="false"){c=EVENT_NEW_CALL}else{if(g.firstChild.firstChild.getAttribute("status")=="joined"){c=EVENT_MONITORING_CALL}else{c=EVENT_CALL_STATUS_UPDATE}}}else{if(g.firstChild.firstChild.getAttribute("type")=="chat"){if(g.firstChild.firstChild.getAttribute("status")=="assigned"&&g.firstChild.firstChild.getAttribute("agentInitiated")=="false"){c=EVENT_NEW_CHAT}else{c=EVENT_CHAT_STATUS_UPDATE}}else{if(g.firstChild.firstChild.getAttribute("type")=="email"){if(g.firstChild.firstChild.getAttribute("status")=="assigned"){c=EVENT_NEW_EMAIL}else{c=EVENT_EMAIL_STATUS_UPDATE}}}}}else{if(g.firstChild.nodeName=="StatsInfo"&&g.firstChild.getAttribute("xmlns")=="contactual:client:statsinfo"){c=EVENT_TENANT_SKILL_STATS_UPDATE;if(window.PageBus){window.PageBus.publish("com.contactual.rtapi.statsinfo",{message:d})}}else{if(g.firstChild.nodeName=="query"&&g.firstChild.getAttribute("xmlns")=="contactual:client:agentinfodata"){c=EVENT_AGENT_INFO_DATA}else{if(g.firstChild.nodeName=="query"&&g.firstChild.getAttribute("xmlns")=="contactual:vo:iq:roster"){c=EVENT_VO_ROSTERS_UPDATE}else{if(g.firstChild.nodeName=="query"&&g.firstChild.getAttribute("xmlns")=="contactual:vo:iq:presence"){c=EVENT_VO_ROSTER_PRESENCE_UPDATE}else{if(g.firstChild.nodeName=="query"&&g.firstChild.getAttribute("xmlns")=="contactual:vo:iq:chatMessage"){c=EVENT_VO_ROSTER_CHAT_MSG_RECEIVED}else{if(g.firstChild.nodeName=="query"&&g.firstChild.getAttribute("xmlns")=="contactual:vo:iq:chatActivity"){c=EVENT_VO_CHAT_TYPING}}}}}}}}}}}}}}}else{if(g.getAttribute("id")=="broadcast"&&(g.getAttribute("type")=="result"||g.getAttribute("type")=="error")){c=EVENT_BROADCAST_RESPONSE}}}else{if(g.nodeName=="presence"){var h=g.getAttribute("from");if(h&&sanitizeJid(h)==sanitizeJid(this._jid)){c=EVENT_AGENT_STATUS_UPDATE}else{var f=g.getAttribute("type");if(g.childNodes.length>0||(f&&f=="unavailable")){c=EVENT_ROSTER_UPDATE}else{}}}else{if(g.nodeName=="message"){if(g.getElementsByTagName("AgentStats").length>0){c=EVENT_AGENT_STATS_UPDATE}else{if(g.getElementsByTagName("AgentInfo").length>0){c=EVENT_AGENT_INFO_UPDATE}else{if(g.getElementsByTagName("Group").length>0){c=EVENT_GROUP_UPDATE}else{if(g.getElementsByTagName("Queue").length>0){c=EVENT_TENANT_SKILL_UPDATE}else{if(g.getElementsByTagName("Broadcast").length>0){c=EVENT_NOTICE}else{if(g.getElementsByTagName("ChatActivity").length>0){c=EVENT_CHAT_TYPING}else{if(g.getElementsByTagName("TranslationStatus").length>0){c=EVENT_CHAT_TRANSLATION_STATUS_UPDATE}else{if(g.getElementsByTagName("TranslationServiceError").length>0){c=EVENT_CHAT_TRANSLATION_SERVICE_ERROR}else{if(g.getElementsByTagName("CoBrowsingInvite").length>0){c=EVENT_CO_BROWSING_INVITE}else{if(g.getElementsByTagName("CoBrowsingInviteAccepted").length>0){c=EVENT_CO_BROWSING_INVITE_ACCEPTED}else{if(g.getElementsByTagName("CoBrowsingInviteRejected").length>0){c=EVENT_CO_BROWSING_INVITE_REJECTED}else{if(g.getElementsByTagName("CoBrowsingSessionStarted").length>0){c=EVENT_CO_BROWSING_SESSION_STARTED}else{if(g.getElementsByTagName("CoBrowsingSessionEnded").length>0){c=EVENT_CO_BROWSING_SESSION_ENDED}else{if(g.getElementsByTagName("CoBrowsingInstanceNotFound").length>0){c=EVENT_CO_BROWSING_INSTANCE_NOT_FOUND}else{if(g.getElementsByTagName("Interaction").length>0){c=EVENT_CHAT_MSG}else{if(g.getElementsByTagName("TenantInfo").length>0){this.log(LOG_DEBUG,"packet received for TenantInfo updation");c=EVENT_TENANT_INFO_UPDATE}else{if(g.getElementsByTagName("campaignStatus").length>0){this.log(LOG_DEBUG,"packet received for CampaignInfo updation");c=EVENT_CAMPAIGN_MONITORING_INFO_UPDATE}else{if(g.getElementsByTagName("campaignUpdate").length>0){this.log(LOG_ERROR,"packet received for Update Campaign");c=EVENT_CAMPAIGN_UPDATE}else{if(g.getElementsByTagName("PasswordPolicyUpdate").length>0){this.log(LOG_ERROR,"packet received for Update Password Policy");c=EVENT_PASSWORD_POLICY_UPDATE}else{if(g.getElementsByTagName("PasswordUpdate").length>0){this.log(LOG_ERROR,"packet received for Password Update response ");c=EVENT_PASSWORD_UPDATE_RESPONSE}else{if(g.getElementsByTagName("DialPlan").length>0){c=EVENT_DEFAULT_DIAL_PLAN_UPDATE}else{if(g.getElementsByTagName("AgentPhoneUpdate").length>0){c=EVENT_AGENT_PHONE_UPDATE}else{if(g.getElementsByTagName("AgentLineStatus").length>0){c=EVENT_MONITORING_AGENT_LINE_STATUS}}}}}}}}}}}}}}}}}}}}}}}}else{if(g.nodeName=="reload"){this.log(LOG_ERROR,"reload request recieved");this._disconnected=true;this._isReload=true;this._setStickyReason("reload");setTimeout(couple(this,"_reconnect"),500)}else{if(g.nodeName=="UpdateTasks"){c=EVENT_TASK_UPDATE}else{if(g.nodeName=="ConnectionCleanup"){c=EVENT_CONNECTION_CLEAN_UP}else{this.log(LOG_WARN,"_parseCometBody: unknown node: "+g.nodeName)}}}}}}}}}if(c){var b=new CtlEvent(c,g);this.handleEvent(b)}else{this.log(LOG_WARN,"_parseCometBody: no response handler found")}}};JabberConnection.prototype._parseCometChunk=function(b){this.log(LOG_DETAIL,"_parseCometChunk: xml: "+escapeXml(b));this._lastMessageReceived=new Date().getTime();this.log(LOG_ERROR,"last message received: "+this._lastMessageReceived);b=this._addJSInTimestamp(b);if(this._disconnected){this._disconnected=false;this._reconnectCount=0;if(this._isReload){this._isReload=false;var a=new CtlEvent(EVENT_RELOAD_RECONNECTED);this.handleEvent(a)}else{this._handleDisconectedResponse(b);var a=new CtlEvent(EVENT_RECONNECTED);this.handleEvent(a)}}if(this._xdr){this._parseXDomainCometChunk(b)}else{this._parseIframeCometChunk(b)}};JabberConnection.prototype.isAgent=function(){if(this._resource=="CtlAgent"){return true}else{return false}};JabberConnection.prototype._addMsgId=function(a){try{var c=this._getMsgId();a=a.replace(/<body /g,"<body msgId='"+c+"' ");this._logSendXMLMessageDelays(a)}catch(b){console.warn("Failed to add msgId to message",b)}return a};JabberConnection.prototype._getMsgId=function(){return"xxxxxxxxxx".replace(/[x]/g,function(a){return GUID_CHAR_LIST[Math.floor(Math.random()*GUID_CHAR_LIST.length)]})};JabberConnection.prototype._addJSOutTimestamp=function(a){try{a=a.replace(/<body /g,"<body timestamp-js-out='"+Date.now()+"' ")}catch(b){console.warn("Failed to add timestamp-js-out to message",b)}return a};JabberConnection.prototype._addJSInTimestamp=function(a){try{a=a.replace(/<body /g,"<body timestamp-js-in='"+Date.now()+"' ")}catch(b){console.warn("Failed to add timestamp-js-in to message",b)}return a};JabberConnection.prototype._wrapPacket=function(d,c,b){var a="<body";if(this._sid){a+=" sid='"+this._sid+"'"}else{a+=" to='"+this._to+"'"}if(c){a+=" agentid='"+c+"'"}if(b){a+=" customerid='"+b+"'"}a+=" xmlns='http://jabber.org/protocol/httpbind'";a+=">";a+=d;a+="</body>";return a};JabberConnection.prototype._getHost=function(){var c=[];if(this._sid){c.push(["sid",this._sid])}if(this._ctVia){c.push(["ctRoute",this._ctVia])}if(this._login){c.push(["login",this._login])}if(this._tenant){var b=null;this.log(LOG_DEBUG,"_getHost: "+this._tenant);if(this._tenant.match(/^.*_at_.*/)){b=this._tenant.replace(/^.*_at_/,"")}else{b=this._tenant}this.log(LOG_DEBUG,"_getHost: final tenant is "+b);c.push(["tenant",b])}if(this._oauth_login){c.push(["oauthlogin",encodeURIComponent(this._oauth_login)])}var a=c.map(function(d){return d.join("=")}).join("&");return this._host+(a&&"?"+a)};JabberConnection.prototype._getXmlDocElem=function(b){if(!b){this.log(LOG_ERROR,"_getXmlDocElem: data: "+b);return}var a=null;if(window.DOMParser){var c=new DOMParser();a=c.parseFromString(b,"text/xml")}else{if(window.ActiveXObject){a=XmlDocument.create();a.loadXML(b)}else{if(typeof(CtlHttpRequest)!="undefined"){domImp=new DOMImplementation();a=domImp.loadXML(b)}}}return a.documentElement};JabberConnection.prototype.getOauthToken=function(){return this._oauth_token};JabberConnection.prototype.getOauthLogin=function(){return this._oauth_login};JabberConnection.prototype.getCrmUserInternalId=function(){return this._crm_user_internal_id};JabberConnection.prototype.getWebserviceUrl=function(){return this._webserviceUrl};JabberConnection.prototype.getCrmAccessToken=function(){return this._crm_access_token};JabberConnection.prototype.getCrmRefreshToken=function(){return this._crm_refresh_token};JabberConnection.prototype.getCrmInstanceUrl=function(){return this._crm_instance_url};JabberConnection.prototype.getSSOVerifyUrl=function(){return this._ssoVerifyUrl};JabberConnection.prototype.getExtSSOCrmType=function(){return this._extSSOCrmType};JabberConnection.prototype._handleDisconectedResponse=function(c){var b=this._getXmlDocElem("<Document>"+c+"</Document>"),a=b.getElementsByTagName("body")[0];if(a&&a.getAttribute("type")=="error"){var d=b.getElementsByTagName("error")[0];if(d){this._handleDisconectedError(d)}}};JabberConnection.prototype._handleDisconectedError=function(c){var a=c.getAttribute("code");if(a=="401"){var b=new CtlEvent(EVENT_DISCONECTED_ERROR);this.handleEvent(b)}};function Client(a,b){var a=a||"Client";this._base=Base;this._base(a);if(b){this._conn=b;this._conn.addHighPriorityEventHandler(EVENT_AGENT_STATUS_UPDATE,couple(this,"handleStatusUpdate"));this._conn.addHighPriorityEventHandler(EVENT_AGENT_INFO,couple(this,"_handleAgentInfo"));this._conn.addHighPriorityEventHandler(EVENT_MONITORING_AGENTLIST,couple(this,"_handleMonitoringAgentList"))}this._agentId=null;this._label=null;this._agentMgrAddress=null;this._loginId=null;this._firstName=null;this._lastName=null;this._nickname=null;this._monitoringAgentList=new Array();this._accessRights=null;this._status=STATUS_LOGGED_OUT;this._statusStartTime=new Date().getTime();this._profile=null;this._resourceList=new Array();this._queues=null;this._sessions=new Array();this._isReLogin=null;this._postProcessingTimeout=0;this._lastAgentInfoReceivedTimestamp=0;this._receivedRoster=false}Client.prototype=new Base;Client.prototype.initFromXml=function(m){var b=m.getElementsByTagName("AgentInfo")[0];if(b){var a=b.getAttribute("id");if(a){this._agentId=a}var o=getNodeValueWithParentName(b,"label","AgentInfo");if(o){this._label=o}var p=getNodeValue(b,"agentMgrAddress");if(p){this._agentMgrAddress=p}var n=getNodeValueWithParentName(b,"LoginId","AgentInfo");if(n){this._loginId=n}var r=getNodeValueWithParentName(b,"FirstName","DisplayName");if(r){this._firstName=r}var s=getNodeValueWithParentName(b,"LastName","DisplayName");if(s){this._lastName=s}var l=getTextContentWithParentName(b,"Nickname","DisplayName");if(l!=null){this._nickname=l}var g=b.getElementsByTagName("AgentAccessRights")[0];if(g){this._accessRights={};var f=g.getElementsByTagName("param");for(var h=0;h<f.length;h++){var q=f[h].getAttribute("name");this._accessRights[q]=f[h].getAttribute("value")}}var d=b.getElementsByTagName("AgentProfile")[0];if(d){if(!this._profile){this._profile=new AgentProfile();this._profile._backgroundAgentInfoData=this._backgroundAgentInfoData}else{this.log(LOG_DETAIL,"initFromXml: updating exising agent profile")}this._profile.initFromXml(d)}var c=b.getElementsByTagName("Resource");c=Array.prototype.slice.call(c,0);c.sort(function(u,t){var w=u.getAttribute("id");var v=t.getAttribute("id");if(w>v){return 1}if(w<v){return -1}return 0});for(var h=0;h<c.length;h++){var e=this.getResource(c[h].getAttribute("id"));if(!e){if(c[h].getAttribute("type")=="phone"){e=new PhoneResource()}else{if(c[h].getAttribute("type")=="chat"){e=new ChatResource()}else{if(c[h].getAttribute("type")=="email"){e=new EmailResource()}}}this._resourceList.push(e)}else{this.log(LOG_DETAIL,"initFromXml: updating exising resource: "+c[h].getAttribute("id"))}e.initFromXml(c[h])}if(c&&c.length){this.generateInternalChatResources()}}if(this._status==STATUS_LOGGED_OUT){var k=m.getElementsByTagName("presence")[0];if(k){this.handleStatusUpdate(k)}}};Client.prototype.setMonitoringAgentList=function(b){var a=b.getElementsByTagName("MonitoringAgentList");if(a){var d=[];for(var c=0;c<a.length;c++){d[c]=getNodeValue(a[c],"MonitoringAgent")}if(d){this._monitoringAgentList=d}}};Client.prototype.requestAgentStatusChange=function(b,g,f,l,e){var d=new JSJaCPresence();var h=null;var a=null;var c=null;var k=this._getPresenceValues(b);d.setType(k.type);d.setPresence(k.presence,k.status,null,f,l,e);this.log(LOG_DEBUG,"requestAgentStatusChange: sendingRequest");this.log(LOG_DETAIL,"requestAgentStatusChange: xml: "+escapeXml(d.xml()));this._conn.sendMsg({xml:d.xml(),agentId:this._agentId,callback:g})};Client.prototype.handleStatusUpdate=function(f){var h=f.getAttribute("type");var l=getNodeValue(f,"show");var e=this._status;if(h=="unavailable"){this._isReLogin=f.getAttribute("isReLogin");this._status=STATUS_LOGGED_OUT;if(this._conn){this._conn.close()}}else{if(l=="away"){this._status=STATUS_ON_BREAK}else{var c=getNodeValue(f,"status");if(c=="work_offline"){this._status=STATUS_WORK_OFFLINE}else{if(c=="waiting_transact"){this._status=STATUS_WAITING_TRANSACT}else{if(c=="transact_offered"){this._status=STATUS_TRANSACT_OFFERED}else{if(c=="busy"){this._status=STATUS_BUSY}else{if(c=="post_process"){this._status=STATUS_POST_PROCESS}else{if(c=="direct_call"){this._status=STATUS_DIRECT_CALL}else{if(c=="on_email"){this._status=STATUS_ON_EMAIL}}}}}}}}}this._statusStartTime=new Date().getTime();var a=f.getElementsByTagName("properties")[0];if(a){var g=a.getElementsByTagName("property");var b=null;var k=null;for(var d=0;d<g.length;d++){b=getNodeValue(g[d],"name");k=getNodeValue(g[d],"value");if(b=="timeout"){this._postProcessingTimeout=k}}}if(this._status!=e){if(window.PageBus){window.PageBus.publish("com.contactual.rtapi.roster.item.status.changed",{key:this._agentId,fromInt:e,toInt:this._status})}}this.log(LOG_DEBUG,"handleStatusUpdate: updated agent status to: "+this._status)};Client.prototype.handleStatsUpdate=function(a){var c=a.getElementsByTagName("Stat");var e=c.length;var g=new Date().getTime();for(var b=0;b<e;b++){var d=c[b].getAttribute("name");var f=c[b].getAttribute("value");if(d=="statusdur"){this._statusStartTime=g-(f*1000)}else{if(d=="status"){if(f=="Unknown"){this._status=STATUS_LOGGED_OUT}else{if(f=="logged_out"){this._status=STATUS_LOGGED_OUT}else{if(f=="logged_in"){this._status=STATUS_ON_BREAK}else{if(f=="on_break"){this._status=STATUS_ON_BREAK}else{if(f=="waiting_transact"){this._status=STATUS_WAITING_TRANSACT}else{if(f=="work_offline"){this._status=STATUS_WORK_OFFLINE}else{if(f=="transact_offered"){this._status=STATUS_TRANSACT_OFFERED}else{if(f=="busy"){this._status=STATUS_BUSY}else{if(f=="post_process"){this._status=STATUS_POST_PROCESS}else{if(f=="direct_call"){this._status=STATUS_DIRECT_CALL}else{if(f=="on_email"){this._status=STATUS_ON_EMAIL}}}}}}}}}}}}}}};Client.prototype.shouldGetAgentInfo=function(){return(Date.now()-this._lastAgentInfoReceivedTimestamp)>=AGENT_INFO_REQUEST_MIN_INTERVAL_MILLIS};Client.prototype.requestAgentInfo=function(){if(this._conn._isStickyConnected){if(this.shouldGetAgentInfo()){var a=new JSJaCIQ();a.setIQ(this._conn.getTo(),null,"get",null);a.setQuery("contactual:client:agentinfo");this.log(LOG_DEBUG,"requestAgentInfo: sendingRequest");this.log(LOG_DETAIL,"requestAgentInfo: xml: "+escapeXml(a.xml()));this.log(LOG_ERROR,"RequestAgentInfo: sending request agent info message");this._conn.sendMsg({xml:a.xml(),agentId:this._agentId})}else{this.log(LOG_ERROR,"RequestAgentInfoInterval: AgentInfo data has been requested recently, bypassing the request")}}else{this.log(LOG_ERROR,"RequestAgentInfo: No Sticky connection established, subscribing request agent info to be called later");this._conn._subscribeWaitStickyMethod(this.requestAgentInfo.bind(this))}};Client.prototype._setLastAgentInfoReceivedTimestamp=function(){this.log(LOG_DETAIL,"_setLastAgentInfoReceivedTimestamp: save date reference for last agent info received");this._lastAgentInfoReceivedTimestamp=Date.now()};Client.prototype._handleAgentInfo=function(a){this._setLastAgentInfoReceivedTimestamp();this.initFromXml(a)};Client.prototype._updateAgentInfo=function(a){var b=a.getElementsByTagName("AgentInfo")[0];var c=b.getAttribute("id");if(c&&this.getAgentId()==c){this.initFromXml(a)}};Client.prototype._handleMonitoringAgentList=function(a){this.setMonitoringAgentList(a)};Client.prototype.requestVORosters=function(){var a=new JSJaCIQ();a.setIQ(this._conn.getTo(),null,"get",null);a.setQuery("contactual:vo:iq:roster");this.log(LOG_DEBUG,"requestAgentInfo: sendingRequest");this.log(LOG_DETAIL,"requestAgentInfo: xml: "+escapeXml(a.xml()));this._conn.sendMsg({xml:a.xml(),agentId:this._agentId})};Client.prototype.requestAgentInteractions=function(){var b=new JSJaCIQ();b.setIQ(this._conn.getTo(),null,"get",null);var a=b.setQuery("contactual:client:agentinteractionlist");a.setAttribute("agentId",this._agentId);this.log(LOG_DEBUG,"requestAgentInteractions: sendingRequest");this.log(LOG_DETAIL,"requestAgentInteractions: xml: "+escapeXml(b.xml()));this._conn.sendMsg({xml:b.xml()})};Client.prototype.startTenantSkillStatsPolling=function(a){this._conn.startTenantSkillStatsPolling(this.normalizeTenantSkillStatsType(a))};Client.prototype.stopTenantSkillStatsPolling=function(a){this._conn.stopTenantSkillStatsPolling(this.normalizeTenantSkillStatsType(a))};Client.prototype.normalizeTenantSkillStatsType=function(a){if(a==="phone"){return"inbound_phone"}return a};Client.prototype.isTenantSkillStatsUpToDate=function(a){return this._conn.isTenantSkillStatsUpToDate(this.normalizeTenantSkillStatsType(a))};Client.prototype.getAgentProfile=function(){return this._profile};Client.prototype._getPresenceValues=function(c){var a=null;var d=null;var b=null;switch(c){case STATUS_ON_BREAK:d="available";b="away";break;case STATUS_WAITING_TRANSACT:d="available";b="chat";a="waiting_transact";break;case STATUS_WORK_OFFLINE:d="available";b="chat";a="work_offline";break;case STATUS_TRANSACT_OFFERED:d="available";b="chat";a="transact_offered";break;case STATUS_BUSY:d="available";b="chat";a="busy";break;case STATUS_POST_PROCESS:d="available";b="chat";a="post_process";break;default:d="unavailable";b="xa";break}return{status:a,type:d,presence:b}};Client.prototype.getAgentId=function(){return this._agentId};Client.prototype.getFirstName=function(){return this._firstName};Client.prototype.getLastName=function(){return this._lastName};Client.prototype.getDisplayName=function(){return this._firstName+" "+this._lastName};Client.prototype.getNickname=function(){return this._nickname};Client.prototype.getMonitoringAgentList=function(){return this._monitoringAgentList};Client.prototype.getAccessRight=function(a){if(this._accessRights){return this._accessRights[a]||""}else{return""}};Client.prototype.getLabel=function(){return this._label};Client.prototype.getAgsAddress=function(){return this._agentMgrAddress};Client.prototype.getStatus=function(){return this._status};Client.prototype.getStatusStartTime=function(){return this._statusStartTime};Client.prototype.numResources=function(b){var c=0;for(var a=0;a<this._resourceList.length;a++){if(this._resourceList[a].getType()==b){c++}}return c};Client.prototype.getResourceList=function(b){if(b){var c=new Array();for(var a=0;a<this._resourceList.length;a++){if(this._resourceList[a].getType()==b){c.push(this._resourceList[a])}}return c}else{return this._resourceList}};Client.prototype.getResource=function(b){for(var a=0;a<this._resourceList.length;a++){if(this._resourceList[a].getId()==b){return this._resourceList[a]}}};Client.prototype.findAvailableResource=function(b){var c=null;var d=this.getResourceList(b);for(var a=0;a<d.length;a++){if(!this.getSessionByResourceId(d[a].getId())){c=d[a];break}}return c};Client.prototype.getSessions=function(){return this._sessions};Client.prototype.getSessionsByType=function(b){var c=new Array();for(var a=0;a<this._sessions.length;a++){if(this._sessions[a].getType()==b){c.push(this._sessions[a])}}return c};Client.prototype.getSessionById=function(a){for(var b=0;b<this._sessions.length;b++){if(this._sessions[b].getSid().toString()==a.toString()){return this._sessions[b]}}};Client.prototype.getSessionByInteractionId=function(b){for(var a=0;a<this._sessions.length;a++){if(this._sessions[a].getInteraction().getId()==b.toString()){return this._sessions[a]}}};Client.prototype.getInteractionByInteractionId=function(b){var a=this.getSessionByInteractionId(b);if(a){return a.getInteraction()}};Client.prototype.getSessionByTransactionId=function(b){for(var a=0;a<this._sessions.length;a++){if(this._sessions[a].getInteraction().getTransactionId()==b.toString()){return this._sessions[a]}}};Client.prototype.getSessionByResourceId=function(b){for(var a=0;a<this._sessions.length;a++){if(this._sessions[a].getInteraction().getResourceId().toString()==b.toString()){return this._sessions[a]}}};Client.prototype.deleteSession=function(d){for(var b=0;b<this._sessions.length;b++){var c=this._sessions[b];var a=c&&c.getInteraction();var e=a&&a.getId();if(String(e)===String(d)){this._sessions.splice(b,1);break}}};Client.prototype.deleteSessionByResourceId=function(e){for(var b=0;b<this._sessions.length;b++){var c=this._sessions[b];var a=c&&c.getInteraction();var d=a&&a.getResourceId();if(String(d)===String(e)){this._sessions.splice(b,1);break}}};Client.prototype.transactionOffered=function(){return this._sessions.find(function(a){return(a.getInteraction().getStatus()=="assigned")})};Client.prototype._cleanMessage=function(a){a=escapeXml(a);a=a.replace(/\n/g,"<br />");return a};Client.prototype.getPostProcessingTimeout=function(){return this._postProcessingTimeout};function Guest(a){this._base=Client;this._base("Guest",a);this._conn.addHighPriorityEventHandler(EVENT_AGENT_STATUS_UPDATE,couple(this,"handleStatusUpdate"));this._conn.addHighPriorityEventHandler(EVENT_AGENT_INFO,couple(this,"_handleAgentInfo"));this._conn.addHighPriorityEventHandler(EVENT_AGENT_INFO_UPDATE,couple(this,"_updateAgentInfo"));this._conn.addHighPriorityEventHandler(EVENT_CALL_STATUS_UPDATE,couple(this,"_updatePhoneSession"));this._conn.addHighPriorityEventHandler(EVENT_CHAT_STATUS_UPDATE,couple(this,"_updateChatSession"));this._conn.addHighPriorityEventHandler(EVENT_CHAT_MSG,couple(this,"_handleChatMessage"));this._conn.addHighPriorityEventHandler(EVENT_CHAT_TYPING,couple(this,"_handleChatActivity"));this._conn.addHighPriorityEventHandler(EVENT_CHAT_TRANSLATION_STATUS_UPDATE,couple(this,"_handleTranslationStatus"))}Guest.prototype=new Client;Guest.prototype.newPhoneSession=function(a,b,f,e){var c=this.getResourceList("phone")[0];if(c&&!this.getSessionByResourceId(c.getId())){var d=new PhoneSession(this._conn);d.sendMakeCallBack(a,b,f,c.getId(),e);this._sessions.push(d)}};Guest.prototype._updatePhoneSession=function(b){var d=b.getElementsByTagName("Resource")[0];var a=b.getElementsByTagName("Interaction")[0];var c=b.getElementsByTagName("CallLeg")[0];var e=null;if(d){e=this.getSessionByResourceId(d.getAttribute("id"))}else{if(a){e=this.getSessionByInteractionId(a.getAttribute("id"))}else{if(c){e=this.getSessionById(c.getAttribute("id"))}}}if(e){e.handleUpdate(b)}else{this.log(LOG_ERROR,"_updateCallSession: don't know what to do with this message")}};Guest.prototype.newChatSession=function(e,b,a,g,d,c){var f=new ChatSession(this._conn);f.sendMakeGuestChat(e,b,a,g,d,c);this._sessions.push(f)};Guest.prototype._updateChatSession=function(a){var b=this.getSessionByInteractionId(a.getElementsByTagName("Interaction")[0].getAttribute("id"));if(!b){var c=this.getSessionsByType("chat");if(c.length==1){b=c[0]}else{this.log(LOG_ERROR,"_updateChatSession: don't know what to do with this message. found "+c.length+" sessions")}}if(b){b.handleUpdate(a)}else{this.log(LOG_ERROR,"_updateChatSession: don't know what to do with this message")}};Guest.prototype._handleChatMessage=function(a){var b=this.getSessionByInteractionId(a.getElementsByTagName("Interaction")[0].getAttribute("id"));if(b){b.handleMessage(a)}};Guest.prototype._handleChatActivity=function(c){var a=c.getElementsByTagName("body")[0];var b=a.firstChild.nodeValue;var d=this.getSessionByInteractionId(b);if(d){d.handleActivity()}};Guest.prototype._handleTranslationStatus=function(b){var a=b.getAttribute("id");var c=this.getSessionByInteractionId(a);if(c){c.handleTranslation(b)}};function AgentGroup(){this._base=Base;this._base("AgentGroup");this._groupId=null;this._displayName=null;this._groupMember=true;this._groupSupervisor=true}AgentGroup.prototype=new Base;AgentGroup.prototype.initFromXml=function(a){this._groupId=a.getAttribute("id");this._displayName=getNodeValue(a,"DisplayName");var b=getNodeValue(a,"Permission");if(b){this._groupMember=(b.match(/agent/))?true:false;this._groupSupervisor=(b.match(/supervisor/))?true:false}};AgentGroup.prototype.getId=function(){return this._groupId};AgentGroup.prototype.getDisplayName=function(){return this._displayName};AgentGroup.prototype.isGroupMember=function(){return this._groupMember};AgentGroup.prototype.isGroupSupervisor=function(){return this._groupSupervisor};function AgentProfile(){this._base=Base;this._base("AgentProfile");this._profileId=null;this._tenant=null;this._profileState=null;this._group=null;this._supervisedGroups=null;this._permissions=null;this._phoneFrom=null;this._phoneDisplayName=null;this._chatFrom=null;this._chatDisplayName=null;this._emailDisplayName=null;this._emailFrom=null;this._notificationSound=null;this._externalUsername=null;this._externalPassword=null;this._isOptionMenuDisable=false;this._isAgentRecordingsEnabled=false;this._isAgentRejectEnabled=false;this._agentMaxConcurrentChats=1;this._chatMessageSound=null;this._chatMessageBrowserNotification=null;this._agentToAgentChatDisabledFlag=false;this._statusCodeList=null;this._transactionCodeList=null;this._requiredBeforeOutboundList=new Array();this._preRecordingList=new Array();this._dialRules=new Array();this._passwordPolicies=null;this._defaultDialPlan=null;this._callerId=null;this._recordingProperty="0";this._groupTransactionCodeMap={};this._queueTransactionCodeMap={};this._backgroundAgentInfoData={}}AgentProfile.prototype=new Base;AgentProfile.prototype.initFromXml=function(h){this._profileId=h.getAttribute("id");var r=getNodeValueWithParentName(h,"Permission","AgentProfile");if(r){this._permissions=r}var l=getNodeValueWithParentName(h,"ExternalUsername","AgentProfile");if(l){this._externalUsername=l}var d=getNodeValueWithParentName(h,"ExternalPassword","AgentProfile");if(d){this._externalPassword=d}try{var n=getNodeValueWithParentName(h,"Option_menu_disable","AgentProfile");if(n=="y"||n=="yes"){this._isOptionMenuDisable=true}else{this._isOptionMenuDisable=false}}catch(A){Logger.log("rtapi",LOG_ERROR,"Option_menu_disable not found. message["+A.message+"]")}try{this._callerId=getNodeValueWithParentName(h,"CallerId","AgentProfile")}catch(A){Logger.log("rtapi",LOG_ERROR,"caller Id not found. message ["+A.message+"]")}try{var u=getNodeValueWithParentName(h,"RecordingProperty","AgentProfile");if(u){this._recordingProperty=u}}catch(A){Logger.log("rtapi",LOG_ERROR,"RecordingProperty not found. message ["+A.message+"]")}var f=h.getElementsByTagName("TenantInfo")[0];if(f){if(!this._tenant){this._tenant=new Tenant()}else{this.log(LOG_DETAIL,"initFromXml: updating existing tenant")}this._tenant.initFromXml(f);this._backgroundAgentInfoData=this._backgroundAgentInfoData||{};this._tenant.setSkills(this._backgroundAgentInfoData.skillsList,this._backgroundAgentInfoData.skillsMap)}var D=h.getElementsByTagName("Group");if(D.length>0){this._supervisedGroups=new Array();for(var z=0;z<D.length;z++){var q=new AgentGroup();q.initFromXml(D[z]);if(q.isGroupMember()){this._group=q}if(q.isGroupSupervisor()){this._supervisedGroups.push(q)}}}try{Logger.log("rtapi",LOG_DEBUG,"Started parsing SCLLists...");var g=h.getElementsByTagName("SCLLists");if(g){sclList=g[0];if(sclList){Logger.log("rtapi",LOG_ERROR,"Node &lt;SCLLists&gt; found");this._statusCodeList=new Array();for(var z=0;z<sclList.childNodes.length;z++){Logger.log("rtapi",LOG_ERROR,"SCLLists in for loop");var b=new AgentSCL();b.initFromXml(sclList.childNodes[z]);this._statusCodeList.push(b)}}}else{Logger.log("rtapi",LOG_ERROR,"No &lt;SCLLists&gt; tag found")}}catch(A){Logger.log("rtapi",LOG_ERROR,"SCLLists not found. message["+A.message+"]")}try{Logger.log("rtapi",LOG_DEBUG,"Started parsing TCLLists...");var p=h.getElementsByTagName("TCLLists")[0];if(p){var C=p.firstChild.nodeValue;C=C.replace(/\\\\/g,"\\");try{var y=JSON.parse(C);this._handleAgentInfoDataTCLsList(y)}catch(A){Logger.log("rtapi",LOG_ERROR,"Error while parsing agent info data. Error message ["+A.message+"]")}}}catch(A){Logger.log("rtapi",LOG_ERROR,"TCLLists not found. message["+A.message+"]")}try{Logger.log("rtapi",LOG_DEBUG,"Started parsing Recording Files list....");this._preRecordingList.splice(0,this._preRecordingList.length);var m=h.getElementsByTagName("Voice_recording_list")[0];if(m){Logger.log("rtapi",LOG_DEBUG,"Node &lt;Voice_recording_list&gt; found");for(var z=0;z<m.childNodes.length;z++){var c=new AgentPreRecording();c.initFromXml(m.childNodes[z]);this._preRecordingList.push(c)}}}catch(A){Logger.log("rtapi",LOG_ERROR,"Voice_recording_list not found. message["+A.message+"]")}try{Logger.log("rtapi",LOG_DEBUG,"Started parsing Dial Rules....");this._dialRules=new Array();var k=new DialRule();k.setDialRule(/[^0-9]/g,"");this._dialRules.push(k);var s=h.getElementsByTagName("DialRules")[0];if(s){var t=s.getElementsByTagName("Rule");if(t){for(var z=0;z<t.length;z++){k=new DialRule();k.initFromXml(t[z]);this._dialRules.push(k)}}}}catch(B){this.log(LOG_ERROR,"ERROR while parsing <DialRules> Node")}try{Logger.log("rtapi",LOG_DEBUG,"Started parsing Password Policies....");this._passwordPolicies=new PasswordPolicies();var o=h.getElementsByTagName("PasswordPolicies")[0];if(o){this._passwordPolicies.initFromXml(o)}}catch(B){this.log(LOG_ERROR,"ERROR while parsing <PasswordPolicies> Node")}var w=h.getElementsByTagName("PhoneProfile")[0];if(w){this._phoneFrom=getNodeValue(w,"From");this._phoneDisplayName=getNodeValue(w,"DisplayName")}var v=h.getElementsByTagName("ChatProfile")[0];if(v){this._chatFrom=getNodeValue(v,"From");this._chatDisplayName=getNodeValue(v,"DisplayName")}var E=h.getElementsByTagName("EmailProfile")[0];if(E){this._emailFrom=getNodeValue(E,"From");this._emailDisplayName=getNodeValue(E,"DisplayName")}var a=getNodeValue(h,"NotificationSound");if(a){this._notificationSound=a}var F=getNodeValue(h,"DialPlan");if(F){this._defaultDialPlan=F}};AgentProfile.prototype.getProfileId=function(){return this._profileId};AgentProfile.prototype.getTenant=function(){return this._tenant};AgentProfile.prototype.isProfileEnabled=function(){return this._profileState};AgentProfile.prototype.getGroups=function(){var a=this._supervisedGroups.clone();var b=this._group.getId();var c=a.find(function(d){return d.getId()==b});if(!c){a.unshift(this._group)}else{c._groupMember=true}return a};AgentProfile.prototype.getSupervisedGroups=function(){return this._supervisedGroups};AgentProfile.prototype.getGroup=function(b){if(b){var a=this.getGroups().find(function(c){return c.getId()==b});return a}else{return this._group}};AgentProfile.prototype.updateGroup=function(a){var c=a.getAttribute("id");var b=this.getGroup(c);if(b){b.initFromXml(a)}};AgentProfile.prototype.updateCampaignAudioFiles=function(g){var a=this._backgroundAgentInfoData.campaignList;this.log(LOG_DETAIL,"updateCampaignAudioFiles: updating campaign audio files list");try{var b=g.getElementsByTagName("campaign")[0];var m=b.getAttribute("id");if(a!=null&&a.length>0){var k=false;for(var n=0;n<a.length;n++){var d=a[n];this.log(LOG_DETAIL,"campaignId = "+m+".....campaign.getId() = "+d._campaignId);if(d._campaignId==m){k=true;var l=g.getElementsByTagName("AudioFile");if(l!=null&&l!=undefined){d._audioFiles=new Array();if(l.length>0){this.log(LOG_DETAIL,"listFiles.length = "+l.length);for(var e=0;e<l.length;e++){this.log(LOG_ERROR,"Started parsing for updating Campaign's Audio Files");var f=new CampaignAudioFile();f.initFromXml(l[e]);d._audioFiles.push(f)}}}try{var c=g.getElementsByTagName("AutoUpdate")[0];if(c!=null&&c!=undefined){d._autoUpdate_fieldId=c.getAttribute("CrmField");d._autoUpdate_fieldName=c.getAttribute("FieldName");d._autoUpdate_fieldType=c.getAttribute("FieldType");d._autoUpdate_valueId=c.getAttribute("UseValue")}var o=g.getElementsByTagName("DoNotCall")[0];if(o!=null&&o!=undefined){d._doNotCall_fieldId=o.getAttribute("CrmField");d._doNotCall_fieldName=o.getAttribute("FieldName");d._doNotCall_fieldType=o.getAttribute("FieldType");d._doNotCall_valueId=o.getAttribute("UseValue")}}catch(h){Logger.log("rtapi",LOG_ERROR,"Exception while parsing auto update and do not call attribute in Campaign Lists. message["+h.message+"]")}}}if(!k){this.log(LOG_DETAIL,"campaign not found...adding new campaign entry");var d=new AgentCampaign();d.initFromXml(b);a.push(d)}}}catch(h){Logger.log("rtapi",LOG_ERROR,"Exception while updating Audio Files for Campaign. message["+h.message+"]")}};AgentProfile.prototype.updatePasswordPolicy=function(a){this._passwordPolicies.initFromXml(a)};AgentProfile.prototype.updateDefaultDialPlan=function(b){this.log(LOG_DETAIL,"updateDefaultDialPlan: updating default dial plan");try{var a=getNodeValue(b,"DialPlan");if(a){this._defaultDialPlan=a}}catch(c){}};AgentProfile.prototype.getPermissions=function(){return this._permissions};AgentProfile.prototype.getCallerId=function(){return this._callerId};AgentProfile.prototype.setCallerId=function(a){this._callerId=a};AgentProfile.prototype.getPhoneFrom=function(){return this._phoneFrom};AgentProfile.prototype.getPhoneDisplayName=function(){return this._phoneDisplayName};AgentProfile.prototype.getChatFrom=function(){return this._chatFrom};AgentProfile.prototype.getChatDisplayName=function(){return this._chatDisplayName};AgentProfile.prototype.getEmailFrom=function(){return this._emailFrom};AgentProfile.prototype.getEmailDisplayName=function(){return this._emailDisplayName};AgentProfile.prototype.getNotificationSound=function(){return this._notificationSound};AgentProfile.prototype.getExternalUsername=function(){return this._externalUsername};AgentProfile.prototype.getExternalPassword=function(){return this._externalPassword};AgentProfile.prototype.getIsOptionMenuDisable=function(){return this._isOptionMenuDisable};AgentProfile.prototype.setIsOptionMenuDisable=function(a){this._isOptionMenuDisable=a};AgentProfile.prototype.getAgentRecordingsEnable=function(){return this._isAgentRecordingsEnable};AgentProfile.prototype.setAgentRecordingsEnable=function(a){this._isAgentRecordingsEnable=a};AgentProfile.prototype.getAgentRejectEnabled=function(){return this._isAgentRejectEnabled};AgentProfile.prototype.setAgentRejectEnabled=function(a){this._isAgentRejectEnabled=a};AgentProfile.prototype.getAgentMaxConcurrentChats=function(){return this._agentMaxConcurrentChats};AgentProfile.prototype.setAgentMaxConcurrentChats=function(a){this._agentMaxConcurrentChats=a};AgentProfile.prototype.getChatMessageSound=function(){return this._chatMessageSound};AgentProfile.prototype.setChatMessageSound=function(a){this._chatMessageSound=a};AgentProfile.prototype.getChatMessageBrowserNotification=function(){return this._chatMessageBrowserNotification};AgentProfile.prototype.setChatMessageBrowserNotification=function(a){this._chatMessageBrowserNotification=a};AgentProfile.prototype.getAgentToAgentChatDisabledFlag=function(){return this._agentToAgentChatDisabledFlag};AgentProfile.prototype.setAgentToAgentChatDisabledFlag=function(a){this._agentToAgentChatDisabledFlag=a};AgentProfile.prototype.getStatusCodeList=function(){return this._statusCodeList};AgentProfile.prototype.isReasonAvailableForState=function(e){if(this._statusCodeList!=null){for(var c=0;c<this._statusCodeList.length;c++){var b=this._statusCodeList[c];var d=b.getAllListItems();for(var a=0;a<d.length;a++){if(d[a].isStateAssociated(e)){return true}}}return false}else{return false}};AgentProfile.prototype.getTransactionCodeList=function(){return this._transactionCodeList};AgentProfile.prototype.getRequiredBeforeOutboundList=function(){return this._requiredBeforeOutboundList};AgentProfile.prototype.getPreRecordingList=function(){return this._preRecordingList};AgentProfile.prototype.getCampaignList=function(){return this._backgroundAgentInfoData.campaignList};AgentProfile.prototype.getDialRules=function(){return this._dialRules};AgentProfile.prototype.getPasswordPolicies=function(){return this._passwordPolicies};AgentProfile.prototype.getRecordingProperty=function(){return this._recordingProperty};AgentProfile.prototype.setRecordingProperty=function(a){this._recordingProperty=a};AgentProfile.prototype.replacePhoneNumber=function(a){if(this.getCallerId()==a.oldNumber){this.setCallerId(a.newNumber)}var b=this.getRequiredBeforeOutboundList();if(b){b.forEach(function(c){c.getAllListItems().forEach(function(d){if(d.getCallLineId()==a.oldNumber){d.setCallLineId(a.newNumber)}})})}};AgentProfile.prototype.getNewPreRecordingObj=function(){var a=new AgentPreRecording();return a};AgentProfile.prototype.sendAgProfileStatusChange=function(){};AgentProfile.prototype.translateTransactionItems=function(k){var f=this._requiredBeforeOutboundList,c=this._transactionCodeList;if(f!=null&&c!=null&&k!=null&&k!="N/A"){var o=k.split(",");var d="";var g="";var h="";var n="";var e="";for(i=0;i<o.length;i++){var m=o[i].replace(/^[ ]*/,"").replace(/[ ]*$/,"").split("|");if(m.length==2){if(f!=null){for(j=0;j<f.length;j++){if(f[j].getId()==m[0]){var b=f[j].getName()+":";h=f[j].getName();var a="("+m[1]+")";var l=f[j].getAllListItems();if(l!=null){for(x=0;x<l.length;x++){if(l[x].getId()==m[1]){a=l[x].getShortCodeText();e=a;n=l[x].getReportText();break}}}d+=(b+a+",");g+=(b+n+",");continue}}}if(c!=null){for(j=0;j<c.length;j++){if(c[j].getId()==m[0]){var b=c[j].getName()+":";h=c[j].getName();var a="("+m[1]+")";var l=c[j].getAllListItems();if(l!=null){for(x=0;x<l.length;x++){if(l[x].getId()==m[1]){a=l[x].getShortCodeText();e=a;n=l[x].getReportText();break}}}d+=(b+a+",");g+=(b+n+",");continue}}}}}var p=new Array();p[0]=d.replace(/,$/,"");p[1]=h;p[2]=n;p[3]=e;p[4]=g.replace(/,$/,"");return p}else{var p=new Array();p[0]=k;p[1]="";p[2]="";p[3]="";p[4]=k;return p}};AgentProfile.prototype.getDefaultDialPlan=function(a){return this._defaultDialPlan};AgentProfile.prototype.getCampaignName=function(campaignId){var campaignList=this._backgroundAgentInfoData.campaignList;if(campaignList!=null){for(var i=0;i<campaignList.length;i++){var campaign=campaignList[i];var campId=campaign.getId();var campName=campaign._campaignName;if(eval(campId)==eval(campaignId)&&campName!=null){return campName}}}return""};AgentProfile.prototype.getGroupTransactionCodeList=function(){var a=[];for(var b in this._groupTransactionCodeMap){if(this._groupTransactionCodeMap.hasOwnProperty(b)){a=a.concat(this._groupTransactionCodeMap[b])}}return a};AgentProfile.prototype.getQueueTransactionCodeMap=function(){return this._queueTransactionCodeMap};AgentProfile.prototype.setBackgroundAgentInfoData=function(a){this._backgroundAgentInfoData=a;this._tenant&&this._tenant.setSkills(a.skillsList,a.skillsMap)};AgentProfile.prototype._handleAgentInfoDataTCLsList=function(b){var c=null,d=null;this._groupTransactionCodeMap={};this._queueTransactionCodeMap={};this._requiredBeforeOutboundList=[];this._transactionCodeList=[];for(var a=0;a<b.length;a++){c=b[a];d=new AgentTCL();d.initFromObject(c);if(d.isrequiredBeforeOutbound()){if(d.isDefaultRBO()){this._requiredBeforeOutboundList.push(d)}}else{this._transactionCodeList.push(d);this._mapTransactionCode(d)}}};AgentProfile.prototype._mapTransactionCode=function(a){if(a.getAssignmentType()==="groups"){this._mapTransactionCodeAssignments(this._groupTransactionCodeMap,a)}else{this._mapTransactionCodeAssignments(this._queueTransactionCodeMap,a)}};AgentProfile.prototype._mapTransactionCodeAssignments=function(d,e){var c=e.getAssignmentsId()||[],a=null;for(var b=0;b<c.length;b++){a=c[b];d[a]=d[a]||[];d[a].push(e)}};function Session(b,a,c){var b=b||"Session";this._base=Base;this._base(b);this._type=a;this._conn=c;this._sid=null;this._interaction=null;this._initiatedEnd=false;this._recentActivity=false;this._intrMsgType=null;this._intrMsg=null;this._externalRecordInfo=null;this._terminateReason=null;this._coBrowsingSessionId=null}Session.prototype=new Base;Session.prototype.getInteractionMsgType=function(){return this._intrMsgType};Session.prototype.setInteractionMsgType=function(a){this._intrMsgType=a};Session.prototype.getInteractionMsg=function(){return this._intrMsg};Session.prototype.setInteractionMsg=function(a){this._intrMsg=a};Session.prototype.getType=function(){return this._type};Session.prototype.getSid=function(){return this._sid};Session.prototype.getInteraction=function(){return this._interaction};Session.prototype.agentInitiatedEnd=function(){return this._initiatedEnd};Session.prototype.hasRecentActivity=function(){return this._recentActivity};Session.prototype.setSid=function(a){this._sid=a};Session.prototype.setInteraction=function(a){this._interaction=a};Session.prototype.setTerminateReason=function(a){this._terminateReason=a};Session.prototype.getTerminateReason=function(){if(this._terminateReason){return this._terminateReason}return""};Session.prototype.recentActivityHandled=function(){this._recentActivity=false};Session.prototype.transferToTenantSkill=function(e){var c=new JSJaCIQ();c.setIQ(null,this._conn.getJid(),"set");var b=createElementWithNS(c,"query","contactual:client:interaction");var a=createElementWithNS(c,"Interaction","contactual:client:interaction");a.setAttribute("id",this._interaction.getId());a.setAttribute("status","forward");a.setAttribute("fwdtype","queue");a.setAttribute("type",this._type);var d=createElementWithNS(c,"TenantSkill","contactual:tenantskill");d.setAttribute("id",e);a.appendChild(d);b.appendChild(a);c.getNode().appendChild(b);this.log(LOG_DEBUG,"transferToTenantSkill: sendingRequest");this.log(LOG_DETAIL,"transferToTenantSkill: xml: "+escapeXml(c.xml()));this._conn.sendMsg({xml:c.xml()})};Session.prototype.transferToAgent=function(e){var d=new JSJaCIQ();d.setIQ(null,this._conn.getJid(),"set");var c=createElementWithNS(d,"query","contactual:client:interaction");var a=createElementWithNS(d,"Interaction","contactual:client:interaction");a.setAttribute("id",this._interaction.getId());a.setAttribute("status","forward");a.setAttribute("fwdtype","agent");a.setAttribute("type",this._type);var b=createElementWithNS(d,"AgentInfo","contactual:agentinfo");b.setAttribute("id",e);a.appendChild(b);c.appendChild(a);d.getNode().appendChild(c);this.log(LOG_DEBUG,"transferToAgent: sendingRequest");this.log(LOG_DETAIL,"transferToAgent: xml: "+escapeXml(d.xml()));this._conn.sendMsg({xml:d.xml()})};Session.prototype.transferToExternal=function(b){var d=new JSJaCIQ();d.setIQ(null,this._conn.getJid(),"set");var c=createElementWithNS(d,"query","contactual:client:interaction");var a=createElementWithNS(d,"Interaction","contactual:client:interaction");a.setAttribute("id",this._interaction.getId());a.setAttribute("status","forward");a.setAttribute("fwdtype","destnum");a.setAttribute("to",b);a.setAttribute("type",this._type);c.appendChild(a);d.getNode().appendChild(c);this.log(LOG_DEBUG,"transferToExternal: sendingRequest");this.log(LOG_DETAIL,"transferToExternal: xml: "+escapeXml(d.xml()));this._conn.sendMsg({xml:d.xml()})};Session.prototype.accept=function(){var e=new JSJaCIQ();e.setIQ(null,this._conn.getJid(),"set");var d=createElementWithNS(e,"query","contactual:client:interaction");var b=createElementWithNS(e,"Interaction","contactual:client:interaction");b.setAttribute("id",this._interaction.getId());b.setAttribute("status","accept");b.setAttribute("type",this._type);var c=createElementWithNS(e,"Resource","contactual:client:resource");c.setAttribute("id",this._interaction.getResourceId());b.appendChild(c);d.appendChild(b);e.getNode().appendChild(d);this.log(LOG_DEBUG,"accept: sendingRequest");this.log(LOG_DETAIL,"accept: xml: "+escapeXml(e.xml()));this._conn.sendMsg({xml:e.xml()});this.sendTCLCodes(this.getInteraction().getTransactionCodeList(),"","","","","","");var a=new CtlEvent(EVENT_INTERACTION_ACCEPTED,{interaction:b});this._conn.handleEvent(a)};Session.prototype.reject=function(h,c,e){var g=new JSJaCIQ();g.setIQ(null,this._conn.getJid(),"set");var f=createElementWithNS(g,"query","contactual:client:interaction");var b=createElementWithNS(g,"Interaction","contactual:client:interaction");b.setAttribute("id",this._interaction.getId());b.setAttribute("status","reject");b.setAttribute("type",this._type);f.appendChild(b);g.getNode().appendChild(f);if(c){var d=createElementWithNS(g,"SCL","contactual:client:interaction");d.setAttribute("id",c);d.setAttribute("item_id",h);d.setAttribute("shortcode",e);f.appendChild(d)}this.log(LOG_DEBUG,"reject: sendingRequest");this.log(LOG_DETAIL,"reject: xml: "+escapeXml(g.xml()));this._conn.sendMsg({xml:g.xml()});var a=new CtlEvent(EVENT_INTERACTION_REJECTED,{interaction:b});this._conn.handleEvent(a)};Session.prototype.end=function(d){d=d||{};var c=new JSJaCIQ();c.setIQ(null,this._conn.getJid(),"set");var b=createElementWithNS(c,"query","contactual:client:interaction");var a=createElementWithNS(c,"Interaction","contactual:client:interaction");a.setAttribute("id",this._interaction.getId());a.setAttribute("type",this._type);a.setAttribute("status","postprocess");a.setAttribute("type",this._type);b.appendChild(a);c.getNode().appendChild(b);this.log(LOG_DEBUG,"end: sendingRequest");this.log(LOG_DETAIL,"end: xml: "+escapeXml(c.xml()));this._conn.sendMsg({xml:c.xml(),sync:d.sync});this._initiatedEnd=true};Session.prototype.endPostProcessing=function(){var c=new JSJaCIQ();c.setIQ(null,this._conn.getJid(),"set");var b=createElementWithNS(c,"query","contactual:client:interaction");var a=createElementWithNS(c,"Interaction","contactual:client:interaction");a.setAttribute("id",this._interaction.getId());a.setAttribute("status","end");a.setAttribute("type",this._type);b.appendChild(a);c.getNode().appendChild(b);this.log(LOG_DEBUG,"endPostProcessing: sendingRequest");this.log(LOG_DETAIL,"endPostProcessing: xml: "+escapeXml(c.xml()));this._conn.sendMsg({xml:c.xml()})};Session.prototype.addUserData=function(k){try{Logger.log("rtapi",LOG_DEBUG,"in addUserData() ");var b=new JSJaCIQ();b.setIQ(null,this._conn.getJid(),"set");var c=createElementWithNS(b,"query","contactual:client:adduserdata");var f=createElementWithNS(b,"Interaction","contactual:client:interaction");var d=createElementWithNS(b,"UserData","contactual:client:userdata");f.setAttribute("id",this._interaction.getId());var g=null;for(g in k){var e=k[g];var h=createElementWithNS(b,"UserParam","contactual:client:userdata");h.setAttribute("name",g);h.setAttribute("value",e);d.appendChild(h)}f.appendChild(d);c.appendChild(f);b.getNode().appendChild(c);Logger.log("rtapi",LOG_DEBUG,"addUserData: sendingRequest");Logger.log("rtapi",LOG_DEBUG,"addUserData: xml: "+escapeXml(b.xml()));this._conn.sendMsg({xml:b.xml()})}catch(a){Logger.log("rtapi",LOG_ERROR,"addUserData: error while sending UserData packet. message["+a.message+"]")}};Session.prototype.sendTCLCodes=function(q,p,e,c,n,b,l){try{Logger.log("rtapi",LOG_DEBUG,"in sendTCLCodes() ");var k=new JSJaCIQ();k.setIQ(null,this._conn.getJid(),"set");var g=createElementWithNS(k,"query","contactual:client:tcl");var h=createElementWithNS(k,"Interaction","contactual:client:interaction");var r=createElementWithNS(k,"TCL","contactual:client:tcl");var z=createElementWithNS(k,"Notes","contactual:client:tcl");var m=createElementWithNS(k,"Callback","contactual:client:tcl");var o=createElementWithNS(k,"status","contactual:client:tcl");if(p!=null&&p!=undefined){z.setAttribute("description",p)}else{z.setAttribute("description","")}h.setAttribute("id",this._interaction.getId());if(this._interaction.isAnyRequired()){h.setAttribute("is_any_required","true")}else{h.setAttribute("is_any_required","false")}if(this._interaction.isAllRequiredSelected()){h.setAttribute("is_required_selected","true")}else{h.setAttribute("is_required_selected","false")}var t=false;for(var v=0;v<q.length;v++){var s=q[v].getAllListItems();if(s){var a=null;var d=false;for(var u=0;u<s.length;u++){if(s[u].isSelected()){if(d==false){a=createElementWithNS(k,"TCLList","contactual:client:tcl");a.setAttribute("id",q[v].getId());d=true}Logger.log("rtapi",LOG_DEBUG,"in sendTCLCodes(): in For 2: id["+s[u].getId()+"] shortcode["+s[u].getShortCodeText()+"]");var y=createElementWithNS(k,"Item","contactual:client:tcl");y.setAttribute("id",s[u].getId());y.setAttribute("shortcode",s[u].getShortCodeText());try{y.setAttribute("dispositionCode",s[u].getDispositionCode());if(s[u].getDispositionCode()=="1002"){t=true}}catch(w){y.setAttribute("dispositionCode","")}a.appendChild(y)}}}if(a){r.appendChild(a)}}if(!t){e=""}if(e!=null&&e!=undefined){m.setAttribute("time",e)}else{m.setAttribute("time","")}if(c==null||c==undefined){c=n=b=l=""}else{if(c==STATUS_ON_BREAK){c="away"}else{if(c==STATUS_WORK_OFFLINE){c="work_offline"}else{if(c==STATUS_WAITING_TRANSACT){c="waiting_transact"}}}}o.setAttribute("state",c);o.setAttribute("sclItemId",n);o.setAttribute("sclId",b);o.setAttribute("shortCode",l);h.appendChild(r);h.appendChild(z);h.appendChild(m);h.appendChild(o);g.appendChild(h);k.getNode().appendChild(g);Logger.log("rtapi",LOG_DEBUG,"sendTCLCodes: sendingRequest");Logger.log("rtapi",LOG_DEBUG,"sendTCLCodes: xml: "+escapeXml(k.xml()));this._conn.sendMsg({xml:k.xml()})}catch(f){Logger.log("rtapi",LOG_ERROR,"sendTCLCodes: error while creating TCL codes packet. message["+f.message+"]")}};Session.prototype.createReminder=function(d,e,c){try{Logger.log("rtapi",LOG_DEBUG,"in createReminder() ");var h=new JSJaCIQ();h.setIQ(null,this._conn.getJid(),"set");var g=createElementWithNS(h,"query","contactual:client:reminder");var b=createElementWithNS(h,"Reminders","contactual:client:reminders");var a=createElementWithNS(h,"Reminder","contactual:client:reminder");a.setAttribute("ServerOperation","Create");if(e!=null&&e!=undefined){a.setAttribute("Notes",e)}else{a.setAttribute("Notes","")}if(c!=null&&c!=undefined){a.setAttribute("ReminderTime",c)}else{a.setAttribute("ReminderTime","")}if(d!=null&&d!=undefined){a.setAttribute("CampaignRecordId",d)}else{a.setAttribute("CampaignRecordId","")}b.appendChild(a);g.appendChild(b);h.getNode().appendChild(g);Logger.log("rtapi",LOG_DEBUG,"createReminder: sendingRequest");Logger.log("rtapi",LOG_DEBUG,"createReminder: xml: "+escapeXml(h.xml()));this._conn.sendMsg({xml:h.xml()})}catch(f){Logger.log("rtapi",LOG_ERROR,"createReminder: error while add reminder. message["+f.message+"]")}};Session.prototype.updateReminder=function(a,l,f,h,k,m){try{Logger.log("rtapi",LOG_DEBUG,"in updateReminder() ");var e=new JSJaCIQ();e.setIQ(null,this._conn.getJid(),"set");var g=createElementWithNS(e,"query","contactual:client:reminder");var b=createElementWithNS(e,"Reminders","contactual:client:reminders");var d=createElementWithNS(e,"Reminder","contactual:client:reminder");d.setAttribute("ServerOperation","Update");if(a!=null&&a!=undefined){d.setAttribute("id",a)}else{d.setAttribute("id","")}if(f!=null&&f!=undefined){d.setAttribute("Notes",f)}else{d.setAttribute("Notes","")}if(h!=null&&h!=undefined){d.setAttribute("ReminderTime",h)}else{d.setAttribute("ReminderTime","")}if(k!=null&&k!=undefined){d.setAttribute("TargetAgent",k)}else{d.setAttribute("TargetAgent","")}if(m!=null&&m!=undefined){d.setAttribute("TargetAgentTimeZone",reminderTimeZone)}else{d.setAttribute("TargetAgentTimeZone","")}if(l!=null&&l!=undefined){d.setAttribute("CampaignRecordId",l)}else{d.setAttribute("CampaignRecordId","")}b.appendChild(d);g.appendChild(b);e.getNode().appendChild(g);Logger.log("rtapi",LOG_DEBUG,"updateReminder: sendingRequest");Logger.log("rtapi",LOG_DEBUG,"updateReminder: xml: "+escapeXml(e.xml()));this._conn.sendMsg({xml:e.xml()})}catch(c){Logger.log("rtapi",LOG_ERROR,"updateReminder: error while add reminder. message["+c.message+"]")}};Session.prototype.deleteReminder=function(f){try{Logger.log("rtapi",LOG_DEBUG,"in deleteReminder() ");var e=new JSJaCIQ();e.setIQ(null,this._conn.getJid(),"set");var d=createElementWithNS(e,"query","contactual:client:reminder");var b=createElementWithNS(e,"Reminders","contactual:client:reminders");var a=createElementWithNS(e,"Reminder","contactual:client:reminder");a.setAttribute("ServerOperation","Delete");if(f!=null&&f!=undefined){a.setAttribute("id",f)}else{a.setAttribute("id","")}b.appendChild(a);d.appendChild(b);e.getNode().appendChild(d);Logger.log("rtapi",LOG_DEBUG,"deleteReminder: sendingRequest");Logger.log("rtapi",LOG_DEBUG,"deleteReminder: xml: "+escapeXml(e.xml()));this._conn.sendMsg({xml:e.xml()})}catch(c){Logger.log("rtapi",LOG_ERROR,"deleteReminder: error while add reminder. message["+c.message+"]")}};Session.prototype.getExternalRecordInfo=function(){return this._externalRecordInfo};Session.prototype.setExternalRecordInfo=function(a){this._externalRecordInfo=a};Session.prototype.setCoBrowsingSessionId=function(a){this._coBrowsingSessionId=a};Session.prototype.getCoBrowsingSessionId=function(){return this._coBrowsingSessionId};Session.prototype.hasCoBrowsingSession=function(){return this._coBrowsingSessionId!=null};Session.prototype.sendCoBrowsingInvite=function(){this.log(LOG_DETAIL,"sendCoBrowsingInvite: sending co-browsing invite to target agent: "+this._interaction.getJid());var c=new JSJaCMessage();c.setType("chat");c.setXMLLang("en");c.setTo(this._interaction.getJid());c.setFrom(this._conn.getJid());c.setID(this._interaction.getId());var b=c.getDoc().createElement("CoBrowsingInvite");c.getNode().appendChild(b);this.log(LOG_DEBUG,"sendCoBrowsingInvite: sendingRequest");this.log(LOG_DETAIL,"sendCoBrowsingInvite: xml: "+escapeXml(c.xml()));this._conn.sendMsg({xml:c.xml()});var a=new CtlEvent(EVENT_CO_BROWSING_INVITE,c.getNode());this._conn.handleEvent(a)};Session.prototype.coBrowsingInviteAccepted=function(){this.log(LOG_DETAIL,"coBrowsingInviteAccepted: notifying co-browsing invite accepted to target agent: "+this._interaction.getJid());var b=new JSJaCMessage();b.setType("chat");b.setXMLLang("en");b.setTo(this._interaction.getJid());b.setFrom(this._conn.getJid());b.setID(this._interaction.getId());var c=b.getDoc().createElement("CoBrowsingInviteAccepted");b.getNode().appendChild(c);this.log(LOG_DEBUG,"coBrowsingInviteAccepted: sendingRequest");this.log(LOG_DETAIL,"coBrowsingInviteAccepted: xml: "+escapeXml(b.xml()));this._conn.sendMsg({xml:b.xml()});var a=new CtlEvent(EVENT_CO_BROWSING_INVITE_ACCEPTED,b.getNode());this._conn.handleEvent(a)};Session.prototype.coBrowsingInviteRejected=function(){this.log(LOG_DETAIL,"coBrowsingInviteRejected: notifying co-browsing invite rejected to target agent: "+this._interaction.getJid());var b=new JSJaCMessage();b.setType("chat");b.setXMLLang("en");b.setTo(this._interaction.getJid());b.setFrom(this._conn.getJid());b.setID(this._interaction.getId());var c=b.getDoc().createElement("CoBrowsingInviteRejected");b.getNode().appendChild(c);this.log(LOG_DEBUG,"coBrowsingInviteRejected: sendingRequest");this.log(LOG_DETAIL,"coBrowsingInviteRejected: xml: "+escapeXml(b.xml()));this._conn.sendMsg({xml:b.xml()});var a=new CtlEvent(EVENT_CO_BROWSING_INVITE_REJECTED,b.getNode());this._conn.handleEvent(a)};Session.prototype.coBrowsingSessionStarted=function(c){this.log(LOG_DETAIL,"coBrowsingSessionStarted: notifying co-browsing session start to target agent: "+this._interaction.getJid());var b=new JSJaCMessage();b.setType("chat");b.setXMLLang("en");b.setTo(this._interaction.getJid());b.setFrom(this._conn.getJid());b.setCDATABody(JSON.stringify(c));b.setID(this._interaction.getId());var d=b.getDoc().createElement("CoBrowsingSessionStarted");b.getNode().appendChild(d);this.log(LOG_DEBUG,"coBrowsingSessionStarted: sendingRequest");this.log(LOG_DETAIL,"coBrowsingSessionStarted: xml: "+escapeXml(b.xml()));this._conn.sendMsg({xml:b.xml()});var a=new CtlEvent(EVENT_CO_BROWSING_SESSION_STARTED,b.getNode());this._conn.handleEvent(a)};Session.prototype.coBrowsingSessionEnded=function(){this.log(LOG_DETAIL,"coBrowsingSessionEnded: notifying co-browsing session ended to target agent: "+this._interaction.getJid());var b=new JSJaCMessage();b.setType("chat");b.setXMLLang("en");b.setTo(this._interaction.getJid());b.setFrom(this._conn.getJid());b.setID(this._interaction.getId());var c=b.getDoc().createElement("CoBrowsingSessionEnded");b.getNode().appendChild(c);this.log(LOG_DEBUG,"coBrowsingSessionEnded: sendingRequest");this.log(LOG_DETAIL,"coBrowsingSessionEnded: xml: "+escapeXml(b.xml()));this._conn.sendMsg({xml:b.xml()});var a=new CtlEvent(EVENT_CO_BROWSING_SESSION_ENDED,b.getNode());this._conn.handleEvent(a)};Session.prototype.coBrowsingInstanceNotFound=function(){this.log(LOG_DETAIL,"coBrowsingInstanceNotFound: notifying co-browsing instance not found to target agent: "+this._interaction.getJid());var b=new JSJaCMessage();b.setType("chat");b.setXMLLang("en");b.setTo(this._interaction.getJid());b.setFrom(this._conn.getJid());b.setID(this._interaction.getId());var c=b.getDoc().createElement("CoBrowsingInstanceNotFound");b.getNode().appendChild(c);this.log(LOG_DEBUG,"coBrowsingInstanceNotFound: sendingRequest");this.log(LOG_DETAIL,"coBrowsingInstanceNotFound: xml: "+escapeXml(b.xml()));this._conn.sendMsg({xml:b.xml()});var a=new CtlEvent(EVENT_CO_BROWSING_INSTANCE_NOT_FOUND,b.getNode());this._conn.handleEvent(a)};var CHAT_LOG_AGENT="A";var CHAT_LOG_BOT="B";var FETCH_TIMELINE_TIMEOUT=5000;function ChatSession(a){this._base=Session;this._base("ChatSession","chat",a);this._isVOChat=false;this._chatLog="";this._plainChatLog="";this._newMessage=false;this._newActivity=false;this._deliverFlag=false;this._established=false;this._participantList=[];this._translationEnabled=false;this._hasTranslationAttribution=false;this._pendingMessageQueue=new Array()}ChatSession.prototype=new Session;ChatSession.isHandlingChatLogExternally=function(){return false};ChatSession.prototype.handleIncoming=function(a,c){this.log(LOG_DETAIL,"handleIncoming: incoming chat session for resource: "+c);var b=a.getElementsByTagName("AgentInfo")[0];this._interaction=new Interaction();this._interaction.initFromXml(a);this._interaction.setResourceId(c);this._setParticipantList(a);this._recentActivity=true};ChatSession.prototype.isSocial=function(){var a=this.getInteraction();return a&&(a.getUserData("twitterID")||a.getUserData("facebookPSID"))};ChatSession.prototype.sendMakeChat=function(b,a,e,f,l,g){this.log(LOG_DETAIL,"sendMakeChat: agentId: "+b);this.log(LOG_DETAIL,"sendMakeChat: jid: "+a);this.log(LOG_DETAIL,"sendMakeChat: profileId: "+e);this.log(LOG_DETAIL,"sendMakeChat: resourceId: "+f);this.log(LOG_DETAIL,"sendMakeChat: displayName: "+l);this._interaction=new Interaction();this._interaction.setJid(addResourceToJid(a));this._interaction.setResourceId(f);this._interaction.setAgentDisplayName(l);var h=new JSJaCIQ();h.setIQ(null,this._conn.getJid(),"set",null);var k=createElementWithNS(h,"query","contactual:client:interaction");var m=createElementWithNS(h,"Interaction","contactual:client:interaction");m.setAttribute("status","create");m.setAttribute("type","chat");m.setAttribute("to",b);m.setAttribute("destType","agent");var c=createElementWithNS(h,"AgentProfile","contactual:agentinfo");c.setAttribute("id",e);var d=createElementWithNS(h,"Resource","contactual:client:resource");d.setAttribute("id",f);m.appendChild(c);m.appendChild(d);k.appendChild(m);h.getNode().appendChild(k);this.log(LOG_DEBUG,"sendMakeChat: sendingRequest");this.log(LOG_DETAIL,"sendMakeChat: xml: "+escapeXml(h.xml()));this._conn.sendMsg({xml:h.xml()})};ChatSession.prototype.sendMakeGuestChat=function(p,n,c,l,m,d){this.log(LOG_DETAIL,"sendMakeGuestChat: queueLabel: "+p);this.log(LOG_DETAIL,"sendMakeGuestChat: referrer: "+n);this.log(LOG_DETAIL,"sendMakeGuestChat: prompt: "+c);this.log(LOG_DETAIL,"sendMakeGuestChat: ipaddress: "+m);this._interaction=new Interaction();var g=new JSJaCIQ();g.setIQ(null,this._conn.getJid(),"set",null);var q=createElementWithNS(g,"Interaction","contactual:client:interaction");q.setAttribute("status","create");q.setAttribute("type","chat");q.setAttribute("destType","callback");var b=g.getDoc().createElement("UserData");var a=g.getDoc().createElement("UserParam");a.setAttribute("name","referrer");a.setAttribute("value",n);b.appendChild(a);m=m||"";var k=g.getDoc().createElement("UserParam");k.setAttribute("name","ipaddress");k.setAttribute("value",m);b.appendChild(k);var o=g.getDoc().createElement("UserParam");o.setAttribute("name","timezoneOffset");o.setAttribute("value",(new Date()).getTimezoneOffset());b.appendChild(o);c=c.split("!)@(#*$&%^");for(var f=0;f<c.length;f++){var e=c[f].split("=");var h=g.getDoc().createElement("UserParam");h.setAttribute("name",e[0]);h.setAttribute("value",e[1]);b.appendChild(h)}if(l!=null&&l!=""){this.log(LOG_DETAIL,"sendMakeGuestChat: extTransactionData: "+l);var h=g.getDoc().createElement("UserParam");h.setAttribute("name","extTransactionData");h.setAttribute("value",l);b.appendChild(h)}if(d!=null&&d!=""){this.log(LOG_DETAIL,"sendMakeGuestChat: extTransactionDataID: "+d);var h=g.getDoc().createElement("UserParam");h.setAttribute("name","extTransactionDataID");h.setAttribute("value",d);b.appendChild(h)}var r=createElementWithNS(g,"TenantSkill","contactual:client:tenantskill");r.setAttribute("id",p);q.appendChild(b);q.appendChild(r);g.getNode().appendChild(q);this.log(LOG_DEBUG,"sendMakeGuestChat: sendingRequest");this.log(LOG_DETAIL,"sendMakeGuestChat: xml: "+escapeXml(g.xml()));this._conn.sendMsg({xml:g.xml()})};ChatSession.prototype.handleUpdate=function(c){var a=c.getElementsByTagName("Interaction")[0];this._interaction.setId(a.getAttribute("id"));this.log(LOG_DETAIL,"handleUpdate: received a chat session update for interation: "+a.getAttribute("id"));if(a.getAttribute("status")=="accepted"&&a.getAttribute("agentInitiated")=="true"){this.log(LOG_DETAIL,"handleUpdate: system has accepted our outgoing chat request. set our status to: pending");this._interaction.setStatus("pending");this._interaction.updateUserData(c)}else{if(a.getAttribute("status")=="assigned"&&a.getAttribute("agentInitiated")=="true"){this._interaction.updateUserData(c);this.log(LOG_DETAIL,"handleUpdate: system has assigned our outgoing chat request to the target agent. no action needed")}else{this.log(LOG_DETAIL,"handleUpdate: setting chat session status to: "+a.getAttribute("status"));this._interaction.setStatus(a.getAttribute("status"));if(a.getAttribute("status")=="accepted"){this._established=true;var f=c.getAttribute("to");var b=c.getElementsByTagName("InteractionParticipant");if(b.length==1){var e=getNodeValue(b[0],"jid");if(e!=f){this._interaction.setJid(getNodeValue(b[0],"jid"));this.log(LOG_DETAIL,"handleUpdate: found JID of agent: "+this._interaction.getJid())}}else{this.log(LOG_ERROR,"handleUpdate: attempting to get JID of agent, found "+b.length+" participants")}if(this._pendingMessageQueue.length>0){this.log(LOG_DETAIL,"handleUpdate: found "+this._pendingMessageQueue.length+" pending chat messages. sending...");for(var d=0;d<this._pendingMessageQueue.length;d++){this._deliverMessage(this._pendingMessageQueue[d])}this._pendingMessageQueue=new Array()}}}}this._setParticipantList(c);this._recentActivity=true};ChatSession.prototype._setParticipantList=function(d){this.log(LOG_DETAIL,"_setParticipantList: setting participant list for interaction: "+this._interaction.getId());var c=d.getElementsByTagName("InteractionParticipant");this._participantList.length=0;for(var f=0;f<c.length;f++){var a=c[f];var b=getNodeValue(a,"DisplayName");if(b.split(",").length===2){b=b.split(",").reverse().join(", ")}try{if(b.toLowerCase()=="anonymous"){b=CONFIG.ANONYMOUS}}catch(e){}this._participantList.push({displayName:b,nickname:getNodeValue(a,"Nickname"),type:getNodeValue(a,"type"),id:getNodeValue(a,"id"),initiator:getNodeValue(a,"initiator")=="true"})}};ChatSession.prototype.getParticipantList=function(){return this._participantList};ChatSession.prototype.sendMessage=function(d){if(this._interaction.getStatus()=="accepted"||this.isVOChat()){var b=this.processMessageContent(d);if(!this.isVOChat()){b="{html}"+b+"{/html}"}else{b=this.formatMessageToVO(d)}this._deliverMessage(b)}else{this.log(LOG_DETAIL,"sendMessage: chat session is not ready. Storing message in queue...");this._pendingMessageQueue.push(d)}if(!ChatSession.isHandlingChatLogExternally()){var c=this.processMessageContent(d);this._chatLog+="<div class='chat-outgoing-msg'>"+c+"</div>";this._plainChatLog+=CONFIG.AGENT+": "+d+"\n\n"}this.newMessage();this._deliverFlag=false;if(typeof(CtlPostMsgx)=="undefined"){var a=new CtlEvent(EVENT_CHAT_MSG);this._conn.handleEvent(a)}var a=new CtlEvent(EVENT_CHAT_OUTGOING_MSG,{session:this,message:c});this._conn.handleEvent(a)};ChatSession.prototype.sendActivity=function(){if((this._interaction.getStatus()=="accepted"||this.isVOChat())&&!this._deliverFlag){this._deliverFlag=true;this._deliverActivity("composing");setTimeout(couple(this,"clearDeliveryFlag"),5000)}};ChatSession.prototype.clearDeliveryFlag=function(){this._deliverFlag=false;if(this.isVOChat()){this._deliverActivity("paused")}};ChatSession.prototype.sendInformation=function(c){if(c==false){return}var b=c.map(function(d){return"<pair><key>"+escapeXml(d.key)+"</key><value>"+escapeXml(d.value)+"</value></pair>"});var a="<information-message>"+b.join("")+"</information-message>";if(this._interaction.getStatus()=="accepted"){this._deliverMessage(a)}else{this.log(LOG_DETAIL,"sendInformation: chat session is not ready. Storing message in queue...");this._pendingMessageQueue.push(a)}};ChatSession.prototype._deliverMessage=function(c){this.log(LOG_DETAIL,"_deliverMessage: sending chat message to target agent: "+this._interaction.getJid());var b=new JSJaCMessage();if(this.isVOChat()){b.setType("vochat")}else{b.setType("chat")}b.setXMLLang("en");b.setTo(this._interaction.getJid());b.setFrom(this._conn.getJid());b.setCDATABody(c);var a=b.getDoc().createElement("Interaction");a.setAttribute("id",this._interaction.getId());b.getNode().appendChild(a);this.log(LOG_DEBUG,"_deliverMessage: sendingRequest");this.log(LOG_DETAIL,"_deliverMessage: xml: "+escapeXml(b.xml()));this._conn.sendMsg({xml:b.xml()})};ChatSession.prototype._deliverActivity=function(b){this.log(LOG_DETAIL,"_deliverActivity: sending chat activity to target agent: "+this._interaction.getJid());var a=new JSJaCMessage();if(this.isVOChat()){a.setType("vochat")}else{a.setType("chat")}a.setXMLLang("en");a.setTo(this._interaction.getJid());a.setFrom(this._conn.getJid());a.setCDATABody(this._interaction.getId());var c=a.getDoc().createElement("ChatActivity");if(this.isVOChat()){if(!b||b==""){b="composing"}c.setAttribute("state",b)}a.getNode().appendChild(c);this.log(LOG_DEBUG,"_deliverActivity: sendingRequest");this.log(LOG_DETAIL,"_deliverActivity: xml: "+escapeXml(a.xml()));this._conn.sendMsg({xml:a.xml()})};ChatSession.prototype.toggleTranslation=function(c){this.log(LOG_DETAIL,"toggleTranslation: toggling chat translation to target agent: "+this._interaction.getJid());var b=new JSJaCMessage();b.setType("chat");b.setXMLLang("en");b.setTo(this._interaction.getJid());b.setFrom(this._conn.getJid());b.setCDATABody(""+!!c);b.setID(this._interaction.getId());var d=b.getDoc().createElement("TranslationStatus");b.getNode().appendChild(d);this.log(LOG_DEBUG,"toggleTranslation: sendingRequest");this.log(LOG_DETAIL,"toggleTranslation: xml: "+escapeXml(b.xml()));this._conn.sendMsg({xml:b.xml()});var a=new CtlEvent(EVENT_CHAT_TRANSLATION_STATUS_UPDATE,b.getNode());this._conn.handleEvent(a)};ChatSession.prototype.translationServiceError=function(){this.log(LOG_DETAIL,"translationServiceError: chat translation service error for target agent: "+this._interaction.getJid());var b=new JSJaCMessage();b.setType("chat");b.setXMLLang("en");b.setTo(this._interaction.getJid());b.setFrom(this._conn.getJid());b.setCDATABody(this._interaction.getId());var c=b.getDoc().createElement("TranslationServiceError");b.getNode().appendChild(c);this.log(LOG_DEBUG,"translationServiceError: sendingRequest");this.log(LOG_DETAIL,"translationServiceError: xml: "+escapeXml(b.xml()));this._conn.sendMsg({xml:b.xml()});var a=new CtlEvent(EVENT_CHAT_TRANSLATION_SERVICE_ERROR,{session:this});this._conn.handleEvent(a)};ChatSession.prototype.enableTranslation=function(){this.toggleTranslation(true)};ChatSession.prototype.disableTranslation=function(){this.toggleTranslation(false)};ChatSession.prototype.getXmlDoc=function(b){var a=null;if(window.DOMParser){if(navigator.appName=="Microsoft Internet Explorer"){b=b.replace(/\&nbsp;/g," ")}var c=new DOMParser();a=c.parseFromString(b,"text/xml")}else{if(window.ActiveXObject){a=new ActiveXObject("Microsoft.XMLDOM");a.async="false";a.loadXML(b)}}return a};ChatSession.prototype.handleVOMessage=function(b){this.log(LOG_DETAIL,"handleMessage: received a new chat message");var d=b.getElementsByTagName("Roster")[0];var e=d.getAttribute("message");var c=this.processMessageContent(e);if(!ChatSession.isHandlingChatLogExternally()){this._chatLog+="<div class='chat-incoming-msg'>"+c+"</div>";this._plainChatLog+=CONFIG.CUSTOMER+": "+c+"\n"}this._newMessage=true;var a=new CtlEvent(EVENT_CHAT_INCOMING_MSG,{session:this,message:c});this._conn.handleEvent(a)};ChatSession.prototype.handleMessage=function(c){this.log(LOG_DETAIL,"handleMessage: received a new chat message");if(window.DOMParser){c=(new DOMParser()).parseFromString((new XMLSerializer()).serializeToString(c),"text/xml")}var h=c.getElementsByTagName("body")[0];var a=this.getXmlDoc("<xml>"+h.firstChild.nodeValue+"</xml>");var m=a.getElementsByTagName("pair");var t=a.getElementsByTagName("ChatHistory");if(t.length){var f=t[0];var s=f.getAttribute("sessionId");if(s==null){this.setHasMoreMessages(false)}else{this.setLastFetchedSessionId(s);var g=Array.prototype.slice.call(f.childNodes,0);g.sort(function(A,z){var y=parseInt(A.getAttribute("messageTime"),10);var w=parseInt(z.getAttribute("messageTime"),10);if(y>w){return -1}else{if(y<w){return 1}else{return 0}}}).forEach(this.processTimelineChatMessage.bind(this))}this.fetchHistoryCallback()}else{if(m.length===0){var o=this.processMessageContent(h.firstChild.nodeValue);var d;var r=c.getElementsByTagName("IsBot");var p=r.length>0;if(p){d=r[0].textContent}var k=c.getElementsByTagName("agent");var b=k.length>0;if(b){d=k[0].textContent}if(!ChatSession.isHandlingChatLogExternally()){this._chatLog+="<div class='chat-incoming-msg'>"+o+"</div>";this._plainChatLog+=CONFIG.CUSTOMER+": "+h.firstChild.nodeValue+"\n"}this.newMessage();var l=new CtlEvent(EVENT_CHAT_INCOMING_MSG,{session:this,message:o,isBot:p,isAgent:b,displayName:d});this._conn.handleEvent(l)}else{var v=$A(m).collect(function(A){var w="",z;try{w=A.getElementsByTagName("key")[0].firstChild.nodeValue;z=A.getElementsByTagName("value")[0].firstChild.nodeValue}catch(y){z=""}return{key:w,value:z}});if(!ChatSession.isHandlingChatLogExternally()){var u="<div class='chat-incoming-info'>";var e="**"+$F("customer_info_msg_header")+"**\n";var n=null;for(var q=0;q<v.length;q++){n=v[q];u+="<div class='line'><div class='key'>"+n.key+"</div>";u+="<div class='value'>"+this.processMessageContent(n.value)+"</div></div>";e+=" * "+n.key+": "+n.value+"\n"}if(e.match(/^\{html\}.*\{\/html\}$/)){e=e.replace(/^\{html\}/,"").replace(/\{\/html\}$/,"")}e+="**"+$F("transcript_msg_header")+"**\n";this._chatLog+=u+"</div>";this._plainChatLog+=e+"\n"}this.newMessage();var l=new CtlEvent(EVENT_CHAT_INCOMING_INFO,{session:this,chatInfo:v});this._conn.handleEvent(l)}}};ChatSession.prototype.processTimelineChatMessage=function(c){var e=c.getElementsByTagName("message")[0];var f=this.processMessageContent(e.innerHTML||e.textContent);var g=(c.getAttribute("messageFrom")===CHAT_LOG_AGENT);var d=(c.getAttribute("messageFrom")===CHAT_LOG_BOT);var b=false;if(g){var h=c.getAttribute("participantID");b=h.split("~~")[1]||h}var a=new CtlEvent(EVENT_CHAT_INCOMING_MSG,{session:this,message:f,isPersisted:true,isAgent:g,isBot:d,displayName:b});this.newMessage();this._conn.handleEvent(a)};ChatSession.prototype.sendFetchHistory=function(d){this.log(LOG_DETAIL,"sendFetchHistory: "+this._interaction.getJid());if(this._isFetchingTimeline){return}clearTimeout(this._fetchHistoryTimeout);this.fetchHistoryCallback=this._fetchHistoryCallback.bind(this,d);this._fetchHistoryTimeout=setTimeout(this.fetchHistoryCallback,FETCH_TIMELINE_TIMEOUT);this._isFetchingTimeline=true;var b={lastFetchedSession:this.getLastFetchedSessionId()};var a=new JSJaCMessage();a.setXMLLang("en");a.setTo(this._interaction.getJid());a.setFrom(this._conn.getJid());a.setCDATABody(JSON.stringify(b));var c=a.getDoc().createElement("RequestHistory");a.getNode().appendChild(c);this.log(LOG_DEBUG,"sendFetchHistory: sendingRequest");this.log(LOG_DETAIL,"sendFetchHistory: xml: "+escapeXml(a.xml()));this._conn.sendMsg({xml:a.xml()})};ChatSession.prototype._fetchHistoryCallback=function(a){if(this._isFetchingTimeline){this._isFetchingTimeline=false;a()}};ChatSession.prototype.setHasMoreMessages=function(a){this._hasMoreMessages=a};ChatSession.prototype.getHasMoreMessages=function(a){return(this._hasMoreMessages===undefined)?true:this._hasMoreMessages};ChatSession.prototype.setLastFetchedSessionId=function(a){this._lastFetchedSessionId=a};ChatSession.prototype.getLastFetchedSessionId=function(){return this._lastFetchedSessionId||this.getInteraction().getId()};ChatSession.prototype.newMessage=function(){this._newMessage=true};ChatSession.prototype.hasNewMessage=function(){return this._newMessage};ChatSession.prototype.newMessageHandled=function(){this._newMessage=false};ChatSession.prototype.handleActivity=function(){this.log(LOG_DETAIL,"handleActivity: received a new chat activity");this._newActivity=true};ChatSession.prototype.hasNewActivity=function(){return this._newActivity};ChatSession.prototype.newActivityHandled=function(){this._newActivity=false};ChatSession.prototype.handleTranslation=function(b){this.log(LOG_DETAIL,"handleTranslation: received updated translation status");if(window.DOMParser){var a=b.getElementsByTagName("body")[0];var c=a.firstChild.nodeValue=="true";this.setTranslationEnabled(c)}};ChatSession.prototype.isTranslationEnabled=function(){return this._translationEnabled};ChatSession.prototype.setTranslationEnabled=function(a){this._translationEnabled=a};ChatSession.prototype.hasTranslationAttribution=function(){return this._hasTranslationAttribution};ChatSession.prototype.translationAttributionAdded=function(){return this._hasTranslationAttribution=true};ChatSession.prototype.getChatLog=function(){return this._chatLog};ChatSession.prototype.getPlainChatLog=function(){return this._plainChatLog};ChatSession.prototype.appendToChatLog=function(a){this._chatLog+=a;this._plainChatLog+="\n"+a.stripTags()};ChatSession.prototype.appendIncomingMessageToChatLog=function(d,b,c,e){var e=e||{};if(e.isPersisted){this._chatLog=d+this._chatLog}else{this._chatLog+=d}var a=b;if(c){a=a+"\n"+c+" "+CONFIG.CHAT_TRANSLATED_MESSAGE_LABEL}if(!e.isPersisted){this._plainChatLog+=((e.isBot)?CONFIG.BOT:CONFIG.CUSTOMER)+": "+a+"\n\n"}};ChatSession.prototype.appendOutgoingMessageToChatLog=function(d,b,c){var e=this.processMessageContent("{html}"+d+"{/html}");this._chatLog+="<div class='chat-outgoing-msg'>"+e+"</div>";var a=b;if(c){a=a+"\n"+c+" "+CONFIG.CHAT_TRANSLATED_MESSAGE_LABEL}this._plainChatLog+=CONFIG.AGENT+": "+a+"\n\n"};ChatSession.prototype.appendInfoMessageToChatLog=function(c,d,e){var a="<div class='chat-incoming-info'>"+c+"</div>";if(e){this._chatLog=a+this._chatLog}else{this._chatLog+=a}if(d.match(/^\{html\}.*\{\/html\}$/)){d=d.replace(/^\{html\}/,"").replace(/\{\/html\}$/,"")}var b="**"+$F("customer_info_msg_header")+"**\n"+d+"**"+$F("transcript_msg_header")+"**\n\n";if(e){this._plainChatLog=b+this._plainChatLog}else{this._plainChatLog+=b}};ChatSession.prototype.appendHighlightMessageToChatLog=function(a,b){this._chatLog+=a==null?"":"<div class='chat-highlight-msg'>"+a+"</div>";this._plainChatLog+=(b==null?a:b)+"\n\n"};ChatSession.prototype.appendSystemMessageToChatLog=function(a,b){this._chatLog+=a;this._plainChatLog+=b+"\n\n"};ChatSession.prototype.appendToPlainChatLog=function(a){this._plainChatLog+=a.stripTags()};ChatSession.prototype.clearChatLog=function(){this._chatLog="";this._plainChatLog=""};ChatSession.prototype.recover=function(a,c){this.log(LOG_DETAIL,"recover: recovering chat session for resource: "+c);this._interaction=new Interaction();this._interaction.initFromXml(a);this._interaction.setResourceId(c);var b=this._interaction.getUserData("guestSessionId");if(b){this._interaction.setJid(b)}this._setParticipantList(a);this.newMessage()};ChatSession.prototype.established=function(){return this._established};ChatSession.prototype.isVOChat=function(){return this._isVOChat};ChatSession.prototype.formatMessageToVO=function(c){var a=document.createElement("div");a.innerHTML=c;var b=a.textContent||a.innerText||"";return b};ChatSession.prototype.processMessageContent=function(b){var a;if(b.match(/^\{html\}.*\{\/html\}$/)){a=b.replace(/^\{html\}/,"").replace(/\{\/html\}$/,"");a=a.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">");a=a.replace(/\\\\/g,"\\")}else{a=b.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\t/g,"    ")}a=a.replace(/\{ctd\}(.*?),(.*?)\{\/ctd\}/g,"$1$2");a=a.replace(/[\{]+img[\}]+(.*?)[\{]+\/img[\}]+/g,"<div class='embedded_image'><img src='$1' class='embedded_image' /></div>");a=a.replace(/([^c][^=][^'])(https*:\/\/[^ <>]+)/g,"$1<a target='_new' href='$2'>$2</a>");a=a.replace(/^(|.|..)(https*:\/\/[^ <>]+)/g,"$1<a target='_new' href='$2'>$2</a>");return a};function EmailSession(a){this._base=Session;this._base("EmailSession","email",a)}EmailSession.prototype=new Session;EmailSession.prototype.handleIncoming=function(a,b){this._interaction=new Interaction();this._interaction.initFromXml(a);this._interaction.setResourceId(b);this._recentActivity=true};EmailSession.prototype.handleUpdate=function(a){this._interaction.initFromXml(a)};EmailSession.prototype.recover=function(a,b){this.log(LOG_DETAIL,"recover: recovering email session for resource: "+b);this._interaction=new Interaction();this._interaction.initFromXml(a);this._interaction.setResourceId(b)};function PhoneSession(a){this._base=Session;this._base("PhoneSession","phone",a);this._ani=null;this._fromDisplayName=null;this._dnis=null;this._toDisplayName=null;this._outbound=false;this._callState=null;this._conferenceStatus=null;this._conferenceId=null;this._recordingCall=false;this._participantList=new Array;this._resourceChanged=false;this._monitoring=false;this._hasSupervisorJoined=false;this._recordingStatus="N"}PhoneSession.prototype=new Session;PhoneSession.prototype.handleIncoming=function(a,b){this.log(LOG_DETAIL,"handleIncoming: incoming phone session for resource: "+b);this._callState=PHONE_SESSION_OFFERED;this._interaction=new Interaction();this._interaction.initFromXml(a);this._interaction.setResourceId(b);this._recentActivity=true;this._setParticipantList(a)};PhoneSession.prototype.handleMonitoring=function(a,b){this.log(LOG_DETAIL,"handleMonitoring: monitoring phone session for resource: "+b);this._callState=PHONE_SESSION_MONITORING;this._monitoring=true;this._interaction=new Interaction();this._interaction.initFromXml(a);this._interaction.setResourceId(b);this._interaction.updateUserData(a);this._setParticipantList(a);this._recentActivity=true};PhoneSession.prototype.isBeingRecorded=function(){return this._recordingCall};PhoneSession.prototype.getFromDisplayName=function(){return this._fromDisplayName};PhoneSession.prototype.getDnis=function(){return this._dnis};PhoneSession.prototype.getToDisplayName=function(){return this._toDisplayName};PhoneSession.prototype.getCallState=function(){return this._callState};PhoneSession.prototype.setCallState=function(a){this._callState=a};PhoneSession.prototype.getConferenceStatus=function(){return this._conferenceStatus};PhoneSession.prototype.accept=function(c){var e=new JSJaCIQ();e.setIQ(null,this._conn.getJid(),"set");var d=createElementWithNS(e,"query","contactual:client:interaction");var b=createElementWithNS(e,"Interaction","contactual:client:interaction");b.setAttribute("id",this._interaction.getId());var a=createElementWithNS(e,"phoneLine","contactual:client:phoneLine");a.setAttribute("lineNumber",c);a.setAttribute("status","accept");b.appendChild(a);d.appendChild(b);e.getNode().appendChild(d);this.log(LOG_DEBUG,"accept: sendingRequest");this.log(LOG_DETAIL,"accept: xml: "+escapeXml(e.xml()));this._conn.sendMsg({xml:e.xml()})};PhoneSession.prototype.startOutbound=function(b,g,c){this.log(LOG_DEBUG,"in startOutbound of phone_session.js");var f=new JSJaCIQ();f.setIQ(null,this._conn.getJid(),"set");var e=createElementWithNS(f,"query","contactual:client:interaction");var a=createElementWithNS(f,"Interaction","contactual:client:interaction");a.setAttribute("id",this._interaction.getId());a.setAttribute("queueDirection","out");a.setAttribute("status","start");a.setAttribute("type","phone");if(c!=null&&c!=""){a.setAttribute("phoneNumber",c)}var d=createElementWithNS(f,"Resource","contactual:client:resource");d.setAttribute("id",g);d.setAttribute("lineNumber",b);a.appendChild(d);e.appendChild(a);f.getNode().appendChild(e);this.log(LOG_DEBUG,"startOutbound: sendingRequest");this.log(LOG_DETAIL,"accept: xml: "+escapeXml(f.xml()));this._conn.sendMsg({xml:f.xml()})};Session.prototype.skipOutbound=function(h,c,e,a){this.log(LOG_DEBUG,"in skipOutbound of phone_session.js");var g=new JSJaCIQ();g.setIQ(null,this._conn.getJid(),"set");var f=createElementWithNS(g,"query","contactual:client:interaction");var b=createElementWithNS(g,"Interaction","contactual:client:interaction");b.setAttribute("id",this._interaction.getId());b.setAttribute("status","skip");b.setAttribute("queueDirection","out");b.setAttribute("type",this._type);f.appendChild(b);g.getNode().appendChild(f);if(c&&e){var d=createElementWithNS(g,"SCL","contactual:client:interaction");d.setAttribute("id",c);d.setAttribute("item_id",h);d.setAttribute("shortcode",e);d.setAttribute("dispositionCode",a);f.appendChild(d)}this.log(LOG_DEBUG,"skip: sendingRequest");this.log(LOG_DETAIL,"skip: xml: "+escapeXml(g.xml()));this._conn.sendMsg({xml:g.xml()})};Session.prototype.rejectOutbound=function(g,b,d){this.log(LOG_DEBUG,"in skipOutbound of phone_session.js");var f=new JSJaCIQ();f.setIQ(null,this._conn.getJid(),"set");var e=createElementWithNS(f,"query","contactual:client:interaction");var a=createElementWithNS(f,"Interaction","contactual:client:interaction");a.setAttribute("id",this._interaction.getId());a.setAttribute("status","reject");a.setAttribute("queueDirection","out");a.setAttribute("type",this._type);e.appendChild(a);f.getNode().appendChild(e);if(b&&g){var c=createElementWithNS(f,"SCL","contactual:client:interaction");c.setAttribute("id",b);c.setAttribute("item_id",g);c.setAttribute("shortcode",d);c.setAttribute("dispositionCode","");e.appendChild(c)}this.log(LOG_DEBUG,"reject: sendingRequest");this.log(LOG_DETAIL,"reject: xml: "+escapeXml(f.xml()));this._conn.sendMsg({xml:f.xml()})};PhoneSession.prototype.sendMakeCall=function(C,a,u,r,q,h,A,m,c,d,B,g,w,s){this.log(LOG_DETAIL,"sendMakeCall: target: "+C);this.log(LOG_DETAIL,"sendMakeCall: destType: "+a);this.log(LOG_DETAIL,"sendMakeCall: profileId: "+u);this.log(LOG_DETAIL,"sendMakeCall: resourceId: "+r);this.log(LOG_DETAIL,"sendMakeCall: line: "+q);this.log(LOG_DETAIL,"sendMakeCall: displayName: "+h);this.log(LOG_DETAIL,"sendMakeCall: TclListId: "+A);this.log(LOG_DETAIL,"sendMakeCall: TclItemId: "+m);this.log(LOG_DETAIL,"sendMakeCall: ShortCode: "+c);this.log(LOG_DETAIL,"sendMakeCall: CallingLineIdentifer: "+d);this.log(LOG_DETAIL,"sendMakeCall: QueueObjId: "+B);this._outbound=true;this._interaction=new Interaction();this._interaction.setResourceId(r);this._interaction.setAgentDisplayName(h);var l=new JSJaCIQ();l.setIQ(null,this._conn.getJid(),"set",null);var k=createElementWithNS(l,"Interaction","contactual:client:interaction");k.setAttribute("status","create");k.setAttribute("type","phone");k.setAttribute("to",C);k.setAttribute("destType",a);var e=createElementWithNS(l,"AgentProfile","contactual:agentinfo");e.setAttribute("id",u);k.appendChild(e);var b=createElementWithNS(l,"Resource","contactual:client:resource");b.setAttribute("id",r);b.setAttribute("lineNumber",q);k.appendChild(b);if(A!=""){var t=createElementWithNS(l,"TCL","contactual:client:tcl");t.setAttribute("id",A);t.setAttribute("item_id",m);t.setAttribute("shortcode",c);t.setAttribute("call_line_id",d);t.setAttribute("queue_obj_id",B);k.appendChild(t)}else{if(g&&g!=""){k.setAttribute("callerId",g)}}var o=l.getDoc().createElement("UserData");var z=l.getDoc().createElement("UserParam");z.setAttribute("name","ctl_transType");z.setAttribute("value","agentdial");o.appendChild(z);if(w&&w!=""){var n=l.getDoc().createElement("UserParam");n.setAttribute("name","extRecordId");n.setAttribute("value",w);o.appendChild(n);var f=agent.getSessionsByType("phone").length;if(f==1){var y=l.getDoc().createElement("UserParam");y.setAttribute("name","switchanddial");y.setAttribute("value",true);o.appendChild(y)}}if(s&&s!=""){var v=l.getDoc().createElement("UserParam");v.setAttribute("name","extRecordType");v.setAttribute("value",s);o.appendChild(v)}if(a==="agent"){var p=l.getDoc().createElement("UserParam");p.setAttribute("name","internal");p.setAttribute("value",true);o.appendChild(p)}k.appendChild(o);l.getNode().appendChild(k);this.log(LOG_DEBUG,"sendMakeCall: sendingRequest");this.log(LOG_DETAIL,"sendMakeCall: xml: "+escapeXml(l.xml()));this._conn.sendMsg({xml:l.xml()});this._callState=PHONE_SESSION_DIALING};PhoneSession.prototype.sendMakeCallBack=function(h,g,f,c,k){this.log(LOG_DETAIL,"sendMakeCallBack: displayName: "+h);this.log(LOG_DETAIL,"sendMakeCallBack: subject: "+g);this.log(LOG_DETAIL,"sendMakeCallBack: callbackNumber: "+f);this.log(LOG_DETAIL,"sendMakeCallBack: resourceId: "+c);this.log(LOG_DETAIL,"sendMakeCallBack: tenantSkillId: "+k);this._interaction=new Interaction();this._interaction.setResourceId(c);var e=new JSJaCIQ();e.setIQ(null,this._conn.getJid(),"set",null);var l=createElementWithNS(e,"Interaction","contactual:client:interaction");l.setAttribute("status","create");l.setAttribute("type","phone");l.setAttribute("to",f);l.setAttribute("destType","callback");var a=e.getDoc().createElement("UserData");var m=e.getDoc().createElement("UserParam");m.setAttribute("name","sub");m.setAttribute("value",g);var d=e.getDoc().createElement("UserParam");d.setAttribute("name","name");d.setAttribute("value",h);var b=createElementWithNS(e,"Resource","contactual:client:resource");b.setAttribute("id",c);var n=createElementWithNS(e,"TenantSkill","contactual:client:tenantskill");n.setAttribute("id",k);a.appendChild(m);a.appendChild(d);l.appendChild(a);l.appendChild(b);l.appendChild(n);e.getNode().appendChild(l);this.log(LOG_DEBUG,"sendMakeCallBack: sendingRequest");this.log(LOG_DETAIL,"sendMakeCallBack: xml: "+escapeXml(e.xml()));this._conn.sendMsg({xml:e.xml()})};PhoneSession.prototype.sendHold=function(c){var e=new JSJaCIQ();e.setIQ(null,this._conn.getJid(),"set",null);var d=createElementWithNS(e,"query","contactual:client:interaction");var b=createElementWithNS(e,"Interaction","contactual:client:interaction");b.setAttribute("id",this._interaction.getId());var a=createElementWithNS(e,"phoneLine","contactual:client:phoneLine");a.setAttribute("lineNumber",c);a.setAttribute("status","hold");b.appendChild(a);d.appendChild(b);e.getNode().appendChild(d);this.log(LOG_DEBUG,"sendHold: sendingRequest");this.log(LOG_DETAIL,"sendHold: xml: "+escapeXml(e.xml()));this._conn.sendMsg({xml:e.xml()});this._callState=PHONE_SESSION_HOLD};PhoneSession.prototype.sendHoldOff=function(c){var e=new JSJaCIQ();e.setIQ(null,this._conn.getJid(),"set",null);var d=createElementWithNS(e,"query","contactual:client:interaction");var b=createElementWithNS(e,"Interaction","contactual:client:interaction");b.setAttribute("id",this._interaction.getId());var a=createElementWithNS(e,"phoneLine","contactual:client:phoneLine");a.setAttribute("lineNumber",c);a.setAttribute("status","unhold");b.appendChild(a);d.appendChild(b);e.getNode().appendChild(d);this.log(LOG_DEBUG,"sendHoldOff: sendingRequest");this.log(LOG_DETAIL,"sendHoldOff: xml: "+escapeXml(e.xml()));this._conn.sendMsg({xml:e.xml()});this._callState=PHONE_SESSION_ACTIVE};PhoneSession.prototype.sendRecordCall=function(c){var e=new JSJaCIQ();e.setIQ(null,this._conn.getJid(),"set",null);var d=createElementWithNS(e,"query","contactual:client:interaction");var b=createElementWithNS(e,"Interaction","contactual:client:interaction");b.setAttribute("id",this._interaction.getId());var a=createElementWithNS(e,"phoneLine","contactual:client:phoneLine");a.setAttribute("lineNumber",c);a.setAttribute("status","record");b.appendChild(a);d.appendChild(b);e.getNode().appendChild(d);this.log(LOG_DEBUG,"sendRecordCall: sendingRequest");this.log(LOG_DETAIL,"sendRecordCall: xml: "+escapeXml(e.xml()));this._conn.sendMsg({xml:e.xml()});this._recordingCall=true};PhoneSession.prototype.sendMute=function(c){var e=new JSJaCIQ();e.setIQ(null,this._conn.getJid(),"set",null);var d=createElementWithNS(e,"query","contactual:client:interaction");var b=createElementWithNS(e,"Interaction","contactual:client:interaction");b.setAttribute("id",this._interaction.getId());var a=createElementWithNS(e,"phoneLine","contactual:client:phoneLine");a.setAttribute("lineNumber",c);a.setAttribute("status","mute");b.appendChild(a);d.appendChild(b);e.getNode().appendChild(d);this.log(LOG_DEBUG,"sendMute: sendingRequest");this.log(LOG_DETAIL,"sendMute: xml: "+escapeXml(e.xml()));this._conn.sendMsg({xml:e.xml()});this._callState=PHONE_SESSION_MUTE};PhoneSession.prototype.sendMuteOff=function(c){var e=new JSJaCIQ();e.setIQ(null,this._conn.getJid(),"set",null);var d=createElementWithNS(e,"query","contactual:client:interaction");var b=createElementWithNS(e,"Interaction","contactual:client:interaction");b.setAttribute("id",this._interaction.getId());var a=createElementWithNS(e,"phoneLine","contactual:client:phoneLine");a.setAttribute("lineNumber",c);a.setAttribute("status","unmute");b.appendChild(a);d.appendChild(b);e.getNode().appendChild(d);this.log(LOG_DEBUG,"sendMuteOff: sendingRequest");this.log(LOG_DETAIL,"sendMuteOff: xml: "+escapeXml(e.xml()));this._conn.sendMsg({xml:e.xml()});this._callState=PHONE_SESSION_ACTIVE};PhoneSession.prototype.sendMuteOffAndHold=function(c){var e=new JSJaCIQ();e.setIQ(null,this._conn.getJid(),"set",null);var d=createElementWithNS(e,"query","contactual:client:interaction");var b=createElementWithNS(e,"Interaction","contactual:client:interaction");b.setAttribute("id",this._interaction.getId());var a=createElementWithNS(e,"phoneLine","contactual:client:phoneLine");a.setAttribute("lineNumber",c);a.setAttribute("status","unmute_and_hold");b.appendChild(a);d.appendChild(b);e.getNode().appendChild(d);this.log(LOG_DEBUG,"sendMuteOffAndHold: sendingRequest");this.log(LOG_DETAIL,"sendMuteOffAndHold: xml: "+escapeXml(e.xml()));this._conn.sendMsg({xml:e.xml()});this._callState=PHONE_SESSION_HOLD};PhoneSession.prototype.sendHangUp=function(c){var f=new JSJaCIQ();f.setIQ(null,this._conn.getJid(),"set",null);var e=createElementWithNS(f,"query","contactual:client:interaction");var b=createElementWithNS(f,"Interaction","contactual:client:interaction");try{b.setAttribute("id",this._interaction.getId())}catch(d){b.setAttribute("id","")}var a=createElementWithNS(f,"phoneLine","contactual:client:phoneLine");a.setAttribute("lineNumber",c);a.setAttribute("status","hangup");b.appendChild(a);e.appendChild(b);f.getNode().appendChild(e);this.log(LOG_DEBUG,"sendHangUp: sendingRequest");this.log(LOG_DETAIL,"sendHangUp: xml: "+escapeXml(f.xml()));this._conn.sendMsg({xml:f.xml()})};PhoneSession.prototype.sendListenCall=function(a){};PhoneSession.prototype.sendJoinLines=function(e){var f=new JSJaCIQ();f.setIQ(null,this._conn.getJid(),"set",null);var d=createElementWithNS(f,"query","contactual:client:interaction");var b=createElementWithNS(f,"Interaction","contactual:client:interaction");b.setAttribute("id",this._interaction.getId());var a=createElementWithNS(f,"phoneLine","contactual:client:phoneLine");a.setAttribute("mergedInteractionGuid",e.getInteraction().getId());a.setAttribute("status","conference");b.appendChild(a);d.appendChild(b);f.getNode().appendChild(d);this.log(LOG_DEBUG,"sendJoinLines: sendingRequest");this.log(LOG_DETAIL,"sendJoinLines: xml: "+escapeXml(f.xml()));this._conn.sendMsg({xml:f.xml()});this._callState=PHONE_SESSION_ACTIVE;try{if(e.getRecordingStatus()=="R"){this.setRecordingStatus("R")}}catch(c){}};PhoneSession.prototype.sendTransferLines=function(d){var e=new JSJaCIQ();e.setIQ(null,this._conn.getJid(),"set",null);var c=createElementWithNS(e,"query","contactual:client:interaction");var b=createElementWithNS(e,"Interaction","contactual:client:interaction");b.setAttribute("id",this._interaction.getId());var a=createElementWithNS(e,"phoneLine","contactual:client:phoneLine");a.setAttribute("mergedInteractionGuid",d.getInteraction().getId());a.setAttribute("status","transfer");b.appendChild(a);c.appendChild(b);e.getNode().appendChild(c);this.log(LOG_DEBUG,"sendTransferLines: sendingRequest");this.log(LOG_DETAIL,"sendTransferLines: xml: "+escapeXml(e.xml()));this._conn.sendMsg({xml:e.xml()})};PhoneSession.prototype.blindTransferToAgent=function(f,c){var e=new JSJaCIQ();e.setIQ(null,this._conn.getJid(),"set",null);var d=createElementWithNS(e,"query","contactual:client:interaction");var b=createElementWithNS(e,"Interaction","contactual:client:interaction");b.setAttribute("id",this._interaction.getId());var a=createElementWithNS(e,"phoneLine","contactual:client:phoneLine");a.setAttribute("agentGuid",f);a.setAttribute("status","blind-transfer");b.appendChild(a);d.appendChild(b);e.getNode().appendChild(d);this.log(LOG_DEBUG,"blindTransferToAgent: sendingRequest");this.log(LOG_DETAIL,"blindTransferToAgent: xml: "+escapeXml(e.xml()));this._conn.sendMsg({xml:e.xml()})};PhoneSession.prototype.callPark=function(f,c){var e=new JSJaCIQ();e.setIQ(null,this._conn.getJid(),"set",null);var d=createElementWithNS(e,"query","contactual:client:interaction");var b=createElementWithNS(e,"Interaction","contactual:client:interaction");b.setAttribute("id",this._interaction.getId());var a=createElementWithNS(e,"phoneLine","contactual:client:phoneLine");a.setAttribute("agentGuid",f);a.setAttribute("status","blind-transfer");a.setAttribute("transferType","parkcall");b.appendChild(a);d.appendChild(b);e.getNode().appendChild(d);this.log(LOG_DEBUG,"blindTransferToAgent: sendingRequest");this.log(LOG_DETAIL,"blindTransferToAgent: xml: "+escapeXml(e.xml()));this._conn.sendMsg({xml:e.xml()})};PhoneSession.prototype.blindTransferToCustomer=function(e,d,a,h){var g=new JSJaCIQ();g.setIQ(null,this._conn.getJid(),"set",null);var f=createElementWithNS(g,"query","contactual:client:interaction");var c=createElementWithNS(g,"Interaction","contactual:client:interaction");c.setAttribute("id",this._interaction.getId());if(a=="voext"||a=="voextvmail"){d=d+"-"+h}var b=createElementWithNS(g,"phoneLine","contactual:client:phoneLine");b.setAttribute("agentGuid",d);b.setAttribute("status","blind-transfer");b.setAttribute("transferType",a);c.appendChild(b);f.appendChild(c);g.getNode().appendChild(f);this.log(LOG_DEBUG,"blindTransferToCustomer: sendingRequest");this.log(LOG_DETAIL,"blindTransferToCustomer: xml: "+escapeXml(g.xml()));this._conn.sendMsg({xml:g.xml()})};PhoneSession.prototype.transferToTenantSkill=function(g,c){var e=new JSJaCIQ();e.setIQ(null,this._conn.getJid(),"set");var d=createElementWithNS(e,"query","contactual:client:interaction");var b=createElementWithNS(e,"Interaction","contactual:client:interaction");b.setAttribute("id",this._interaction.getId());b.setAttribute("status","forward");b.setAttribute("fwdtype","queue");b.setAttribute("type",this._type);var f=createElementWithNS(e,"TenantSkill","contactual:tenantskill");f.setAttribute("id",g);var a=createElementWithNS(e,"phoneLine","contactual:client:phoneLine");a.setAttribute("lineNumber",c);b.appendChild(a);b.appendChild(f);d.appendChild(b);e.getNode().appendChild(d);this.log(LOG_DEBUG,"transferToTenantSkill: sendingRequest");this.log(LOG_DETAIL,"transferToTenantSkill: xml: "+escapeXml(e.xml()));this._conn.sendMsg({xml:e.xml()})};PhoneSession.prototype.handleUpdate=function(c){var e=c.getElementsByTagName("CallLeg")[0];var b=c.getElementsByTagName("Interaction")[0];var a;if(b&&b.getAttribute("status")){this._interaction.setStatus(b.getAttribute("status"));this.log(LOG_DETAIL,"handleUpdate: set interaction status to: "+this._interaction.getStatus())}this.log(LOG_DETAIL,"handleUpdate: received a phone session update");if(e){a=e.getAttribute("status");this.log(LOG_DETAIL,"handleUpdate: call leg status: "+a);if(this._callState==PHONE_SESSION_MONITORING){if(a=="supervisor-join"){this.log(LOG_DETAIL,"handleUpdate: found a session-join message for a monitoring session, updating to status to active.");this._callState=PHONE_SESSION_ACTIVE;this._monitoring=false;this._hasSupervisorJoined=true}else{this.log(LOG_DETAIL,"handleUpdate: found a call leg status update for a monitoring session, ignoring it.");return}}if(a=="proceeding"){if(this._outbound){this._callState=PHONE_SESSION_PROCEEDING}}else{if(a=="ringing"){if(this._click2dial){this._callState=PHONE_SESSION_OFFERED}else{if(this._outbound){this._callState=PHONE_SESSION_RINGING}else{if(this._interaction.getQueueDirection()=="out"){this._callState=PHONE_SESSION_RINGING}}}}else{if(a=="answered"){if(!this._outbound||this._interaction.getQueueDirection()=="out"){this._callState=PHONE_SESSION_ACTIVE}else{if(this._click2dial){this._callState=PHONE_SESSION_RINGING}}this._recentlyAnswered=true}else{if(a=="hold"){this._callState=PHONE_SESSION_HOLD}else{if(a=="mute"){this._callState=PHONE_SESSION_MUTE}else{if(a=="talk"){this._callState=PHONE_SESSION_ACTIVE}else{if(a=="hangup"){this.log(LOG_DEBUG,"handleUpdate: PHONE_SESSION_HUNG_UP discarded (will receive interaction/unassigned later)")}}}}}}}}else{if(b){a=b.getAttribute("status");this.log(LOG_DETAIL,"handleUpdate: interaction: "+b.getAttribute("id"));this.log(LOG_DETAIL,"handleUpdate: interaction status: "+a);if(a=="assigned"){this._interaction.initFromXml(c);this._callState=PHONE_SESSION_PROCEEDING}else{if(a=="accepted"){this._interaction.updateUserData(c);this._setParticipantList(c)}else{if(a=="destination-answered"){if(this._interaction.getQueueDirection()!="out"){this._callState=PHONE_SESSION_ACTIVE}else{this._callState=PHONE_SESSION_OUTBOUND_DIALER_DESTINATION_ANSWERED}this._recentlyAnswered=true;try{this._interaction.setCallType(b.getAttribute("callType"))}catch(d){}this._setParticipantList(c)}else{if(a=="reconnect"){this._interaction.setId(b.getAttribute("NewId"));try{this._interaction.setCallType(b.getAttribute("callType"))}catch(d){}this._interaction.updateUserData(c);this._setParticipantList(c);this._interaction.setExternal(b.getAttribute("external"))}else{if(a=="rejected"){this._callState=PHONE_SESSION_TERMINATED;this._terminateReason="reject"}else{if(a=="unassigned"){this._callState=PHONE_SESSION_TERMINATED;this._terminateReason="unassigned";this._interaction.updateUserData(c)}else{if(a=="postprocess"){this._callState=PHONE_SESSION_POST_PROCESSING}else{if(a=="end-postprocess"||a=="deleted"){this._callState=PHONE_SESSION_TERMINATED;this._interaction.updateUserData(c)}else{if(a=="participant-change"){this._setParticipantList(c)}}}}}}}}}}}this._recentActivity=true};PhoneSession.prototype.updateSession=function(a,b){this.log(LOG_DETAIL,"updateSession: updating interaction: "+this._interaction.getId()+" to be on resource: "+b);this._interaction.updateUserData(a);if(b!=this._interaction.getResourceId()){this._interaction.setResourceId(b);this._resourceChanged=true}this._setParticipantList(a)};PhoneSession.prototype._setParticipantList=function(c){this.log(LOG_DETAIL,"_setParticipantList: setting participant list for interaction: "+this._interaction.getId());this._participantList=new Array;var b=c.getElementsByTagName("InteractionParticipant");var f;for(var e=0;e<b.length;e++){f=new Object;var a=getNodeValue(b[e],"DisplayName").split(",");if(a.length==2){f.displayName=a[1]+", "+a[0]}else{f.displayName=getNodeValue(b[e],"DisplayName")}try{if(f.displayName.toLowerCase()=="anonymous"){f.displayName=CONFIG.ANONYMOUS}}catch(d){}f.phoneNumber=getNodeValue(b[e],"PhoneNumber");f.type=getNodeValue(b[e],"type");f.id=getNodeValue(b[e],"id");this._participantList.push(f)}};PhoneSession.prototype.getParticipantList=function(){return this._participantList};PhoneSession.prototype.resourceChanged=function(){return this._resourceChanged};PhoneSession.prototype.recover=function(c,f){this.log(LOG_DETAIL,"recover: recovering phone session for resource: "+f);this._interaction=new Interaction();this._interaction.initFromXml(c);this._interaction.setResourceId(f);var d=c.getElementsByTagName("CallLeg")[0];var b=d.getAttribute("status");var a=c.getElementsByTagName("Interaction")[0];var e=a.getAttribute("agentInitiated");switch(b){case"ringing":if(e!="true"){this._callState=PHONE_SESSION_OFFERED}break;case"answered":this._callState=PHONE_SESSION_ACTIVE;break;case"hold":this._callState=PHONE_SESSION_HOLD;break;case"mute":this._callState=PHONE_SESSION_MUTE;break;case"talk":this._callState=PHONE_SESSION_ACTIVE;break}this._setParticipantList(c);this._recentActivity=true};PhoneSession.prototype.isMonitoring=function(){return this._monitoring};PhoneSession.prototype.getAni=function(){var a="";if(this._interaction.getUserData("pho")){a=this._interaction.getUserData("pho")}else{if(this._interaction.getAgentDisplayName()){a=this._interaction.getAgentDisplayName()}}if(a.toLowerCase()=="anonymous"){a=CONFIG.ANONYMOUS}return a};PhoneSession.prototype.getCallingName=function(){var a="";if(this._interaction.getUserData("callingName")){a=this._interaction.getUserData("callingName")}if(a.toLowerCase()=="anonymous"){a=CONFIG.ANONYMOUS}return a};PhoneSession.prototype.getRemoteCallingName=function(){var a=this._interaction.getUserData("remoteCallingName")||"";if(a.toLowerCase()=="anonymous"){a=CONFIG.ANONYMOUS}return a};PhoneSession.prototype.getRemoteCallingNumber=function(){return this._interaction.getUserData("remotePhoneNum")||""};PhoneSession.prototype.isActive=function(){if(this._callState==PHONE_SESSION_ACTIVE||this._callState==PHONE_SESSION_HOLD||this._callState==PHONE_SESSION_MUTE||this._callState==PHONE_SESSION_OUTBOUND_DIALER_DESTINATION_ANSWERED){return true}else{return false}};PhoneSession.prototype.setRecordingStatus=function(a){this._recordingStatus=a};PhoneSession.prototype.getRecordingStatus=function(){return this._recordingStatus};Session.prototype.isVOExt=function(d){var c=false,a=null,b=null;if(d){a=new RegExp("[0-9]*-"+d+"$");b=a.exec(this.getAni());if(b&&b.length>0){c=true}}return c};function Resource(b,a){this._base=Base;this._base(b);var b=b||"Resource";this._id=null;this._type=a||null;this._session=null}Resource.prototype=new Base;Resource.prototype.initFromXml=function(a){this._id=a.getAttribute("id")};Resource.prototype.getId=function(){return this._id};Resource.prototype.getType=function(){return this._type};Resource.prototype.getSession=function(){return this._session};function ChatResource(){this._base=Resource;this._base("ChatResource","chat")}ChatResource.prototype=new Resource;ChatResource.prototype.createSession=function(){};ChatResource.prototype.isInternal=function(){return parseInt(this._id.split("-")[this._id.split("-").length-1],10)>=CHAT_INTERNAL_RESOURCE_START_INDEX};function EmailResource(){this._base=Resource;this._base("EmailResource","email")}EmailResource.prototype=new Resource;EmailResource.prototype.createSession=function(){};function PhoneResource(){this._base=Resource;this._base("PhoneResource","phone")}PhoneResource.prototype=new Resource;PhoneResource.prototype.createSession=function(){};function CtlEvent(b,a){this._base=Base;this._base("CtlEvent");this._id=b;this._data=a}CtlEvent.prototype=new Base;CtlEvent.prototype.getId=function(){return this._id};CtlEvent.prototype.getData=function(){return this._data};function EventHandler(a){this._base=Base;this._base("EventHandler");this._eventId=a;this._callbacks=new Array();this._highPriorityCallbacks=new Array()}EventHandler.prototype=new Base;EventHandler.prototype.processEvent=function(b){this.log(LOG_DEBUG,"processEvent: processing for event #"+this._eventId);var a=null;var c=null;if(b.getData()){for(a=0;a<this._highPriorityCallbacks.length;a++){this.log(LOG_DEBUG,"processEvent: processing high-priority callback for event #"+b.getId());c=this._highPriorityCallbacks[a];c(b.getData())}}for(a=0;a<this._callbacks.length;a++){this.log(LOG_DEBUG,"processEvent: processing callback for event #"+b.getId());c=this._callbacks[a];c(b.getData())}};EventHandler.prototype.addCallback=function(a){this.log(LOG_DEBUG,"addCallback: adding a callback for event #"+this._eventId);this._callbacks.push(a)};EventHandler.prototype.addHighPriorityCallback=function(a){this.log(LOG_DEBUG,"addCallback: adding a high-priority callback for event #"+this._eventId);this._highPriorityCallbacks.push(a)};EventHandler.prototype.getEventId=function(){return this._eventId};function Channel(){this._base=Base;this._base("Channel");this._channelId=null;this._mediaType=null;this._name=null;this._description=null}Channel.prototype=new Base;Channel.prototype.getChannelId=function(){return this._channelId};Channel.prototype.getMediaType=function(){return this._mediaType};Channel.prototype.getName=function(){return this._name};Channel.prototype.getDescription=function(){return this._description};function Interaction(){this._base=Base;this._base("Interaction");this._id=null;this._resourceId=null;this._tenant=null;this._userData=null;this._userDataXml=null;this._displayName=null;this._jid=null;this._channelInfo=null;this._status=null;this._supervisorListening=false;this._supervisorWhispering=false;this._timeout=null;this._agentInitiated=null;this._external=null;this._agentId=null;this._agentDisplayName=null;this._instanceDate=new Date();this._transactionCodeList=new Array();this._preRecordingList=new Array();this._callType="";this._transactionId=null;this._isEmailForwarded=false;this._campaignId=-1;this._isCampaign=false;this._queueDirection="in";this._selectedRecordId="";this._selectedRecordType="";this._notes="";this._callBackTime="";this._callBackTimeMillis="";this._queueId="";this._postProcessingTimeout=null;this._isAcceptedOnce=false}Interaction.prototype=new Base;Interaction.prototype.initFromXml=function(e){var h=e.getElementsByTagName("Interaction")[0];if(h){this._id=h.getAttribute("id");this._agentInitiated=(h.getAttribute("agentInitiated")=="true")?true:false;this._status=h.getAttribute("status");this._timeout=h.getAttribute("promptingTimeout");this._external=(h.getAttribute("external")=="true")?true:false;try{if(h.getAttribute("campaignId")!=null){this._campaignId=h.getAttribute("campaignId")}}catch(t){}}var c=e.getElementsByTagName("Resource")[0];if(c){this._resourceId=c.getAttribute("id")}this._supervisorListening=(h.getAttribute("SupervisorListening")=="true")?true:false;this._supervisorWhispering=(h.getAttribute("SupervisorWhispering")=="true")?true:false;try{this._callType=h.getAttribute("callType")}catch(t){this._callType=""}var m=e.getElementsByTagName("UserData")[0];this._userDataXml="";if(m){this._userData={};var u=m.getElementsByTagName("UserParam");for(var s=0;s<u.length;s++){var w=u[s].getAttribute("name");var o=u[s].getAttribute("value");if(o!=null&&o!=""){if(w=="tclSelectedItems"){o=agent.getAgentProfile().translateTransactionItems(o);for(var q=0;q<o.length;q++){if(o[q]!=null){if(q==0){this._userData[w]=o[q];this._userDataXml+='<param name="'+w+'"><![CDATA['+o[q]+"]]></param>"}else{if(q==1){this._userData.lastTclListName=o[q];this._userDataXml+='<param name="lastTclListName"><![CDATA['+o[q]+"]]></param>"}else{if(q==2){this._userData.lastTclCodeDesc=o[q];this._userDataXml+='<param name="lastTclCodeDesc"><![CDATA['+o[q]+"]]></param>"}else{if(q==3){this._userData.lastTclCodeShort=o[q];this._userDataXml+='<param name="lastTclCodeShort"><![CDATA['+o[q]+"]]></param>"}else{if(q==4){this._userData.tclSelectedDescs=o[q];this._userDataXml+='<param name="tclSelectedDescs"><![CDATA['+o[q]+"]]></param>"}}}}}}}}else{this._userData[w]=o;this._userDataXml+='<param name="'+w+'"><![CDATA['+o+"]]></param>"}}}try{if(this._userData.queueDirection!=null&&this._userData.queueDirection=="out"){this._queueDirection="out"}}catch(t){}}var p=e.getElementsByTagName("AgentInfo")[0];if(p){this._agentId=p.getAttribute("id");this._agentDisplayName=getNodeValue(p,"DisplayName");this._jid=p.getAttribute("jid")}this._transactionId=this.getUserData("tok");var d=this.getUserData("tenantSkillName");var n=this.getUserData("med");var a;switch(n){case"C":a="chat";break;case"T":a="phone";break;case"E":a="email";break;case"V":a="vmail";break}var b=e.getElementsByTagName("TenantSkill")[0];var v="";if(b){v=b&&b.getAttribute("label")}else{v=agent.getAgentProfile().getTenant().getTenantLabelForSkill(d,a)}this._queueId=v||this._queueId;this.populateTransactionCodeList(this._queueId);if(a=="phone"||a==null){this._preRecordingList=new Array();if(agent.getAgentProfile().getAgentRecordingsEnable()&&agent.getAgentProfile().getPreRecordingList()){for(var s=0;s<agent.getAgentProfile().getPreRecordingList().length;s++){var l=agent.getAgentProfile().getPreRecordingList()[s];if(l.getIsEnabled()){this._preRecordingList.push(copyPreRecording(l))}}}try{var f=agent.getAgentProfile().getCampaignList();if(f!=null&&f.length>0){for(var s=0;s<f.length;s++){if(this._campaignId==f[s]._campaignId){var g=f[s]._audioFiles;if(g!=null&&g.length>0){for(var r=0;r<g.length;r++){this._preRecordingList.push(copyCampaignAudioFile(g[r]))}}}}}}catch(t){}}};Interaction.prototype.setSelectedRecordId=function(a){this._selectedRecordId=a};Interaction.prototype.getSelectedRecordId=function(){return this._selectedRecordId};Interaction.prototype.setSelectedRecordType=function(a){this._selectedRecordType=a};Interaction.prototype.getSelectedRecordType=function(){return this._selectedRecordType};Interaction.prototype.getId=function(){return this._id};Interaction.prototype.setId=function(a){this._id=a};Interaction.prototype.getResourceId=function(){return this._resourceId};Interaction.prototype.setResourceId=function(a){this._resourceId=a};Interaction.prototype.setNotes=function(a){this._notes=a};Interaction.prototype.getCallBackTime=function(){return this._callBackTime};Interaction.prototype.setCallBackTime=function(a){this._callBackTime=a};Interaction.prototype.setCallBackTimeMillis=function(a){this._callBackTimeMillis=a};Interaction.prototype.getCallBackTimeMillis=function(){return this._callBackTimeMillis};Interaction.prototype.getNotes=function(){return this._notes};Interaction.prototype.getTenant=function(){return this._tenant};Interaction.prototype.getUserData=function(a){if(this._userData){return this._userData[a]||""}else{return""}};Interaction.prototype.getUserDataXml=function(){return this._userDataXml};Interaction.prototype.addUserDataToXml=function(a,b){if(name!=null&&b!=null){this._userDataXml+='<param name="'+a+'"><![CDATA['+b+"]]></param>"}};Interaction.prototype.setUserData=function(b,a){if(!this._userData){this._userData={}}return this._userData[b]=a};Interaction.prototype.getName=function(){if(this.getUserData("nam")){return this.getUserData("nam").replace(/N\/A/g,CONFIG.DEFAULT_NOT_APPLICABLE)}else{if(this._agentDisplayName&&(this._callType==null||this._callType=="")){return this._agentDisplayName.replace(/N\/A/g,CONFIG.DEFAULT_NOT_APPLICABLE)}}return""};Interaction.prototype.getJid=function(){return this._jid};Interaction.prototype.setJid=function(a){this._jid=a};Interaction.prototype.getChannelInfo=function(){return this._channelInfo};Interaction.prototype.getStatus=function(){return this._status};Interaction.prototype.setStatus=function(a){this._status=a};Interaction.prototype.isSupervisorListening=function(){return this._supervisorListening};Interaction.prototype.setSupervisorListening=function(a){this._supervisorListening=a};Interaction.prototype.isSupervisorWhispering=function(){return this._supervisorWhispering};Interaction.prototype.getAgentInitiated=function(){return this._agentInitiated};Interaction.prototype.getTimeout=function(){return this._timeout};Interaction.prototype.external=function(){return this._external};Interaction.prototype.setExternal=function(a){this._external=(a=="true")?true:false};Interaction.prototype.setAgentDisplayName=function(a){this._agentDisplayName=a};Interaction.prototype.getAgentId=function(){return this._agentId};Interaction.prototype.getAgentDisplayName=function(){return this._agentDisplayName};Interaction.prototype.getInstanceDate=function(){return this._instanceDate};Interaction.prototype.getTransactionCodeList=function(){return this._transactionCodeList};Interaction.prototype.getPreRecordingList=function(){return this._preRecordingList};Interaction.prototype.getCallType=function(){return this._callType};Interaction.prototype.getTransactionId=function(){return this._transactionId};Interaction.prototype.getQueueDirection=function(){return this._queueDirection};Interaction.prototype.setCallType=function(a){this._callType=a};Interaction.prototype.setEmailForwarded=function(a){this._isEmailForwarded=a};Interaction.prototype.isEmailForwarded=function(){return this._isEmailForwarded};Interaction.prototype.getCampaignId=function(){return this._campaignId};Interaction.prototype.setCampaignId=function(a){this._campaignId=a};Interaction.prototype.updateUserData=function(e){var g=e.getElementsByTagName("UserData")[0];this._userDataXml="";if(g){var q=this.getUserData("org");var u=this.getUserData("sub");this._userData={};var r=g.getElementsByTagName("UserParam");for(var o=0;o<r.length;o++){var t=r[o].getAttribute("name");var m=r[o].getAttribute("value");if(m!=null&&m!=""){if(t=="tclSelectedItems"){m=agent.getAgentProfile().translateTransactionItems(m);for(var n=0;n<m.length;n++){if(m[n]!=null){if(n==0){this._userData[t]=m[n];this._userDataXml+='<param name="'+t+'"><![CDATA['+m[n]+"]]></param>"}else{if(n==1){this._userData.lastTclListName=m[n];this._userDataXml+='<param name="lastTclListName"><![CDATA['+m[n]+"]]></param>"}else{if(n==2){this._userData.lastTclCodeDesc=m[n];this._userDataXml+='<param name="lastTclCodeDesc"><![CDATA['+m[n]+"]]></param>"}else{if(n==3){this._userData.lastTclCodeShort=m[n];this._userDataXml+='<param name="lastTclCodeShort"><![CDATA['+m[n]+"]]></param>"}else{if(n==4){this._userData.tclSelectedDescs=m[n];this._userDataXml+='<param name="tclSelectedDescs"><![CDATA['+m[n]+"]]></param>"}}}}}}}}else{this._userData[t]=m;this._userDataXml+='<param name="'+t+'"><![CDATA['+m+"]]></param>"}}}if(q!=""){this._userData.org=q;this._userDataXml+='<param name="sub"><![CDATA['+q+"]]></param>"}if(u!=""){this._userData.sub=u;this._userDataXml+='<param name="sub"><![CDATA['+u+"]]></param>"}this._transactionId=this.getUserData("tok")}try{var d=this.getUserData("tenantSkillName");var h=this.getUserData("med");var a;switch(h){case"C":a="chat";break;case"T":a="phone";break;case"E":a="email";break;case"V":a="vmail";break}var f=agent.getAgentProfile();var b=e.getElementsByTagName("TenantSkill")[0];var s="";if(b){s=b&&b.getAttribute("label")}else{s=agent.getAgentProfile().getTenant().getTenantLabelForSkill(d,a)}this._queueId=s||this._queueId;var c=f.getQueueTransactionCodeMap()[s]||[];for(o=0;o<c.length;o++){var l=c[o];if(!isListAlreadyPresent(l.getId(),this._transactionCodeList)){this._transactionCodeList.push(copyTcl(l))}}}catch(p){}this.log(LOG_DETAIL,"updateUserData: updated user data for interaction: "+this._id)};Interaction.prototype.isAnyRequired=function(){try{for(var b=0;b<this.getTransactionCodeList().length;b++){var d=this.getTransactionCodeList()[b];var a=d.getId();if(d.isRequired()){return true}}return false}catch(c){return false}};Interaction.prototype.isAllRequiredSelected=function(){var c=true;try{for(var d=0;d<this.getTransactionCodeList().length;d++){var h=this.getTransactionCodeList()[d];var b=h.getId();if(h.isRequired()){var g=false;for(var a=0;a<h.getAllListItems().length;a++){var f=h.getAllListItems()[a];if(f.isSelected()){g=true}}if(!g){c=false}}}}catch(e){}return c};Interaction.prototype.isAllRequiredSaved=function(){var g=true;try{for(var c=0;c<this.getTransactionCodeList().length;c++){var h=this.getTransactionCodeList()[c];var b=h.getId();if(h.isRequired()){var f=false;for(var a=0;a<h.getAllListItems().length;a++){var e=h.getAllListItems()[a];if(e.isSelectedSaved()){f=true}}if(!f){g=false}}}}catch(d){}return g};Interaction.prototype.getTargetAgentId=function(){var c=this.getJid().split("_")[0],a=agent.getAgentId().split("-")[0],e=agent.getRoster(),d=null;for(var b=0;b<e.length;b++){if(c==e[b].getAgent().getAgentId().split("-")[1]){d=e[b].getAgent().getAgentId();break}}return d};Interaction.prototype.isAgentToAgent=function(){return !!this.getAgentDisplayName()};Interaction.prototype.getQueueId=function(){return this._queueId};Interaction.prototype.setPostProcessingTimeout=function(a){this._postProcessingTimeout=a*1};Interaction.prototype.getPostProcessingTimeout=function(){return this._postProcessingTimeout};Interaction.prototype.populateTransactionCodeList=function(b){var d=agent.getAgentProfile();this._transactionCodeList=[];var a=d.getGroupTransactionCodeList()||[],e=d.getQueueTransactionCodeMap()[b]||[];for(var c=0;c<a.length;c++){this._transactionCodeList.push(copyTcl(a[c]))}for(c=0;c<e.length;c++){this._transactionCodeList.push(copyTcl(e[c]))}};function Notice(){this._base=Base;this._base("Notice");this._from=null;this._timestamp=null;this._type=null;this._persist=null;this._relative=null;this._expiration=null;this._alert=null;this._tenantId=null;this._groupId=null;this._displayName=null;this._body=null;this._viewed=false}Notice.prototype=new Base;Notice.prototype.initFromXml=function(a){this._from=a.getAttribute("from");this._timestamp=a.getAttribute("timestamp");this._groupId=a.getAttribute("id");this._displayName=getNodeValue(a,"DisplayName");var b=a.getElementsByTagName("Broadcast")[0];if(b){this._type=b.getAttribute("type");this._persist=b.getAttribute("persist");this._relative=b.getAttribute("persist");this._expiration=b.getAttribute("expire");this._alert=b.getAttribute("alert")}var d=a.getElementsByTagName("TenantInfo")[0];if(d){this._tenantId=d.getAttribute("id")}var c=a.getElementsByTagName("Group")[0];if(c){this._groupId=c.getAttribute("id")}this._body=getNodeValue(a,"body");if(this._body){this._body=decodeURIComponent(this._body)}};Notice.prototype.getFrom=function(){return this._from};Notice.prototype.getTimestamp=function(){return this._timestamp};Notice.prototype.getType=function(){return this._type};Notice.prototype.isPersistant=function(){return this._persist};Notice.prototype.getExpiration=function(){return this._expiration};Notice.prototype.getAlert=function(){return this._alert};Notice.prototype.getTenantId=function(){return this._tenantId};Notice.prototype.getGroupId=function(){return this._groupId};Notice.prototype.getDisplayName=function(){return this._displayName};Notice.prototype.getBody=function(){return this._body};Notice.prototype.getViewed=function(){return this._viewed};Notice.prototype.setViewed=function(a){this._viewed=a};function TenantSkill(){this._base=Base;this._base("TenantSkill");this._id=null;this._name=null;this._type=null;this._label=null;this._direction=null;this._memberOf=false;this._enabled=false;this._supervisorOf=false;this._interactionsWaiting=0;this._avgWaitingTime=0;this._interactionsInProgress=0;this._loggedInAgentCount=0}TenantSkill.prototype=new Base;TenantSkill.prototype.initFromXml=function(a){this._id=a.getAttribute("guid");this._name=a.getAttribute("name");this._type=a.getAttribute("type");this._label=a.getAttribute("label")};TenantSkill.prototype.initFromObject=function(a){this._id=a.guid;this._name=a.name;this._type=a.type;this._label=a.label;this._enabled=a.enabled;this._memberOf=a.member;this._supervisorOf=a.supervisor;this._direction=a.direction};TenantSkill.prototype.handleStatsUpdate=function(a){this._interactionsWaiting=a[1];this._avgWaitingTime=a[2];this._interactionsInProgress=a[3];this._loggedInAgentCount=a[4]};TenantSkill.prototype.getId=function(){return this._id};TenantSkill.prototype.getName=function(){return this._name};TenantSkill.prototype.getType=function(){return this._type};TenantSkill.prototype.getLabel=function(){return this._label};TenantSkill.prototype.getDirection=function(){return this._direction};TenantSkill.prototype.setDirection=function(a){this._direction=a};TenantSkill.prototype.setMemberOf=function(a){this._memberOf=a};TenantSkill.prototype.isMemberOf=function(){return this._memberOf};TenantSkill.prototype.setEnabled=function(a){this._enabled=a};TenantSkill.prototype.isEnabled=function(){return this._enabled};TenantSkill.prototype.setSupervisorOf=function(a){this._supervisorOf=a};TenantSkill.prototype.isSupervisorOf=function(){return this._supervisorOf};TenantSkill.prototype.getInteractionsWaiting=function(){return this._interactionsWaiting};TenantSkill.prototype.getAvgWaitingTime=function(){return this._avgWaitingTime};TenantSkill.prototype.getInteractionsInProgress=function(){return this._interactionsInProgress};TenantSkill.prototype.getLoggedInAgentCount=function(){return this._loggedInAgentCount};TenantSkill.prototype.setName=function(a){this._name=a};function RosterItem(){this._base=Base;this._base("RosterItem");this._id=null;this._agent=null;this._subscription=null}RosterItem.prototype=new Base;RosterItem.prototype.initFromXml=function(a){this._id=a.getAttribute("jid");this._agent=new Agent();this._agent.initFromXml(a);this._subscription=a.getAttribute("subscription")};RosterItem.prototype.getId=function(){return this._id};RosterItem.prototype.getAgent=function(){return this._agent};RosterItem.prototype.getSubscription=function(){return this._subscription};function Tenant(){this._base=Base;this._base("Tenant");this._tenantId=null;this._state=null;this._displayName=null;this._timezoneOffset=null;this._language=null;this._about=null;this._city=null;this._country=null;this._adminEmail=null;this._adminDisplayName=null;this._skills=[];this._skillsHash={};this._screenPop=null;this._inboundRecordingEnabled=false;this._outboundRecordingEnabled=false;this._directAccessRecordingEnabled=false;this._campaignMonitoringXML=null}Tenant.prototype=new Base;Tenant.prototype._flushSkillList=function(){this._skills=new Array();this._skillsHash={}};Tenant.prototype.initFromXml=function(h){this._tenantId=h.getAttribute("id");this._state=getNodeValue(h,"State");this._displayName=getNodeValueWithParentName(h,"DisplayName","TenantInfo");this._timezoneOffset=getNodeValue(h,"Timezone");this._about=getNodeValue(h,"About");this._city=getNodeValue(h,"City");this._country=getNodeValue(h,"Country");try{this._inboundRecordingEnabled=(getNodeValue(h,"InboundRecordingEnabled")=="enable"?true:false);this._outboundRecordingEnabled=(getNodeValue(h,"OutboundRecordingEnabled")=="enable"?true:false);this._directAccessRecordingEnabled=(getNodeValue(h,"DirectAccessRecordingEnabled")=="enable"?true:false)}catch(n){this.log(LOG_ERROR,"Error occured while parsing the node to fetch recording enabled/disabled.")}this.log(LOG_ERROR,"inboundRecordingEnabled ["+this._inboundRecordingEnabled+"]");this.log(LOG_ERROR,"outboundRecordingEnabled ["+this._outboundRecordingEnabled+"]");this.log(LOG_ERROR,"directAccessRecordingEnabled ["+this._directAccessRecordingEnabled+"]");var a=h.getElementsByTagName("AdminInfo")[0];if(a){this._adminEmail=getNodeValue(a,"Email");this._adminDisplayName=getNodeValue(a,"DisplayName")}var d=h.getElementsByTagName("TenantSkillList")[0];var b=[];if(d){b=d.getElementsByTagName("TenantSkill");if(b.length>0){this._flushSkillList()}for(var f=0;f<b.length;f++){var m=(b[f].getAttribute("type")=="chat")?new ChatTenantSkill():new TenantSkill();m.initFromXml(b[f]);this._skills.push(m);this._skillsHash[m.getId()]=m}}var o=h.getElementsByTagName("SkillList")[0];if(o){var g=o.getElementsByTagName("TenantSkill");if(g.length>0&&b.length==0){this._flushSkillList()}if(g){for(var f=0;f<g.length;f++){var m=this.getTenantSkillById(g[f].getAttribute("guid"));if(!m){m=new TenantSkill();m.initFromXml(g[f]);this._skills.push(m);this._skillsHash[m.getId()]=m}var l=(g[f].getAttribute("enabled")=="true")?true:false;m.setEnabled(l);l=(g[f].getAttribute("member")=="true")?true:false;m.setMemberOf(l);l=(g[f].getAttribute("supervisor")=="true")?true:false;m.setSupervisorOf(l);try{m.setDirection(g[f].getAttribute("direction"))}catch(k){}}}}var c=h.getElementsByTagName("ScreenPopInfo")[0];if(c){this._screenPop=new ScreenPop();this._screenPop.initFromXml(c)}};Tenant.prototype.getTenantId=function(){return this._tenantId};Tenant.prototype.getDisplayName=function(){return this._displayName};Tenant.prototype.getTimezoneOffset=function(){return this._timezoneOffset};Tenant.prototype.getLanguage=function(){return this._language};Tenant.prototype.getAdminEmail=function(){return this._adminEmail};Tenant.prototype.getAbout=function(){return this._about};Tenant.prototype.getCity=function(){return this._city};Tenant.prototype.getCountry=function(){return this._country};Tenant.prototype.isInboundRecordingEnabled=function(){return this._inboundRecordingEnabled};Tenant.prototype.isOutboundRecordingEnabled=function(){return this._outboundRecordingEnabled};Tenant.prototype.isDirectAccessRecordingEnabled=function(){return this._directAccessRecordingEnabled};Tenant.prototype.getTenantSkills=function(b,c){var a=this._skills;if(b){c=c||"asc";if(b=="wait"){var d=function(e){return e.getInteractionsWaiting()}}else{if(b=="busy"){var d=function(e){return e.getInteractionsInProgress()}}else{if(b=="longest"){var d=function(e){return e.getAvgWaitingTime()}}else{var d=function(e){return e.getName().toLowerCase()}}}}a=a.sortBy(d);if(c=="desc"){a.reverse()}}return a};Tenant.prototype.updateTenantInfo=function(c){this.log(LOG_DETAIL,"updateTenantInfo: update tenant info");var f=c.getElementsByTagName("TenantInfo")[0];if(f){try{var e=getNodeValue(c,"InboundRecordingEnabled");if(e=="enable"){this._inboundRecordingEnabled=true}else{if(e=="disable"){this._inboundRecordingEnabled=false}}}catch(d){this.log(LOG_DETAIL,"exception occured while parsing the node : InboundRecordingEnabled")}try{var b=getNodeValue(c,"OutboundRecordingEnabled");if(b=="enable"){this._outboundRecordingEnabled=true}else{if(b=="disable"){this._outboundRecordingEnabled=false}}}catch(d){this.log(LOG_DETAIL,"exception occured while parsing the node : OutboundRecordingEnabled")}try{var a=getNodeValue(c,"DirectAccessRecordingEnabled");if(a=="enable"){this._directAccessRecordingEnabled=true}else{if(a=="disable"){this._directAccessRecordingEnabled=false}}}catch(d){this.log(LOG_DETAIL,"exception occured while parsing the node : DirectAccessRecordingEnabled")}}};Tenant.prototype.updateCampaignInfo=function(b){try{var a=b.getElementsByTagName("campaignStatus")[0];if(a){this._campaignMonitoringXML=b}else{this._campaignMonitoringXML=null}}catch(c){this.log(LOG_DETAIL,"exception occured while parsing the node :campaignStatus");this._campaignMonitoringXML=null}};Tenant.prototype.updateTenantSkill=function(b){this.log(LOG_DETAIL,"updateTenantSkill: update tenant skill name");var c=b.getElementsByTagName("Queue")[0];if(c){var a=this.getTenantSkillById(c.getAttribute("id"));if(a){a.setName(getNodeValue(c,"DisplayName"))}}};Tenant.prototype.updateTenantSkillStats=function(xml){var tenantSkills=xml.getElementsByTagName("TenantSkillStats")[0].textContent;var stats=eval(tenantSkills);var length=stats.length;for(var i=0;i<length;i++){var stat=stats[i];var ts=this.getTenantSkillById(stat[0]);if(ts){ts.handleStatsUpdate(stat)}}};Tenant.prototype.updateTenantSkillStatsFromItstats=function(b){var a=Object.keys(this._skillsHash).reduce(function(d,c){d[c.split("-").slice(-6,-5).join("-")]=c;return d},{});b.forEach(function(c){c[0]=a[c[0]];var d=this.getTenantSkillById(c[0]);if(d){d.handleStatsUpdate(c)}}.bind(this))};Tenant.prototype.getTenantSkillById=function(a){return this._skillsHash[a]};Tenant.prototype.getTenantSkillByLabel=function(a){var b=this._skills.find(function(c){return c.getLabel()==a});return b};Tenant.prototype.getScreenPop=function(){return this._screenPop};Tenant.prototype.getTenantLabelForSkill=function(d,b){if(this._skills!=null){for(var c=0;c<this._skills.length;c++){var a=this._skills[c];if(a.getName()==d&&a.getType()==b){return a.getLabel()}}return null}else{return null}};Tenant.prototype.setSkills=function(b,a){if((b&&b.length)&&a){this._skills=b;this._skillsHash=a}};function Rtapi(a,c,b){var a=a||"Rtapi";this._base=Base;this._base(a);this._proxyUrl=c;this._resource=b;this._proxyPort=80;this._conn=createRtapiConnection()}Rtapi.prototype=new Base;Rtapi.prototype.login=function(c,d,b,a){this.login(c,d,b,a,d,"","")};Rtapi.prototype.login=function(c,f,b,a,e,d){this.login(c,f,this._resource,a,e,d,"")};Rtapi.prototype.login=function(c,g,b,a,e,d,f){this._conn.init(this._proxyUrl,this._proxyPort);if(b){this._conn.refreshAfterLogin(b)}this._conn.login(c,g,this._resource,a,e,d,f)};Rtapi.prototype.ssologin=function(a){this._conn.init(this._proxyUrl,this._proxyPort);if(a.refreshUrl){this._conn.refreshAfterLogin(a.refreshUrl)}this._conn.ssologin(a)};Rtapi.prototype.ssovologin=function(a){this._conn.init(this._proxyUrl,this._proxyPort);if(a.refreshUrl){this._conn.refreshAfterLogin(a.refreshUrl)}this._conn.ssovologin(a)};Rtapi.prototype.resumeLogin=function(){this._conn.resumeLoginProcess()};Rtapi.prototype.addEventHandler=function(a,b){this._conn.addEventHandler(a,b)};Rtapi.prototype.getSessionId=function(){return this._conn.getSessionId()};Rtapi.prototype.stop=function(){return this._conn.close()};var COOKIE_NAME="guest_rtapi";function GuestRtapi(a){this._base=Rtapi;this._base("GuestRtapi",a,"CtlGuest");this._guest=new Guest(this._conn)}GuestRtapi.prototype=new Rtapi;GuestRtapi.prototype.getGuest=function(){return this._guest};GuestRtapi.prototype.destroy=function(){Rtapi.prototype.stop.call(this);this._conn.destroy()};function ScreenPop(){this._base=Base;this._base("ScreenPop");this._enabled=false;this._targetType=null;this._spProperties="";this._spIntProperties="";this._spIntType="";this._account=null;this._url=null;this._eventAccepted=false;this._eventOffered=false;this._eventCompleted=false;this._mediaPhone=false;this._mediaVmail=false;this._mediaChat=false;this._mediaEmail=false;this._autoLogChat=false;this._autoLogPhone=false;this._autoLogVMail=false;this._showToolbar="no";this._width=null;this._height=null;this._top=null;this._left=null;this._isWindowMode=true;this._useSingleWin=true}ScreenPop.prototype=new Base;ScreenPop.prototype.initFromXml=function(xml){this._enabled=(getNodeValue(xml,"Enabled")=="true")?true:false;this._targetType=getNodeValue(xml,"TargetType");this._spProperties=getNodeValue(xml,"SpProperties");this._spIntType=getNodeValue(xml,"SpIntType");this._spIntProperties=getNodeValue(xml,"SpIntProperties");this._account=getNodeValue(xml,"Account");this._url=getNodeValue(xml,"Url");var events=xml.getElementsByTagName("Event");if(events.length>0){for(var i=0;i<events.length;i++){eval("this._event"+events[i].getAttribute("type").capitalize()+" = true;")}}var media=xml.getElementsByTagName("Media");if(media.length>0){for(var i=0;i<media.length;i++){eval("this._media"+media[i].getAttribute("type").capitalize()+" = true;")}}this._showToolbar=(getNodeValue(xml,"ShowToolbar")=="true")?"yes":"no";this._width=getNodeValueWithParentName(xml,"Width","WindowProperties");this._height=getNodeValueWithParentName(xml,"Height","WindowProperties");this._top=getNodeValueWithParentName(xml,"Top","WindowProperties");this._left=getNodeValueWithParentName(xml,"Left","WindowProperties");this.initSpProperties()};ScreenPop.prototype.initSpProperties=function(){if(this._spProperties&&this._spProperties!=""){var c=this._spProperties.split("||");if(c){for(var b=0;b<c.length;b++){var a=c[b].split("==");if(a&&a.length==2){if(a[0]=="enableAutoLogPhone"){if(a[1]=="true"){this._autoLogPhone=true}}else{if(a[0]=="enableAutoLogVmail"){if(a[1]=="true"){this._autoLogVMail=true}}else{if(a[0]=="enableAutoLogChat"){if(a[1]=="true"){this._autoLogChat=true}}else{if(a[0]=="screenpopMode"){this._isWindowMode=(a[1]=="true"||a[1]=="1")}else{if(a[0]=="useSingleWin"){this._useSingleWin=(a[1]=="true"||a[1]=="1")}}}}}}}}}};ScreenPop.prototype.updateWinProperties=function(a){var g={};var l=a.split("||");var b=l.length;for(var e=0;e<b;e++){var c=l[e].split("==");g[c[0]]=c[1]}this._showToolbar=g.toolbar;this._width=g.width;this._height=g.height;this._top=g.top;this._left=g.left;var h=this._spProperties;var k=h.split("||");var f=k.length;var d=new Array();for(var e=0;e<f;e++){var c=k[e].split("==");if(g[c[0]]!=undefined){if(c[0]=="screenpopMode"){if(g[c[0]]=="true"||g[c[0]]=="1"){g[c[0]]=1;this._isWindowMode=true}else{g[c[0]]=0;this._isWindowMode=false}}else{if(c[0]=="useSingleWin"){this._useSingleWin=(g[c[0]]=="true"||g[c[0]]=="1")}}d.push(c[0]+"=="+g[c[0]])}else{d.push(k[e])}}this._spProperties=d.join("||")};ScreenPop.prototype.isEnabled=function(){return this._enabled};ScreenPop.prototype.getTargetType=function(){return this._targetType};ScreenPop.prototype.getSpProperties=function(){return this._spProperties};ScreenPop.prototype.getSpIntProperties=function(){return this._spIntProperties};ScreenPop.prototype.getSpIntType=function(){return this._spIntType};ScreenPop.prototype.getAccount=function(){return this._account};ScreenPop.prototype.isLocalCRM=function(){if(!this.isEnabled()||this.getTargetType()=="88"){return true}return false};ScreenPop.prototype.isLocalEnabled=function(){if(this.isEnabled()&&this.getTargetType()=="88"){return true}return false};ScreenPop.prototype.isChatAutoLogEnabledForLocal=function(){if(this.isLocalEnabled()&&this._autoLogChat){return true}return false};ScreenPop.prototype.getUrl=function(b){var a=this._url;if(b!=null&&this._url!=null&&b!=""){if(this._url.match(/\?$/)){a=this._url+b}else{if(this._url.match(/\?..*$/)){a=this._url+"&"+b}else{if(this._url.match(/^[^?]*$/)){a=this._url+"?"+b}else{a=this._url+"&"+b}}}}return a};ScreenPop.prototype.onOffered=function(){return this._eventOffered};ScreenPop.prototype.onAccepted=function(){return this._eventAccepted};ScreenPop.prototype.onCompleted=function(){return this._eventCompleted};ScreenPop.prototype.onPhone=function(){return this._mediaPhone};ScreenPop.prototype.onVmail=function(){return this._mediaVmail};ScreenPop.prototype.onChat=function(){return this._mediaChat};ScreenPop.prototype.onEmail=function(){return this._mediaEmail};ScreenPop.prototype.getWindowProperties=function(){return"scrollbars=yes,resizable=yes,width="+this._width+",height="+this._height+",top="+this._top+",left="+this._left+",toolbar="+this._showToolbar};function ChatTenantSkill(){this._base=TenantSkill;this._base("ChatTenantSkill");this._forwardToEmailEnabled=false;this._forwardToEmailTimeout=null;this._forwardToEmailPrompt=null;this._forwardToEmailSent=null;this._forwardToEmailChannel=null}ChatTenantSkill.prototype=new TenantSkill;TenantSkill.prototype.initFromXml=function(a){this._id=a.getAttribute("guid");this._name=a.getAttribute("name");this._type=a.getAttribute("type");this._label=a.getAttribute("label");this._forwardToEmailEnabled=(a.getAttribute("chatFwdToEmailEnabled")=="true")?true:false;this._forwardToEmailTimeout=a.getAttribute("chatFwdToEmailTimeout");this._forwardToEmailPrompt=a.getAttribute("chatFwdToEmailPromptMsg");this._forwardToEmailSent=a.getAttribute("chatFwdToEmailSentMsg");this._forwardToEmailChannel=a.getAttribute("chatFwdToEmailChannel")};TenantSkill.prototype.forwardToEmailEnabled=function(){return this._forwardToEmailEnabled};TenantSkill.prototype.getForwardToEmailTimeout=function(){return this._forwardToEmailTimeout};TenantSkill.prototype.getForwardToEmailPrompt=function(){return this._forwardToEmailPrompt};TenantSkill.prototype.getForwardToEmailSent=function(){return this._forwardToEmailSent};TenantSkill.prototype.getForwardToEmailChannel=function(){return this._forwardToEmailChannel};function AgentSCL(){this._base=Base;this._base("AgentSCL");this._listId=null;this._listPrimaryLang=null;this._autoSort=false;this._listName=null;this._listDescription=null;this._listAssignmentType=null;this._assignmentTypeGuiId=null;this._items=new Array()}AgentSCL.prototype=new Base;AgentSCL.prototype.initFromXml=function(a){try{this._listId=a.getAttribute("id");this._autoSort=a.getAttribute("auto_sort");this._listPrimaryLang=getNodeValue(a,"Primary_lang");this._listName=getNodeValue(a,"Name");Logger.log("rtapi",LOG_DEBUG,"SCLList Name : "+this._listName);this._listDescription=getNodeValue(a,"Description");var f=a.getElementsByTagName("Assignment")[0];this._listAssignmentType=f.getAttribute("type");this._assignmentTypeGuiId=f.getAttribute("id");var e=a.getElementsByTagName("Item");if(e.length>0){for(var c=0;c<e.length;c++){Logger.log("rtapi",LOG_DEBUG,"Started parsing SCLList Item");var d=new SCLItem();d.initFromXml(e[c]);this._items.push(d)}}}catch(b){Logger.log("rtapi",LOG_ERROR,"Exception while parsing SCLLists. message["+b.message+"]")}};AgentSCL.prototype.getId=function(){return this._listId};AgentSCL.prototype.getPrimaryLanguage=function(){return this._listPrimaryLang};AgentSCL.prototype.isAutoSort=function(){return this._autoSort};AgentSCL.prototype.getName=function(){return this._listName};AgentSCL.prototype.getDescription=function(){return this._listDescription};AgentSCL.prototype.getAssignmentType=function(){return this._listAssignmentType};AgentSCL.prototype.getAssignmentTypeId=function(){return this._assignmentTypeGuiId};AgentSCL.prototype.getAllListItems=function(){return this._items};function AgentTCL(){this._base=Base;this._base("AgentTCL");this._listId=null;this._required=false;this._requiredBeforeOutbound=false;this._multiChoiceAllowed=false;this._autoSort=false;this._listPrimaryLang=null;this._listName=null;this._listDescription=null;this._listAssignmentType=null;this._isDefault=false;this._assignmentsId=new Array();this._items=new Array()}AgentTCL.prototype=new Base;AgentTCL.prototype.initFromObject=function(c){var b=null,a=null,e=null;this._listId=c.id;this._required=c.required;this._requiredBeforeOutbound=c.req_before_outbound;this._multiChoiceAllowed=c.multi_choice;this._autoSort=c.auto_sort;this._isDefault=c.is_agent_default;this._listPrimaryLang=c.primary_lang;this._listName=c.name;this._listDescription=c.description;b=c.assignments||{};this._assignmentsId=b.list||[];this._listAssignmentType=b.type;a=c.items||[];for(var d=0;d<a.length;d++){e=new TCLItem();e.initFromObject(a[d]);this._items.push(e)}};AgentTCL.prototype.getId=function(){return this._listId};AgentTCL.prototype.getPrimaryLanguage=function(){return this._listPrimaryLang};AgentTCL.prototype.isAutoSort=function(){return this._autoSort};AgentTCL.prototype.isRequired=function(){return this._required};AgentTCL.prototype.isrequiredBeforeOutbound=function(){return this._requiredBeforeOutbound};AgentTCL.prototype.isMultiChoice=function(){return this._multiChoiceAllowed};AgentTCL.prototype.getName=function(){return this._listName};AgentTCL.prototype.getDescription=function(){return this._listDescription};AgentTCL.prototype.getAssignmentType=function(){return this._listAssignmentType};AgentTCL.prototype.isDefaultRBO=function(){return this._isDefault};AgentTCL.prototype.getAssignmentsId=function(){return this._assignmentsId};AgentTCL.prototype.getAllListItems=function(){return this._items};function SCLItem(){this._base=Base;this._base("SCLItem");this._itemId=null;this._langId=null;this._reportText=null;this._menuText=null;this._shortcodeText=null;this._associatedStates=null}SCLItem.prototype=new Base;SCLItem.prototype.initFromXml=function(b){try{this._itemId=b.getAttribute("id");this._langId=b.getAttribute("lang_id");this._menuText=getNodeValueWithParentName(b,"Menu_text","Item");Logger.log("rtapi",LOG_DEBUG,"SCLItem MenuText : "+this._menuText);this._reportText=getNodeValueWithParentName(b,"Report_text","Item");Logger.log("rtapi",LOG_DEBUG,"SCLItem ReportText : "+this._reportText);var f=getNodeValueWithParentName(b,"ShortCode_text","Item");if(f){this._shortcodeText=f}else{this._shortcodeText=""}Logger.log("rtapi",LOG_DEBUG,"SCLItem ShortCodeText : "+this._shortcodeText);var a=b.getElementsByTagName("States")[0];this._associatedStates=new Array();for(var d=0;d<a.childNodes.length;d++){var e=a.childNodes[d].getAttribute("name");Logger.log("rtapi",LOG_DEBUG,"Got State["+e+"]");this._associatedStates.push(e)}}catch(c){Logger.log("rtapi",LOG_ERROR,"Exception while parsing SCL Item. message["+c.message+"]")}};SCLItem.prototype.getId=function(){return this._itemId};SCLItem.prototype.getLanguageId=function(){return this._langId};SCLItem.prototype.getReportText=function(){return this._reportText};SCLItem.prototype.getMenuText=function(){return this._menuText};SCLItem.prototype.getShortCodeText=function(){return this._shortcodeText};SCLItem.prototype.getStates=function(){return this._associatedStates};SCLItem.prototype.isStateAssociated=function(b){if(this._associatedStates.length>0){for(var a=0;a<this._associatedStates.length;a++){if(b==this._associatedStates[a]){return true}}return false}else{return false}};function TCLItem(){this._base=Base;this._base("TCLItem");this._itemId=null;this._langId=null;this._reportText=null;this._menuText=null;this._shortcodeText=null;this._callingLineIdentifier=null;this._queueObjId="";this._dispositionCode="";this._isSelected=false;this._isSelectedSaved=false}TCLItem.prototype=new Base;TCLItem.prototype.initFromObject=function(a){this._itemId=a.id;if(this._itemId==="-1"){this._isSelected=true;this._isSelectedSaved=true}this._langId=a.lang_id;this._callingLineIdentifier=a.call_line_id;Logger.log("rtapi",LOG_DEBUG,"TCLItem CLID : "+this._callingLineIdentifier);this._dispositionCode=a.disposition_code;this._queueObjId=a.queue_obj_id;if(this._itemId==="-1"){this._menuText=CONFIG.TCL_OPTIONS.none}else{this._menuText=a.menu_text}Logger.log("rtapi",LOG_DEBUG,"TCLItem MenuText : "+this._menuText);this._reportText=a.report_text;this._shortcodeText=a.shortCode_text||""};TCLItem.prototype.getId=function(){return this._itemId};TCLItem.prototype.getLanguageId=function(){return this._langId};TCLItem.prototype.getReportText=function(){return this._reportText};TCLItem.prototype.getMenuText=function(){return this._menuText};TCLItem.prototype.getShortCodeText=function(){return this._shortcodeText};TCLItem.prototype.getCallLineId=function(){return this._callingLineIdentifier};TCLItem.prototype.setCallLineId=function(a){this._callingLineIdentifier=a};TCLItem.prototype.getDispositionCode=function(){return this._dispositionCode};TCLItem.prototype.getQueueObjId=function(){return this._queueObjId};TCLItem.prototype.isSelected=function(){return this._isSelected};TCLItem.prototype.isSelectedSaved=function(){return this._isSelectedSaved};